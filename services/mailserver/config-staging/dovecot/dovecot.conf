# ====================================
# Staging環境用 Dovecot 設定
# ====================================
#
# 【変更点】
# - LMTPポート: 2525 → 3525（staging専用）
# - IMAPSポート: 993 → 3993（staging専用）
# - POP3Sポート: 995 → 3995（staging専用）
# - データベース接続: staging MariaDB（read-only）

# プロトコル設定
protocols = imap pop3 lmtp

# ログ設定
log_path = /var/log/dovecot.log
info_log_path = /var/log/dovecot-info.log
debug_log_path = /var/log/dovecot-debug.log
log_timestamp = "%Y-%m-%d %H:%M:%S "
auth_verbose = yes
auth_debug = yes
auth_debug_passwords = no
mail_debug = no
verbose_ssl = yes

# メールディレクトリ設定
mail_location = maildir:/var/mail/vhosts/%d/%n

# SSL/TLS設定
ssl = required
ssl_cert = </var/lib/tailscale/certs/tls.crt
ssl_key = </var/lib/tailscale/certs/tls.key
ssl_min_protocol = TLSv1.2
# 最新メールクライアント対応の暗号化スイート (TLS 1.2/1.3互換)
ssl_cipher_list = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
ssl_prefer_server_ciphers = yes

# 認証設定
auth_mechanisms = plain login

# ファイルベース認証（既存ユーザー用）
passdb {
    driver = passwd-file
    args = scheme=SHA512-CRYPT username_format=%u /etc/dovecot/users
}

userdb {
    driver = static
    args = uid=1000 gid=1000 home=/var/mail/vhosts/%d/%n
}

# SQL認証（全ユーザー） - staging環境（read-only DB）
!include /etc/dovecot/custom/auth-sql.conf.ext

# LMTP設定（Fargate → Dellへの転送受信）
# staging専用ポート: 3525
service lmtp {
    inet_listener lmtp {
        port = 2525
        address = *
    }
}

# IMAP設定
# staging専用ポート: IMAPS 3993
service imap-login {
    inet_listener imap {
        port = 143
    }
    inet_listener imaps {
        port = 3993
        ssl = yes
    }
}

# POP3設定
# staging専用ポート: POP3S 3995
service pop3-login {
    inet_listener pop3 {
        port = 110
    }
    inet_listener pop3s {
        port = 3995
        ssl = yes
    }
}

# Postfix SASL認証 (submission 用)
service auth {
    unix_listener /var/spool/postfix/private/auth {
        mode = 0666
    }
}

# プラグイン設定
protocol lmtp {
    mail_plugins = $mail_plugins sieve
}

protocol imap {
    mail_plugins = $mail_plugins imap_sieve
}
