# Staging環境用 Docker Compose オーバーライド設定
#
# 【重要】使用方法: 必ず -p staging でプロジェクト名を分離してください
#   docker compose -p staging -f docker-compose.yml -f docker-compose.staging.yml --env-file .env.staging up -d
#
# プロジェクト名分離により、本番環境と以下が自動的に分離されます:
# - ネットワーク名: mailserver_network → staging_mailserver_network
# - ボリューム名: postfix_spool → staging_postfix_spool
# - コンテナ名プレフィックス: mailserver- → staging-mailserver-
#
# 主な変更点:
# - ネットワーク: 172.21.0.0/24 (本番は 172.20.0.0/24)
# - ポート: 3xxx番台 (本番環境との分離)
# - データディレクトリ: data-staging/ (本番は data/)
# - リソース制限: 本番より削減（本番環境への影響を最小化）
# - セキュリティ: 外部メール送信無効化（3層防御）

networks:
  mailserver_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

volumes:
  postfix_spool:
    driver: local
  mail_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data-staging/mail
  db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data-staging/db
  rspamd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data-staging/rspamd
  clamav_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data-staging/clamav

services:
  mariadb:
    container_name: mailserver-staging-mariadb
    hostname: mariadb-staging
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.60
    ports: !override []  # YAMLタグでベースファイルのports配列を完全に上書き
    # ポートは公開しない（内部ネットワークのみ）
    # Tailscale経由でアクセス: 172.21.0.60:3306
    volumes:
      - db_data:/var/lib/mysql
      - ./config-staging/mariadb:/etc/mysql/conf.d:ro
    command:
      - --read-only=ON
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 本番: 1.0 → staging: 0.5
          memory: 1g        # 本番: 2g → staging: 1g

  postfix:
    image: boky/postfix:latest
    container_name: mailserver-staging-postfix
    hostname: mail-staging.kuma8088.com
    restart: always
    entrypoint: [ "/opt/mailserver/scripts/postfix-entrypoint.sh" ]
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.20
    ports: !override []  # YAMLタグでベースファイルのports配列を完全に上書き
    # Postfix は内部ネットワークのみで動作（ポート公開なし）
    environment:
      - HOSTNAME=mail-staging.kuma8088.com
      - DOMAIN=${MAIL_DOMAIN}
      - TZ=${TZ}
      - MAIL_DOMAIN=${MAIL_DOMAIN}
      - MAIL_HOSTNAME=${MAIL_HOSTNAME}
      - MAIL_ADDITIONAL_DOMAINS=${MAIL_ADDITIONAL_DOMAINS}
      - POSTFIX_TLS_CERT_FILE=${POSTFIX_TLS_CERT_FILE}
      - POSTFIX_TLS_KEY_FILE=${POSTFIX_TLS_KEY_FILE}
      - POSTFIX_RELAYHOST=[127.0.0.1]:9999  # 無効なrelayhostでメール送信を防止
      - POSTFIX_MESSAGE_SIZE_LIMIT=${POSTFIX_MESSAGE_SIZE_LIMIT}
    volumes:
      - ./config-staging/postfix:/etc/postfix/custom
      - mail_data:/var/mail/vhosts
      - postfix_spool:/var/spool/postfix
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs-staging/postfix:/var/log
      - ./scripts:/opt/mailserver/scripts:ro
    depends_on:
      - rspamd
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 本番: 1.0 → staging: 0.5
          memory: 1g        # 本番: 2g → staging: 1g
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "587" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dovecot:
    image: dovecot/dovecot:2.3.21
    container_name: mailserver-staging-dovecot
    hostname: dovecot-staging
    restart: always
    command: ["/usr/sbin/dovecot", "-F", "-c", "/etc/dovecot/custom/dovecot.conf"]
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.30
    ports: !override
      - "3525:2525"  # EC2 Staging からの LMTP 用に限定公開（本番は2525:2525）
    # 注意: EC2 Staging Postfix → Dell Staging Dovecot: lmtp:[100.110.222.53]:3525
    # LMTPポート（2525）のみホストの3525ポートに公開
    # 他のポート（IMAPS 993, POP3S 995等）は内部ネットワークのみ
    environment:
      - TZ=${TZ}
    volumes:
      - ./config-staging/dovecot:/etc/dovecot/custom
      - ./config-staging/dovecot/users:/etc/dovecot/users:ro
      - mail_data:/var/mail/vhosts
      - postfix_spool:/var/spool/postfix
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs-staging/dovecot:/var/log
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 本番: 1.0 → staging: 0.5
          memory: 1g        # 本番: 2g → staging: 1g
    healthcheck:
      test: [ "CMD-SHELL", "doveadm -c /etc/dovecot/dovecot.conf service status imap >/dev/null 2>&1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  rspamd:
    container_name: mailserver-staging-rspamd
    hostname: rspamd-staging
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.70
    volumes:
      - rspamd_data:/var/lib/rspamd
      - ./config-staging/rspamd:/etc/rspamd/override.d
      - ./logs-staging/rspamd:/var/log/rspamd
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 本番: 1.0 → staging: 0.5
          memory: 1g        # 本番: 2g → staging: 1g

  clamav:
    container_name: mailserver-staging-clamav
    hostname: clamav-staging
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.80
    volumes:
      - clamav_data:/var/lib/clamav
      - ./config-staging/clamav/clamd.conf:/etc/clamav/clamd.conf:ro
      - ./config-staging/clamav/freshclam.conf:/etc/clamav/freshclam.conf:ro
      - ./logs-staging/clamav:/var/log/clamav
    deploy:
      resources:
        limits:
          cpus: '0.5'      # 本番: 1.0 → staging: 0.5
          memory: 1g        # 本番: 2g → staging: 1g

  roundcube:
    container_name: mailserver-staging-roundcube
    hostname: roundcube-staging
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.40
    ports: !override []  # YAMLタグでベースファイルのports配列を完全に上書き
    environment:
      - ROUNDCUBEMAIL_DB_HOST=mariadb-staging
      - ROUNDCUBEMAIL_DEFAULT_HOST=ssl://dell-workstation.tail67811d.ts.net
      - ROUNDCUBEMAIL_DEFAULT_PORT=3993   # staging IMAPS port
      - ROUNDCUBEMAIL_SMTP_SERVER=tls://dell-workstation.tail67811d.ts.net
      - ROUNDCUBEMAIL_SMTP_PORT=3587      # staging submission port
    volumes:
      - ./config-staging/roundcube:/var/roundcube/config
      - ./logs-staging/roundcube:/var/log/roundcube
      - ./config-staging/roundcube/smtp_noauth.inc.php:/var/www/html/config/smtp_noauth.inc.php:ro

  usermgmt:
    container_name: mailserver-staging-usermgmt
    hostname: usermgmt-staging
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.90
    environment:
      - DB_HOST=172.21.0.60  # staging MariaDB IP
      - FLASK_ENV=staging
    volumes:
      - ./usermgmt:/app
      - ./logs-staging/usermgmt:/var/log/usermgmt
    deploy:
      resources:
        limits:
          cpus: '0.25'     # 本番: 0.5 → staging: 0.25
          memory: 256M      # 本番: 512M → staging: 256M

  nginx:
    image: nginx:1.26-alpine
    container_name: mailserver-staging-nginx
    hostname: nginx-staging
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.21.0.10
    ports: !override []  # YAMLタグでベースファイルのports配列を完全に上書き
    # ポートは公開しない（内部ネットワークのみ）
    # Tailscale経由でアクセス: 172.21.0.10:80 (HTTP), 172.21.0.10:443 (HTTPS)
    environment:
      - TZ=${TZ}
      - MAIL_HOSTNAME=mail-staging.kuma8088.com
      - TLS_CERT_FILE=${POSTFIX_TLS_CERT_FILE:-/var/lib/tailscale/certs/tls.crt}
      - TLS_KEY_FILE=${POSTFIX_TLS_KEY_FILE:-/var/lib/tailscale/certs/tls.key}
      - NGINX_DOLLAR=$$
    volumes:
      - ./config-staging/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config-staging/nginx/templates:/etc/nginx/templates:ro
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs-staging/nginx:/var/log/nginx
    depends_on:
      - roundcube
      - usermgmt
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
