# MANUAL_TEST_P3-T8: 実ユーザー検証手順書

## テスト目的
既存メールユーザー (test@kuma8088.com) を使用して、認証システムの実動作を検証する。

## 前提条件
- [ ] Mailserver (EC2 MX Gateway) が稼働中
- [ ] usermgmt データベースに test@kuma8088.com ユーザーが存在
- [ ] Flask アプリケーションが起動可能
- [ ] ネットワーク接続が確立されている

---

## テストフェーズ

### Phase 1: データベース確認

#### 1.1 ユーザー存在確認
```bash
# Dell WorkStation から MariaDB に接続
mysql -h 172.20.0.60 -u usermgmt -p mailserver_usermgmt

# test@kuma8088.com ユーザーを確認
SELECT email, enabled, quota, maildir FROM users WHERE email = 'test@kuma8088.com';
```

**期待される結果**:
```
+-------------------+---------+-------+-------------------------------------+
| email             | enabled | quota | maildir                             |
+-------------------+---------+-------+-------------------------------------+
| test@kuma8088.com |       1 |  1024 | /var/mail/vmail/kuma8088.com/test/ |
+-------------------+---------+-------+-------------------------------------+
```

#### 1.2 パスワードハッシュ確認
```sql
SELECT email, password_hash FROM users WHERE email = 'test@kuma8088.com';
```

**期待される結果**:
- パスワードハッシュが SHA512-CRYPT 形式 (`{SHA512-CRYPT}$6$...`) で存在する

---

### Phase 2: Flask アプリケーション起動

#### 2.1 開発サーバー起動
```bash
cd /opt/onprem-infra-system/project-root-infra/services/mailserver/usermgmt

# 環境変数設定（必要に応じて）
export USERMGMT_DB_PASSWORD='SecureMailUserMgmt2024!'
export FLASK_APP=app
export FLASK_ENV=development

# Flask 開発サーバー起動
python -m flask run --host=0.0.0.0 --port=5000
```

**期待される結果**:
```
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://0.0.0.0:5000
```

---

### Phase 3: ログイン機能検証

#### 3.1 ログイン画面アクセス
**手順**:
1. ブラウザで `http://<WorkStation-IP>:5000/auth/login` にアクセス
2. Bootstrap 5 デザインのログイン画面が表示されることを確認

**期待される結果**:
- [ ] ページタイトル: "ログイン - メールユーザー管理"
- [ ] グラデーション背景が表示される
- [ ] ログインカードが中央に配置されている
- [ ] メールアドレスとパスワードのフィールドがある
- [ ] "ログイン" ボタンがある

#### 3.2 ログイン失敗テスト (誤パスワード)
**手順**:
1. メールアドレス: `test@kuma8088.com`
2. パスワード: `wrong_password`
3. "ログイン" ボタンをクリック

**期待される結果**:
- [ ] ログイン画面に留まる
- [ ] 赤いアラートボックスに「メールアドレスまたはパスワードが正しくありません。」と表示される
- [ ] セッションは作成されない

#### 3.3 ログイン成功テスト
**手順**:
1. メールアドレス: `test@kuma8088.com`
2. パスワード: (実際のパスワード)
3. "ログイン" ボタンをクリック

**期待される結果**:
- [ ] ダッシュボードページ (`/`) にリダイレクトされる
- [ ] "ダッシュボード" という見出しが表示される
- [ ] "メールユーザー管理システムへようこそ。" というメッセージが表示される
- [ ] ナビゲーションバーに "ログアウト" ボタンがある

---

### Phase 4: セッション管理検証

#### 4.1 保護ルートアクセス
**手順**:
1. ログイン後、ブラウザで直接 `http://<WorkStation-IP>:5000/` にアクセス

**期待される結果**:
- [ ] ログインプロンプトなしでダッシュボードが表示される（セッションが保持されている）

#### 4.2 セッション Cookie 確認
**手順**:
1. ブラウザの開発者ツールを開く (F12)
2. Application → Cookies → `http://<WorkStation-IP>:5000` を確認

**期待される結果**:
- [ ] `session` Cookie が存在する
- [ ] `HttpOnly` フラグが設定されている
- [ ] `Secure` フラグが設定されている（HTTPS の場合）
- [ ] `SameSite` が `Strict` に設定されている

---

### Phase 5: ログアウト機能検証

#### 5.1 ログアウト実行
**手順**:
1. ダッシュボードページで "ログアウト" ボタンをクリック

**期待される結果**:
- [ ] ログイン画面 (`/auth/login`) にリダイレクトされる
- [ ] 青いアラートボックスに「ログアウトしました。」と表示される

#### 5.2 ログアウト後の保護ルートアクセス
**手順**:
1. ログアウト後、ブラウザで `http://<WorkStation-IP>:5000/` にアクセス

**期待される結果**:
- [ ] ログイン画面 (`/auth/login?next=%2F`) にリダイレクトされる
- [ ] ダッシュボードにアクセスできない

---

### Phase 6: レスポンシブデザイン検証

#### 6.1 モバイル表示
**手順**:
1. ブラウザの開発者ツールでモバイルビューに切り替え (375x667)
2. ログイン画面を確認

**期待される結果**:
- [ ] ログインカードがモバイル画面に適切に収まる
- [ ] フォームフィールドが使いやすいサイズで表示される
- [ ] ボタンがタップしやすいサイズである

#### 6.2 タブレット表示
**手順**:
1. タブレットビューに切り替え (768x1024)
2. ログイン画面を確認

**期待される結果**:
- [ ] ログインカードが適切な幅で表示される
- [ ] レイアウトが崩れていない

#### 6.3 デスクトップ表示
**手順**:
1. デスクトップビューに切り替え (1920x1080)
2. ログイン画面を確認

**期待される結果**:
- [ ] ログインカードが画面中央に配置されている
- [ ] 背景グラデーションが全画面に表示される

---

## 検証チェックリスト

### データベース検証
- [ ] test@kuma8088.com ユーザーが存在する
- [ ] パスワードハッシュが SHA512-CRYPT 形式である
- [ ] enabled = 1 である

### 認証機能検証
- [ ] ログイン画面が正しく表示される
- [ ] 誤パスワードでログイン失敗する
- [ ] 正しいパスワードでログイン成功する
- [ ] ログイン後、ダッシュボードにリダイレクトされる

### セッション管理検証
- [ ] ログイン後、セッションが保持される
- [ ] Cookie に HttpOnly, Secure, SameSite=Strict が設定されている
- [ ] ログアウトでセッションが破棄される
- [ ] ログアウト後、保護ルートにアクセスできない

### UI/UX 検証
- [ ] Bootstrap 5 デザインが適用されている
- [ ] エラーメッセージが適切に表示される
- [ ] レスポンシブデザインが機能している

---

## 問題発生時の対応

### ログイン失敗（パスワード不一致）
**症状**: 正しいパスワードを入力してもログインできない

**原因調査**:
```python
# パスワード検証テスト
python -c "
from app.services.password import verify_password, hash_password

# 既存のハッシュ（データベースから取得）
existing_hash = '{SHA512-CRYPT}$6$...'

# テストパスワード
test_password = 'your_password_here'

# 検証
result = verify_password(test_password, existing_hash)
print(f'Verification result: {result}')
"
```

**解決策**:
- パスワードハッシュが SHA512-CRYPT 形式か確認
- ハッシュアルゴリズムが passlib の SHA512-CRYPT と互換性があるか確認
- 必要に応じてパスワードを再設定

### データベース接続エラー
**症状**: "Can't connect to MySQL server"

**原因調査**:
```bash
# ネットワーク疎通確認
ping 172.20.0.60

# MariaDB ポート確認
nc -zv 172.20.0.60 3306

# 認証情報確認
mysql -h 172.20.0.60 -u usermgmt -p
```

**解決策**:
- データベースサーバーの稼働状況を確認
- ファイアウォール設定を確認
- 認証情報（パスワード）を確認

### テンプレートが見つからないエラー
**症状**: "TemplateNotFound: login.html"

**解決策**:
```bash
# テンプレートディレクトリの確認
ls -la templates/

# Flask アプリケーションの再起動
# app/__init__.py で template_folder が正しく設定されているか確認
```

---

## 検証完了基準
- すべてのチェックリスト項目が ✓ である
- 問題が発生した場合、対応済みまたは Issue に記録されている
- 実ユーザーでの認証フローが正常に動作している

---

## 次のステップ
検証完了後:
1. DEVELOPMENT.md を更新して P3-T8 を完了とマーク
2. Phase 4 (テンプレート実装) の計画開始
3. 必要に応じて本番デプロイメントの準備
