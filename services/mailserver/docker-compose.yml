# version: '3.8'

networks:
  mailserver_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  mail_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/mail
  db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/db
  rspamd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/rspamd
  clamav_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/clamav

services:
  # MariaDB データベース
  mariadb:
    image: mariadb:10.11.7
    container_name: mailserver-mariadb
    hostname: mariadb
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.60
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - TZ=${TZ}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Postfix MTA (SendGrid Relay専用)
  postfix:
    image: boky/postfix:latest
    container_name: mailserver-postfix
    hostname: ${MAIL_HOSTNAME}
    restart: always
    entrypoint: [ "/opt/mailserver/scripts/postfix-entrypoint.sh" ]
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.20
    ports:
      - "587:587"
    environment:
      - HOSTNAME=${MAIL_HOSTNAME}
      - DOMAIN=${MAIL_DOMAIN}
      - TZ=${TZ}
      - MAIL_DOMAIN=${MAIL_DOMAIN}
      - MAIL_HOSTNAME=${MAIL_HOSTNAME}
      - MAIL_ADDITIONAL_DOMAINS=${MAIL_ADDITIONAL_DOMAINS}
      - POSTFIX_TLS_CERT_FILE=${POSTFIX_TLS_CERT_FILE}
      - POSTFIX_TLS_KEY_FILE=${POSTFIX_TLS_KEY_FILE}
      - POSTFIX_RELAYHOST=${POSTFIX_RELAYHOST}
      - POSTFIX_MESSAGE_SIZE_LIMIT=${POSTFIX_MESSAGE_SIZE_LIMIT}
    volumes:
      - ./config/postfix:/etc/postfix/custom
      - mail_data:/var/mail/vhosts
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs/postfix:/var/log
      - ./scripts:/opt/mailserver/scripts:ro
    depends_on:
      - rspamd
    deploy:
      resources:
        limits:
          cpus: '${POSTFIX_CPU_LIMIT}'
          memory: '${POSTFIX_MEM_LIMIT}'
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "587" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Dovecot MDA (LMTP + IMAP/POP3)
  dovecot:
    image: dovecot/dovecot:2.3.21
    container_name: mailserver-dovecot
    hostname: dovecot
    restart: always
    command: ["/usr/sbin/dovecot", "-F", "-c", "/etc/dovecot/custom/dovecot.conf"]
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.30
    ports:
      - "2525:2525" # LMTP (Fargate → Dell)
      - "993:993" # IMAPS
      - "995:995" # POP3S
    environment:
      - TZ=${TZ}
    volumes:
      - ./config/dovecot:/etc/dovecot/custom
      - ./config/dovecot/users:/etc/dovecot/users:ro
      - mail_data:/var/mail/vhosts
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs/dovecot:/var/log
    deploy:
      resources:
        limits:
          cpus: '${DOVECOT_CPU_LIMIT}'
          memory: ${DOVECOT_MEM_LIMIT}
    healthcheck:
      test: [ "CMD-SHELL", "doveadm -c /etc/dovecot/dovecot.conf service status imap >/dev/null 2>&1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Rspamd スパムフィルタ
  rspamd:
    image: rspamd/rspamd:3.8
    container_name: mailserver-rspamd
    hostname: rspamd
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.70
    volumes:
      - rspamd_data:/var/lib/rspamd
      - ./config/rspamd:/etc/rspamd/override.d
      - ./logs/rspamd:/var/log/rspamd
    environment:
      - TZ=${TZ}
    depends_on:
      - clamav
    deploy:
      resources:
        limits:
          cpus: '${RSPAMD_CPU_LIMIT}'
          memory: ${RSPAMD_MEM_LIMIT}
    healthcheck:
      test: [ "CMD-SHELL", "rspamadm control stat >/dev/null 2>&1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ClamAV ウイルススキャン
  clamav:
    image: clamav/clamav:1.3
    container_name: mailserver-clamav
    hostname: clamav
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.80
    volumes:
      - clamav_data:/var/lib/clamav
      - ./config/clamav/clamd.conf:/etc/clamav/clamd.conf:ro
      - ./config/clamav/freshclam.conf:/etc/clamav/freshclam.conf:ro
      - ./logs/clamav:/var/log/clamav
    environment:
      - TZ=${TZ}
    deploy:
      resources:
        limits:
          cpus: '${CLAMAV_CPU_LIMIT}'
          memory: ${CLAMAV_MEM_LIMIT}
    healthcheck:
      test: [ "CMD-SHELL", "clamdscan --fdpass --no-summary /etc/hosts >/dev/null 2>&1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  # Roundcube Webmail
  roundcube:
    image: roundcube/roundcubemail:1.6.7-apache
    container_name: mailserver-roundcube
    hostname: roundcube
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.40
    environment:
      - ROUNDCUBEMAIL_DB_TYPE=mysql
      - ROUNDCUBEMAIL_DB_HOST=mariadb
      - ROUNDCUBEMAIL_DB_NAME=${MYSQL_DATABASE}
      - ROUNDCUBEMAIL_DB_USER=${MYSQL_USER}
      - ROUNDCUBEMAIL_DB_PASSWORD=${MYSQL_PASSWORD}
      - ROUNDCUBEMAIL_DEFAULT_HOST=ssl://dell-workstation.tail67811d.ts.net
      - ROUNDCUBEMAIL_DEFAULT_PORT=993
      - ROUNDCUBEMAIL_SMTP_SERVER=tls://dell-workstation.tail67811d.ts.net
      - ROUNDCUBEMAIL_SMTP_PORT=587
      # SMTP認証を無効化（Postfix submissionは mynetworks からの接続を許可）
      - ROUNDCUBEMAIL_SMTP_USER=
      - ROUNDCUBEMAIL_SMTP_PASS=
      - ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE=25M
      - ROUNDCUBEMAIL_DES_KEY=${ROUNDCUBE_DES_KEY}
      - TZ=${TZ}
    volumes:
      - ./config/roundcube:/var/roundcube/config
      - ./logs/roundcube:/var/log/roundcube
      # カスタム設定: SMTP認証無効化（Postfix submissionはmynetworksから接続許可）
      - ./config/roundcube/smtp_noauth.inc.php:/var/www/html/config/smtp_noauth.inc.php:ro
    depends_on:
      - mariadb
      - dovecot
      - postfix
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:1.26-alpine
    container_name: mailserver-nginx
    hostname: nginx
    restart: always
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.10
    ports:
      - "80:80"
      - "443:443"
    environment:
      - TZ=${TZ}
      - MAIL_HOSTNAME=${MAIL_HOSTNAME}
      - TLS_CERT_FILE=${POSTFIX_TLS_CERT_FILE:-/var/lib/tailscale/certs/tls.crt}
      - TLS_KEY_FILE=${POSTFIX_TLS_KEY_FILE:-/var/lib/tailscale/certs/tls.key}
      - NGINX_DOLLAR=$$
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/templates:/etc/nginx/templates:ro
      - /var/lib/tailscale/certs:/var/lib/tailscale/certs:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - roundcube
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
