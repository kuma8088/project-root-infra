# Infrastructure Documentation

Dockerã‚³ãƒ³ãƒ†ãƒŠåŸºç›¤ã®æ§‹ç¯‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ç¾åœ¨ã®æ§‹æˆ**: Dellä¸Šã§Docker Composeã‚’ç›´æ¥å®Ÿè¡Œï¼ˆKVMä»®æƒ³åŒ–ã¯æœªä½¿ç”¨ï¼‰

---

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆ

### è¦ä»¶ãƒ»è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|------------|------|
| [01_requirements.md](01_requirements.md) | ã‚¤ãƒ³ãƒ•ãƒ©è¦ä»¶å®šç¾© |
| [02_design.md](02_design.md) | ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸ |
| [03_Firewall(RX-600KI).md](03_Firewall(RX-600KI).md) | ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š |
| [04_installation.md](04_installation.md) | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é † |
| [05_testing.md](05_testing.md) | ãƒ†ã‚¹ãƒˆè¨ˆç”» |

### Phase 2: KVMç’°å¢ƒæ§‹ç¯‰ï¼ˆæ§‹ç¯‰æ¸ˆã¿ã€ç¾åœ¨æœªä½¿ç”¨ï¼‰

| æ‰‹é †æ›¸ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å†…å®¹ |
|-------|----------|------|
| [2.1-rocky-linux-kvm-host-setup.md](procedures/2-kvm/2.1-rocky-linux-kvm-host-setup.md) | âœ… å®Œäº†ï¼ˆæœªä½¿ç”¨ï¼‰ | Rocky Linux 9.6 + KVM ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— |
| [2.2-virtual-network-setup.md](procedures/2-kvm/2.2-virtual-network-setup.md) | âœ… å®Œäº†ï¼ˆæœªä½¿ç”¨ï¼‰ | AWS VPCç›¸å½“ã®5ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹ç¯‰ |

**æ³¨**: KVMç’°å¢ƒã¯å°†æ¥çš„ãªä»®æƒ³åŒ–ç”¨ã«æ§‹ç¯‰æ¸ˆã¿ã€‚ç¾åœ¨ã¯Dockerã‚’ãƒ›ã‚¹ãƒˆä¸Šã§ç›´æ¥å®Ÿè¡Œã€‚

### Phase 3: Dockerç’°å¢ƒæ§‹ç¯‰

| æ‰‹é †æ›¸ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å†…å®¹ |
|-------|----------|------|
| [3.1-docker-environment-setup.md](procedures/3-docker/3.1-docker-environment-setup.md) | ğŸ”„ é€²è¡Œä¸­ | Docker CE ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åŸºæœ¬è¨­å®š |
| [3.2-storage-backup-setup.md](procedures/3-docker/3.2-storage-backup-setup.md) | ğŸ”„ é€²è¡Œä¸­ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹æˆã¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š |
| [3.3-monitoring-security-setup.md](procedures/3-docker/3.3-monitoring-security-setup.md) | ğŸ”„ é€²è¡Œä¸­ | ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š |
| [3.4-infrastructure-validation.md](procedures/3-docker/3.4-infrastructure-validation.md) | ğŸ”„ é€²è¡Œä¸­ | ã‚¤ãƒ³ãƒ•ãƒ©æ¤œè¨¼ãƒ†ã‚¹ãƒˆ |

---

## ğŸŒ Docker Compose ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

**ç¾åœ¨ã®æ§‹æˆ**: Dellä¸Šã§Docker Composeã«ã‚ˆã‚‹8ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒ

### Dell Mailserver (Docker Compose)

| ã‚µãƒ¼ãƒ“ã‚¹ | å½¹å‰² | ãƒãƒ¼ãƒˆ | èª¬æ˜ |
|---------|------|--------|------|
| postfix | SMTPé€ä¿¡ | 25, 587 | SendGridçµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| dovecot | IMAP/POP3å—ä¿¡ | 993, 995, 2525 | ãƒ¡ãƒ¼ãƒ«å—ä¿¡ãƒ»ä¿å­˜ï¼ˆLMTPï¼‰ |
| mariadb | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | 3306 | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»Roundcube DB |
| clamav | ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ | - | ãƒ¡ãƒ¼ãƒ«æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ |
| rspamd | ã‚¹ãƒ‘ãƒ ãƒ•ã‚£ãƒ«ã‚¿ | - | ã‚¹ãƒ‘ãƒ åˆ¤å®šãƒ»å­¦ç¿’ |
| roundcube | Webãƒ¡ãƒ¼ãƒ« | 8080 | ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| usermgmt | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | 5001 | Flaskç®¡ç†ç”»é¢ï¼ˆPhase 11ï¼‰ |
| nginx | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· | 443 | HTTPSçµ‚ç«¯ãƒ»Tailscaleè¨¼æ˜æ›¸ |

**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ**:
- Dell: Docker Composeã§ãƒ›ã‚¹ãƒˆä¸Šã«ç›´æ¥èµ·å‹•
- EC2: Docker MX Gatewayï¼ˆmailserver-postfixã‚³ãƒ³ãƒ†ãƒŠï¼‰
- é€šä¿¡: EC2 â†’ Tailscale VPN â†’ Dell (100.110.222.53:2525)

è©³ç´°: [services/mailserver/README.md](../../services/mailserver/README.md)

### KVMä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆæ§‹ç¯‰æ¸ˆã¿ã€ç¾åœ¨æœªä½¿ç”¨ï¼‰

å°†æ¥çš„ãªä»®æƒ³åŒ–ç”¨ã«5ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ§‹ç¯‰æ¸ˆã¿ã€‚è©³ç´°ã¯[Phase 2æ‰‹é †æ›¸](procedures/2-kvm/2.2-virtual-network-setup.md)å‚ç…§ã€‚

---

## ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ§‹æˆï¼ˆPhase 3ï¼‰

| ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆ | ã‚µã‚¤ã‚º | ãƒ‡ãƒã‚¤ã‚¹ | ç”¨é€” |
|---------------|-------|---------|------|
| `/var/lib/docker` | 50GB | SSD | Dockerã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ |
| `/data/docker` | 3.6TB | HDD | ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ |
| `/mnt/backup` | å¤–ä»˜ã‘ | HDD | ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |

---

## ğŸš¨ é‡è¦ãªä½œæ¥­ãƒ«ãƒ¼ãƒ«

### 1. ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´å‰ã®å¿…é ˆç¢ºèª

**CRITICAL**: Docker/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šå¤‰æ›´æ™‚ã¯å¿…ãšå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª

```bash
# æ¨å¥¨ç¢ºèªæ‰‹é †
1. WebFetch ã§å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—
2. ç¾åœ¨ã®è¨­å®šç¢ºèª: docker compose config
3. ãƒ†ã‚¹ãƒˆç’°å¢ƒã§æ¤œè¨¼å¾Œã€æœ¬ç•ªé©ç”¨
```

**å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- Docker: https://docs.docker.com/
- Docker Compose: https://docs.docker.com/compose/
- Rocky Linux: https://docs.rockylinux.org/

### 2. SSH ãƒãƒ¼ãƒˆè¨­å®š

**çµ¶å¯¾ç¦æ­¢**: Port 22ã®ä½¿ç”¨
**ç¾åœ¨ã®æ§‹æˆ**: Dell/EC2ã¨ã‚‚ã«éæ¨™æº–ãƒãƒ¼ãƒˆä½¿ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰

**æ³¨**: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥ãƒãƒ¼ãƒˆï¼ˆ2201-2280ï¼‰ã¯KVMä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰

### 3. æ‰‹é †æ›¸å®Ÿè¡Œã®åŸå‰‡

- **å®Ÿè¡Œå‰**: å‰ææ¡ä»¶ãƒ»æœŸå¾…å‡ºåŠ›ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç¢ºèª
- **å®Ÿè¡Œä¸­**: çµæœã‚’è¨˜éŒ²ã€æœŸå¾…å€¤ã¨ç•°ãªã‚‹å ´åˆã¯åœæ­¢ã—ã¦èª¿æŸ»
- **å®Ÿè¡Œå¾Œ**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿæ–½ã€Git ã‚³ãƒŸãƒƒãƒˆ

---

## ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—

| Phase | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å®Œäº†æ¡ä»¶ |
|-------|----------|---------|
| Phase 1 | âœ… å®Œäº† | Minimal KVMç’°å¢ƒ |
| Phase 2 | âœ… å®Œäº† | 5ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¨¼åƒ |
| Phase 3 | ğŸ”„ é€²è¡Œä¸­ | DockeråŸºç›¤æ§‹ç¯‰å®Œäº† |
| Phase 4-5 | æœªç€æ‰‹ | Terraformçµ±åˆ |
| Phase 6+ | ä¸€éƒ¨é€²è¡Œä¸­ | ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆMailserverç¨¼åƒä¸­ï¼‰ |

---

## ğŸ”§ ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰

### Dockeræ“ä½œ

```bash
# ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ï¼ˆMailserverï¼‰
cd /opt/onprem-infra-system/project-root-infra/services/mailserver
docker compose ps
docker compose logs -f <service-name>
docker compose restart <service-name>

# ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
docker system df
docker volume ls

# ãƒ­ã‚°ç¢ºèª
sudo journalctl -u docker -f
```

### KVMæ“ä½œï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰

```bash
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
sudo virsh net-list --all

# VMæ“ä½œ
sudo virsh list --all
```

è©³ç´°ãªã‚³ãƒãƒ³ãƒ‰ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯[services/mailserver/README.md](../../services/mailserver/README.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## âš ï¸ ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦

| å•é¡Œ | åŸå›  | å¯¾å‡¦ |
|-----|------|-----|
| Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¤±æ•— | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸/ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å•é¡Œ | daemon.jsonæ¤œè¨¼ã€SELinuxã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºèª |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå¤±æ•— | Dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š | docker network inspectç¢ºèª |
| ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³ | ãƒœãƒªãƒ¥ãƒ¼ãƒ /ã‚¤ãƒ¡ãƒ¼ã‚¸è‚¥å¤§åŒ– | docker system pruneå®Ÿè¡Œ |
| ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡ | ãƒ¡ãƒ¢ãƒª/CPU/ãƒ‡ã‚£ã‚¹ã‚¯ä¸è¶³ | docker statsç¢ºèªã€ä¸è¦ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ |

è©³ç´°ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯å„æ‰‹é †æ›¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ğŸŒ©ï¸ å°†æ¥ã®AWSç§»è¡Œ

- **Terraform**: KVMãƒªã‚½ãƒ¼ã‚¹ã‚’Terraformæ§‹æˆã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- **AWS MGN**: Application Migration Serviceã«ã‚ˆã‚‹ç§»è¡Œ
- **æ®µéšçš„ç§»è¡Œ**: é–‹ç™º(Dell) â†’ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°(AWS) â†’ æœ¬ç•ª(AWS Multi-AZ)

---

**Repository Type**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé§†å‹•å‹ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒã‚¸ãƒˆãƒª
**Main Deliverables**: å®Ÿè¡Œå¯èƒ½ãªæ‰‹é †æ›¸ï¼ˆBash ã‚³ãƒãƒ³ãƒ‰ï¼‰
**Validation Method**: å®Ÿéš›ã®ã‚¤ãƒ³ãƒ•ãƒ©ä¸Šã§ã®å®Ÿè¡Œã¨æ¤œè¨¼
