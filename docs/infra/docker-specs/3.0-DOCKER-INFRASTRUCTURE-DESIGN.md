# Docker基盤環境 設計書

## 概要

Dell WorkStation（Rocky Linux 9.6）上にDocker + Docker Compose + Docker Swarm基盤を構築する。既存のKVM/LibVirt環境（Phase 1-2完了）をベースに、ホスト直接Docker実行方式を採用し、リソース効率を最大化する。将来的な商用サービス開発・AWS移行を見据えた拡張可能な設計とする。

## ハードウェア仕様（既存環境）

### Dell WorkStation スペック

- **OS**: Rocky Linux 9.6
- **CPU**: x86_64 (6コア/12スレッド, 1199 MHz)
- **メモリ**: 32GB (32,266,720 KiB)
- **ストレージ**:
  - OS領域: /dev/mapper/rl-root 70GB (SSD)
  - ホーム領域: /dev/mapper/rl-home 390GB (SSD)
  - データ領域: /dev/sdb1 3.6TB (HDD) - /data マウント
  - ブート領域: /dev/sda2 960MB

### Phase 3 リソース配分

| リソース | ホストOS予約 | Docker環境 | 予備 | 合計 |
|---------|------------|-----------|------|------|
| CPU | 2コア | 4コア（8vCPU*） | - | 6コア |
| メモリ | 8GB | 16GB | 8GB | 32GB |
| SSD | 410GB | 50GB | - | 460GB |
| HDD | - | 3.0TB | 0.6TB | 3.6TB |

*1:2オーバーコミット想定

## アーキテクチャ設計

### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  Dell WorkStation (Rocky Linux 9.6)         │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐    │
│  │           Host OS Layer (2コア, 8GB RAM)          │    │
│  │  - systemd, firewalld, SELinux                    │    │
│  │  - KVM/LibVirt (既存Phase 1-2構成維持)             │    │
│  │  - SSH, fail2ban, logwatch                        │    │
│  │  - dnf-automatic (自動セキュリティアップデート)      │    │
│  └────────────────────────────────────────────────────┘    │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │      Docker Engine Layer (4コア, 16GB RAM)        │    │
│  │  ┌──────────────────────────────────────────┐     │    │
│  │  │       Docker Swarm (単一ノード)          │     │    │
│  │  │  - Swarm Manager                          │     │    │
│  │  │  - ingress network                        │     │    │
│  │  │  - docker_gwbridge                        │     │    │
│  │  └──────────────────────────────────────────┘     │    │
│  │                       ▼                             │    │
│  │  ┌──────────────────────────────────────────┐     │    │
│  │  │      Docker Compose Services             │     │    │
│  │  │  - Service A (例: Webmail)               │     │    │
│  │  │  - Service B (例: Blog)                  │     │    │
│  │  │  - Service C (例: Database)              │     │    │
│  │  └──────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────┘    │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │              Storage Layer                          │    │
│  │  - /var/lib/docker (SSD 50GB) - Docker システム    │    │
│  │  - /data/docker (HDD 3.0TB) - ボリューム/イメージ   │    │
│  │  - /mnt/backup (外付けHDD) - 週1バックアップ       │    │
│  └────────────────────────────────────────────────────┘    │
│                           ▼                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │       Monitoring & Security Layer                   │    │
│  │  - systemd journald (ログ収集)                      │    │
│  │  - logwatch (日次レポート)                          │    │
│  │  - fail2ban (ブルートフォース防御)                  │    │
│  │  - SELinux Enforcing                                │    │
│  │  - Discord Webhook (アラート通知)                   │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### レイヤー責務

#### 1. Host OS Layer
- **責務**: OSレベルのセキュリティ、基本サービス、KVM/LibVirt管理
- **主要コンポーネント**:
  - systemd: サービス管理、自動起動
  - firewalld: ファイアウォール管理
  - SELinux: 強制アクセス制御
  - fail2ban: 侵入防止
  - dnf-automatic: 自動セキュリティアップデート

#### 2. Docker Engine Layer
- **責務**: コンテナ実行、ネットワーク管理、リソース管理
- **主要コンポーネント**:
  - Docker Engine: コンテナランタイム
  - Docker Compose: マルチコンテナ管理
  - Docker Swarm: オーケストレーション（単一ノード初期構成）
  - containerd: コンテナ実行環境

#### 3. Storage Layer
- **責務**: データ永続化、イメージ管理、バックアップ
- **配置戦略**:
  - 高速アクセス必要データ → SSD (/var/lib/docker)
  - 大容量データ → HDD (/data/docker)
  - バックアップ → 外付けHDD (/mnt/backup)

#### 4. Monitoring & Security Layer
- **責務**: ログ収集・分析、アラート通知、セキュリティ監視
- **主要機能**:
  - ログ集約（journald）
  - 異常検知（logwatch）
  - アラート配信（メール + Discord）

## ネットワーク設計

### 既存ネットワーク（Phase 2構築済み）

| セグメント | CIDR        | 用途         | 備考               |
|-----------|-------------|-------------|--------------------|
| Management| 10.0.0.0/24 | 管理用       | LibVirt管理        |
| Public    | 10.0.1.0/24 | パブリック   | LibVirt管理        |
| Private   | 10.0.2.0/24 | プライベート | LibVirt管理        |
| Database  | 10.0.3.0/24 | データベース | LibVirt管理        |
| Container | 10.0.4.0/24 | コンテナ     | LibVirt管理（未使用）|

### Docker独自ネットワーク

Dockerはホスト上で独自のネットワークセグメントを使用します。既存のLibVirtネットワーク（10.0.x.0/24）とは独立して動作します。

| ネットワーク | CIDR          | 用途                     | 管理      |
|-------------|---------------|-------------------------|----------|
| docker0     | 172.17.0.0/16 | Dockerデフォルトブリッジ | Docker   |
| ingress     | 10.0.255.0/24 | Docker Swarm ingress    | Swarm    |
| docker_gwbridge | 172.18.0.0/16 | Swarmゲートウェイ    | Swarm    |
| カスタムネットワーク | 172.19-30.0.0/16 | サービス専用 | Compose  |

### ネットワーク設計方針

1. **分離原則**: LibVirtネットワークとDockerネットワークは独立
2. **Swarm準備**: ingress/docker_gwbridge を初期化（将来のマルチノード対応）
3. **カスタムネットワーク**: サービスごとにdocker-compose.ymlでブリッジネットワーク定義
4. **外部アクセス**: ホストのファイアウォール経由で公開ポートを制御

### ポート割り当て戦略

| サービス種別 | ポート範囲 | 用途                |
|-------------|-----------|---------------------|
| Docker API  | 2375/2376 | Docker Remote API   |
| HTTP        | 80        | Webサービス         |
| HTTPS       | 443       | SSL/TLS Webサービス |
| SMTP        | 25/587    | メール送信          |
| IMAP        | 143/993   | メール受信          |
| カスタム    | 8000-8999 | アプリケーション    |

**セキュリティルール**:
- Docker API（2375/2376）は外部からアクセス不可（firewalldでブロック）
- 公開サービスはリバースプロキシ（Nginx/Traefik）経由で公開

## ストレージ設計

### ディレクトリ構造

```
/
├── var/
│   └── lib/
│       └── docker/                      # Docker システム領域（SSD 50GB）
│           ├── containers/              # コンテナメタデータ
│           ├── image/                   # イメージレイヤー
│           ├── overlay2/                # OverlayFS ストレージドライバ
│           ├── volumes/                 # 小規模ボリューム（高速アクセス必要）
│           └── swarm/                   # Swarm設定
│
├── data/
│   ├── docker/                          # Docker データ領域（HDD 3.0TB）
│   │   ├── volumes/                     # 大容量ボリューム
│   │   │   ├── webmail_data/
│   │   │   ├── blog_data/
│   │   │   └── database_data/
│   │   ├── images/                      # 大容量イメージ
│   │   └── backups/                     # ローカルバックアップ
│   │
│   └── docker-compose/                  # Composeファイル管理
│       ├── webmail/
│       │   └── docker-compose.yml
│       ├── blog/
│       │   └── docker-compose.yml
│       └── common/
│           └── .env
│
└── mnt/
    └── backup/                          # 外付けHDD マウントポイント
        └── docker/
            ├── volumes/                 # ボリュームバックアップ
            ├── images/                  # イメージバックアップ
            └── compose/                 # Composeファイルバックアップ
```

### ストレージドライバ

- **選択**: overlay2（Dockerデフォルト、Rocky Linux 9.6推奨）
- **理由**: 高性能、安定性、ext4との相性良好
- **設定**: /etc/docker/daemon.json で明示的に指定

### ボリューム配置戦略

| データ種別 | 配置先 | 理由 |
|-----------|-------|------|
| Dockerシステム | SSD (/var/lib/docker) | 高速アクセス必須 |
| アプリケーション小規模DB | SSD (/var/lib/docker/volumes) | 頻繁なI/O |
| 大容量DB・ファイルストレージ | HDD (/data/docker/volumes) | 容量優先 |
| イメージキャッシュ | HDD (/data/docker/images) | 読み取り頻度低 |
| バックアップ | 外付けHDD (/mnt/backup) | オフライン保管 |

### データ永続化パターン

**docker-compose.yml 例**:
```yaml
version: '3.8'
services:
  app:
    image: nginx:latest
    volumes:
      # 名前付きボリューム（Docker管理）
      - app_data:/var/www/html
      # バインドマウント（ホスト直接）
      - /data/docker/volumes/app_config:/etc/nginx/conf.d:ro

volumes:
  app_data:
    driver: local
    driver_opts:
      type: none
      device: /data/docker/volumes/app_data
      o: bind
```

## バックアップ設計

### バックアップ対象

1. **Dockerボリューム**: /data/docker/volumes/
2. **Dockerイメージ**: docker save コマンドでtar.gz化
3. **Docker Composeファイル**: /data/docker-compose/
4. **Docker Swarm設定**: docker config/secret export

### バックアップ方式

**スクリプト**: `/usr/local/bin/docker-backup.sh`

```bash
#!/bin/bash
# 週1回実行（cron: 0 2 * * 0）

BACKUP_DIR="/mnt/backup/docker/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# 1. ボリュームバックアップ
rsync -av --delete /data/docker/volumes/ "$BACKUP_DIR/volumes/"

# 2. イメージバックアップ（全イメージをtar.gz化）
docker images --format "{{.Repository}}:{{.Tag}}" | \
  xargs -I {} docker save {} | gzip > "$BACKUP_DIR/images/all-images.tar.gz"

# 3. Composeファイルバックアップ
rsync -av /data/docker-compose/ "$BACKUP_DIR/compose/"

# 4. Swarm設定バックアップ
docker config ls --format "{{.Name}}" | \
  xargs -I {} docker config inspect {} > "$BACKUP_DIR/swarm/configs.json"

# 5. ログ記録
echo "Backup completed: $(date)" >> /var/log/docker-backup.log
```

**cron設定**:
```
# /etc/cron.d/docker-backup
0 2 * * 0 root /usr/local/bin/docker-backup.sh
```

### リストア手順

1. **ボリューム復元**: `rsync -av /mnt/backup/docker/YYYYMMDD/volumes/ /data/docker/volumes/`
2. **イメージ復元**: `docker load < /mnt/backup/docker/YYYYMMDD/images/all-images.tar.gz`
3. **Compose再起動**: `docker-compose up -d`

## 監視・ロギング設計

### ログ収集アーキテクチャ

```
┌────────────────────────────────────────┐
│      Docker Containers                 │
│  ┌──────┐  ┌──────┐  ┌──────┐        │
│  │ App1 │  │ App2 │  │ DB   │        │
│  └──┬───┘  └──┬───┘  └──┬───┘        │
│     │         │         │              │
│     └─────────┴─────────┘              │
│              ▼                          │
│     journald (json-file driver)        │
└────────────────────────────────────────┘
              ▼
┌────────────────────────────────────────┐
│     systemd journald                   │
│  - /var/log/journal/                   │
│  - ログローテーション（30日保持）        │
└────────────────────────────────────────┘
              ▼
┌────────────────────────────────────────┐
│         logwatch                       │
│  - 日次レポート生成                     │
│  - 重大エラー検出                       │
│  - メール送信                           │
└────────────────────────────────────────┘
              ▼
┌────────────────────────────────────────┐
│    Alert Notification                  │
│  - メール（重大エラー）                 │
│  - Discord Webhook（セキュリティ）      │
└────────────────────────────────────────┘
```

### ログ設定

**/etc/docker/daemon.json**:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3",
    "labels": "service,environment"
  }
}
```

### 監視メトリクス

| メトリクス | 収集方法 | 閾値 | アラート |
|-----------|---------|------|---------|
| CPU使用率 | `docker stats` | >80% | Discord |
| メモリ使用率 | `docker stats` | >70% | Discord + メール |
| ディスク使用率 | `df -h` | >80% | メール |
| コンテナ死活 | `docker ps` | コンテナダウン | Discord |
| ログエラー率 | logwatch | Critical/Error | メール |

### logwatch設定

**/etc/logwatch/conf/logwatch.conf**:
```
Detail = Med
MailTo = admin@example.com
Range = Yesterday
Service = docker
Service = sshd
Service = fail2ban
```

## セキュリティ設計

### 多層防御アーキテクチャ

```
Layer 1: Network Firewall (firewalld)
         ↓
Layer 2: SSH Hardening (公開鍵認証, fail2ban)
         ↓
Layer 3: SELinux (Enforcing mode)
         ↓
Layer 4: Docker Security (Content Trust, Resource Limits)
         ↓
Layer 5: Application Security (コンテナ内アプリケーション)
```

### SSH強化設定

**/etc/ssh/sshd_config**:
```
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
Port 22
AllowUsers <username>
```

### fail2ban設定

**/etc/fail2ban/jail.local**:
```ini
[DEFAULT]
bantime = 600
findtime = 600
maxretry = 5
destemail = admin@example.com
action = %(action_mwl)s

[sshd]
enabled = true
port = 22
logpath = /var/log/secure

[docker-api]
enabled = true
port = 2375,2376
logpath = /var/log/docker.log
```

### Docker セキュリティ設定

**/etc/docker/daemon.json**:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "data-root": "/data/docker",
  "live-restore": true,
  "userland-proxy": false,
  "no-new-privileges": true,
  "seccomp-profile": "/etc/docker/seccomp.json",
  "userns-remap": "default"
}
```

### SELinux ポリシー

- **モード**: Enforcing
- **ポリシー**: Targeted
- **Docker用カスタムポリシー**: 必要に応じて追加

### 自動アップデート設定

**/etc/dnf/automatic.conf**:
```ini
[commands]
upgrade_type = security
download_updates = yes
apply_updates = yes

[emitters]
emit_via = email
email_from = root@localhost
email_to = admin@example.com

[email]
email_host = localhost
```

## Docker Swarm設計

### 初期構成（単一ノード）

```
┌─────────────────────────────────────────┐
│      Docker Swarm Manager Node          │
│  (Dell WorkStation - Rocky Linux 9.6)   │
│                                          │
│  ┌────────────────────────────────┐    │
│  │     Swarm Manager               │    │
│  │  - Raft Consensus               │    │
│  │  - Service Orchestration        │    │
│  │  - Task Scheduling              │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌────────────────────────────────┐    │
│  │     Ingress Network             │    │
│  │  - Load Balancing (L4)          │    │
│  │  - Service Discovery            │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌────────────────────────────────┐    │
│  │     Services (Stacks)           │    │
│  │  - webmail-stack                │    │
│  │  - blog-stack                   │    │
│  │  - monitoring-stack             │    │
│  └────────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### Swarm初期化コマンド

```bash
# Swarm初期化（アドバタイズアドレス指定）
docker swarm init --advertise-addr <host-ip>

# Swarmトークン確認（将来のワーカーノード追加用）
docker swarm join-token worker > /root/.docker-swarm-token
chmod 600 /root/.docker-swarm-token
```

### サービスデプロイ例（docker-compose.yml → stack）

```yaml
version: '3.8'

services:
  web:
    image: nginx:latest
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    ports:
      - "80:80"
    networks:
      - webnet

networks:
  webnet:
    driver: overlay
```

**デプロイコマンド**:
```bash
docker stack deploy -c docker-compose.yml <stack-name>
```

### 将来のマルチノード拡張

```
Manager Node (現在)      Worker Node 1 (将来)     Worker Node 2 (将来)
┌──────────────┐         ┌──────────────┐        ┌──────────────┐
│ Swarm Manager│◄────────┤ Swarm Worker │        │ Swarm Worker │
│              │         │              │◄───────┤              │
│ Services     │         │ Tasks        │        │ Tasks        │
└──────────────┘         └──────────────┘        └──────────────┘
       │                        │                        │
       └────────────────────────┴────────────────────────┘
                    Ingress Overlay Network
```

## リソース管理設計

### cgroup設定

Docker Composeでリソース制限を強制：

```yaml
services:
  app:
    image: myapp:latest
    deploy:
      resources:
        limits:
          cpus: '1.0'      # 最大1コア
          memory: 2G       # 最大2GB RAM
        reservations:
          cpus: '0.5'      # 最小0.5コア予約
          memory: 1G       # 最小1GB RAM予約
```

### swappiness設定

**/etc/sysctl.d/99-swappiness.conf**:
```
vm.swappiness=10
```

### ディスククォータ

将来的にxfsまたはext4クォータを検討（現時点では手動監視）。

## 性能最適化設計

### Docker Engine最適化

**/etc/docker/daemon.json**（追加設定）:
```json
{
  "max-concurrent-downloads": 3,
  "max-concurrent-uploads": 5,
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  }
}
```

### カーネルパラメータ最適化

**/etc/sysctl.d/99-docker.conf**:
```
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=512
```

## 運用手順概要

### 日常運用

| タスク | 頻度 | コマンド |
|-------|------|---------|
| コンテナ状態確認 | 毎日 | `docker ps -a` |
| リソース使用率確認 | 毎日 | `docker stats --no-stream` |
| ログ確認 | 毎日 | `journalctl -u docker --since today` |
| ディスク使用率確認 | 週1 | `df -h /data/docker` |
| イメージクリーンアップ | 週1 | `docker image prune -a -f` |
| バックアップ確認 | 週1 | `ls -lh /mnt/backup/docker/` |
| セキュリティアップデート | 自動（週1） | dnf-automatic |

### トラブルシューティングフロー

```
問題発生
  ↓
1. コンテナ状態確認: docker ps -a
  ↓
2. ログ確認: docker logs <container>
  ↓
3. リソース確認: docker stats
  ↓
4. ネットワーク確認: docker network inspect
  ↓
5. イベント確認: docker events --since 1h
  ↓
6. ホストリソース確認: top, free, df
  ↓
7. SELinuxログ確認: ausearch -m avc
  ↓
解決 または エスカレーション
```

## AWS移行パス設計

### Docker → ECS 移行戦略

1. **docker-compose.yml → ECS Task Definition変換**
   - ecs-cli composeコマンド使用
   - 手動調整（ECS固有パラメータ追加）

2. **ボリューム移行**
   - Docker Volume → EFS/EBS変換
   - データ移行（rsync, AWS DataSync）

3. **ネットワーク移行**
   - Docker Network → AWS VPC/Subnet
   - セキュリティグループ設定

4. **シークレット管理**
   - 環境変数 → AWS Secrets Manager/Parameter Store

### Terraform管理準備

Phase 3完了後、以下のTerraformモジュール作成：
- `modules/docker-service/`: Docker Compose定義のTerraform化
- `modules/ecs-migration/`: ECS Task Definition生成

## テスト戦略

### 単体テスト（コンポーネント別）

| テスト項目 | 検証内容 | 合格基準 |
|-----------|---------|---------|
| Docker Engine起動 | systemctl status docker | active (running) |
| Docker Compose動作 | docker-compose version | v2.x表示 |
| Docker Swarm初期化 | docker info \| grep Swarm | Swarm: active |
| ストレージ設定 | df -h \| grep /data/docker | マウント確認 |
| バックアップスクリプト | /usr/local/bin/docker-backup.sh | エラーなし |
| fail2ban動作 | fail2ban-client status | sshd jail有効 |
| SELinux | getenforce | Enforcing |
| logwatch | logwatch --detail Med | レポート生成 |

### 統合テスト

1. **テストコンテナデプロイ**: nginx起動 → HTTP接続確認
2. **リソース制限テスト**: メモリ制限コンテナ起動 → OOM動作確認
3. **バックアップ/リストアテスト**: 実行 → 復元 → データ整合性確認
4. **アラートテスト**: 意図的エラー発生 → 通知受信確認
5. **負荷テスト**: 複数コンテナ同時起動 → リソース使用率確認

## 成果物

### Phase 3完了時の成果物

1. **要件定義書**: `Docs/infra/3.0-DOCKER-INFRASTRUCTURE-REQUIREMENTS.md`
2. **設計書**: `Docs/infra/3.0-DOCKER-INFRASTRUCTURE-DESIGN.md`（本ドキュメント）
3. **構築手順書**:
   - `procedures/3.1-docker-environment-setup.md`
   - `procedures/3.2-storage-backup-setup.md`
   - `procedures/3.3-monitoring-security-setup.md`
   - `procedures/3.4-infrastructure-validation.md`
4. **設定ファイル**:
   - `/etc/docker/daemon.json`
   - `/usr/local/bin/docker-backup.sh`
   - `/etc/fail2ban/jail.local`
   - `/etc/logwatch/conf/logwatch.conf`
5. **動作確認済み環境**: テストコンテナが正常稼働する状態

## 付録

### 参考コマンド集

```bash
# Docker情報確認
docker info
docker version

# Swarm状態確認
docker node ls
docker service ls
docker stack ls

# ネットワーク確認
docker network ls
docker network inspect ingress

# ボリューム確認
docker volume ls
docker volume inspect <volume-name>

# リソース確認
docker stats --no-stream
docker system df

# ログ確認
docker logs <container>
journalctl -u docker --since today

# クリーンアップ
docker system prune -a --volumes -f
```

### トラブルシューティングFAQ

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| Docker起動失敗 | ストレージドライバエラー | `journalctl -u docker -xe` 確認 |
| コンテナ起動失敗 | リソース不足 | `docker stats` でリソース確認 |
| ネットワーク接続不可 | ファイアウォール | `firewall-cmd --list-all` 確認 |
| ボリュームマウント失敗 | SELinuxコンテキスト | `chcon -Rt svirt_sandbox_file_t <path>` |
| Swarm初期化失敗 | ポート競合 | `ss -tulpn \| grep 2377` 確認 |

**END OF DOCUMENT**
