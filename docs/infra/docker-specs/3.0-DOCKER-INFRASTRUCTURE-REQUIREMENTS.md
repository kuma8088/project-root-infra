# Docker基盤環境 要件定義書

## 概要

Dell WorkStation（Rocky Linux 9.6）上にDocker基盤環境を構築し、将来的な商用サービス開発・検証のための基盤を整備する。既存のKVM/LibVirt環境（Phase 1-2完了）をベースに、Docker + Docker Compose環境を構築し、将来的にDocker Swarmによるクラスタ化に対応可能な設計とする。

## 背景と目的

### 背景
- Phase 1: KVM基盤環境構築完了（Rocky Linux 9.6 + KVM/QEMU/LibVirt）
- Phase 2: AWS VPC相当ネットワーク構築完了（5セグメント: Management, Public, Private, Database, Container）
- 次フェーズ: ウェブメール、ブログ移行、商用サービス開発のためのコンテナ基盤が必要

### 目的
1. **技術習得**: Docker/Docker Composeの実践的な構築経験
2. **開発・検証基盤**: 商用サービスの開発・テスト環境
3. **AWS移行準備**: コンテナ化により、将来的なAWS ECS/EKS移行を容易化
4. **リソース効率化**: KVM上の複数VM構成よりも、ホスト直接Docker実行でオーバーヘッド削減
5. **スケーラビリティ**: Docker Swarmによる将来的なクラスタ化対応

## 用語集

- **Docker Host**: Dell WorkStation（Rocky Linux 9.6）上で直接Dockerを実行する環境
- **Docker Compose**: 複数コンテナの定義・管理ツール
- **Docker Swarm**: Dockerネイティブのクラスタリング・オーケストレーション機能
- **Container Network**: Dockerが管理する独自ネットワークセグメント（172.17.0.0/16等）
- **Volume**: コンテナのデータ永続化領域
- **Service**: Docker ComposeまたはSwarmで管理されるコンテナ群

## スコープ

### 含まれるもの
- Rocky Linux 9.6へのDocker Engine + Docker Composeインストール
- Dockerストレージ設定（SSD/HDD最適配置）
- 外付けHDDバックアップ環境準備（週1自動rsync）
- 最小限の監視・ロギング（systemd journald + logwatch）
- セキュリティ基盤（SSH公開鍵、fail2ban、SELinux、自動アップデート、ログ監視）
- Docker Swarm初期化（単一ノード構成、将来の拡張準備）
- 統合動作確認テスト

### 含まれないもの
- 個別サービス（ウェブメール、ブログ等）の構築（別フェーズで実施）
- Kubernetes環境（将来の選択肢として残す）
- 高可用性構成（マルチノードSwarm、ロードバランサー等）
- 本番レベルの監視システム（Prometheus/Grafana等）

## 要件

### 要件1: Docker基盤環境の構築

**ユーザーストーリー**: 技術者として、Rocky Linux 9.6上にDocker基盤環境を構築したい。そうすることで、コンテナ化されたサービスを開発・検証できる。

#### 受け入れ基準

1. THE System SHALL Rocky Linux 9.6に Docker Engine（最新安定版）をインストールする
2. THE System SHALL Docker Compose（v2系）をインストールする
3. THE System SHALL Docker Swarmを単一ノード構成で初期化する
4. THE Docker Service SHALL systemd経由で自動起動する
5. THE System SHALL root以外のユーザーがsudo不要でDockerコマンドを実行できる（dockerグループ所属）
6. THE Docker Network SHALL 既存libvirtネットワーク（10.0.x.0/24）と独立したセグメントを使用する
7. THE System SHALL Dockerデーモン設定ファイル（/etc/docker/daemon.json）で最適化設定を適用する

### 要件2: ストレージ管理とバックアップ

**ユーザーストーリー**: 技術者として、Dockerのストレージを適切に管理し、バックアップ環境を準備したい。そうすることで、データ損失リスクを最小化できる。

#### 受け入れ基準

1. THE System SHALL Dockerシステム領域（/var/lib/docker）をSSD上に配置する（50GB割当）
2. THE System SHALL Dockerボリューム・イメージ格納領域を/data/docker（HDD 3.6TB内）に配置する
3. THE System SHALL ext4ファイルシステムを継続使用する
4. THE System SHALL 外付けHDDマウントポイント（/mnt/backup）を準備する
5. THE System SHALL 週1回の自動バックアップスクリプト（cron + rsync）を設定する
6. THE Backup Script SHALL Dockerボリューム、イメージ、docker-compose.ymlファイルをバックアップする
7. THE System SHALL バックアップログを/var/log/docker-backupに記録する

### 要件3: 監視・ロギング（最小構成）

**ユーザーストーリー**: 技術者として、重大なエラーとセキュリティインシデントを検知したい。そうすることで、迅速に対応できる。

#### 受け入れ基準

1. THE System SHALL systemd journaldでDockerログを収集する
2. THE System SHALL logwatchで日次ログレポートを生成する
3. THE System SHALL 重大エラー（Critical/Error）をメール通知する
4. THE System SHALL セキュリティインシデント（SSH不正アクセス、fail2ban検知）をDiscord Webhookで通知する
5. THE System SHALL ログローテーション設定を適用する（30日保持、圧縮）
6. THE System SHALL Dockerコンテナログを/var/log/docker/containersに集約する
7. THE Monitoring System SHALL CPU使用率、メモリ使用率、ディスク使用率の基本メトリクスを記録する

### 要件4: セキュリティ基盤

**ユーザーストーリー**: 技術者として、最低限のセキュリティ対策を実装したい。そうすることで、基本的な脅威から環境を保護できる。

#### 受け入れ基準

1. THE System SHALL SSH公開鍵認証を強制し、パスワード認証を無効化する
2. THE System SHALL fail2banでSSH/Docker APIへのブルートフォース攻撃を防御する
3. THE System SHALL SELinuxをEnforcingモードで維持する
4. THE System SHALL dnf-automaticで週1回の自動セキュリティアップデートを実行する
5. THE System SHALL firewalldでDocker APIポート（2375/2376）を外部から遮断する
6. THE System SHALL logwatchで異常なログパターンを検知する
7. THE System SHALL Docker Content Trust（署名検証）を有効化する（商用サービス構築時）
8. THE System SHALL Dockerコンテナのリソース制限（CPU/メモリ）を強制する

### 要件5: リソース配分管理

**ユーザーストーリー**: 技術者として、限られたハードウェアリソースを効率的に配分したい。そうすることで、安定した運用を実現できる。

#### 受け入れ基準

1. THE System SHALL ホストOS用にCPU 2コア、メモリ8GBを予約する
2. THE System SHALL Docker環境用にCPU 4コア（8vCPU相当、1:2オーバーコミット）、メモリ16GBを割り当てる
3. THE System SHALL メモリ使用率70%を超えた場合にアラートを発行する
4. THE System SHALL Dockerコンテナ起動時にCPU/メモリ制限を必須とする
5. THE System SHALL ストレージ使用率80%を超えた場合にアラートを発行する
6. THE System SHALL スワップ使用を最小限に抑える（swappiness=10設定）
7. THE System SHALL Docker Swarmのリソース制約を設定する

### 要件6: Docker Swarm初期化（将来拡張準備）

**ユーザーストーリー**: 技術者として、将来的なクラスタ化に備えてDocker Swarmを初期化したい。そうすることで、スムーズに拡張できる。

#### 受け入れ基準

1. THE System SHALL Docker Swarmを単一ノードマネージャーとして初期化する
2. THE System SHALL Swarmネットワーク（ingress, docker_gwbridge）を作成する
3. THE System SHALL Swarm Tokenを安全に保存する（将来のワーカーノード追加用）
4. THE System SHALL docker stack deploy コマンドでサービスデプロイ可能な状態にする
5. THE System SHALL Swarm Visualizerを起動し、クラスタ状態を可視化する（オプション）

## 非機能要件

### 性能要件
- Docker Engine起動時間: 30秒以内
- コンテナ起動時間: 10秒以内（一般的なWebアプリケーション）
- イメージpull速度: 10MB/s以上（ネットワーク帯域に依存）
- ストレージI/O: SSD領域で100MB/s以上、HDD領域で50MB/s以上

### 可用性要件
- Docker Engine稼働率: 99%以上（月間ダウンタイム7.2時間以内）
- 自動再起動: systemd経由でDocker Engineが自動復旧する
- コンテナ再起動ポリシー: `restart: unless-stopped`をデフォルトとする

### セキュリティ要件
- SSH公開鍵認証: 2048bit RSA以上または Ed25519
- fail2ban: 5回失敗でIP 10分間ブロック
- SELinux: Enforcingモード維持、AVC拒否ログ監視
- 自動アップデート: 週1回実行、重大な脆弱性は即時適用

### 運用性要件
- バックアップ実行時間: 30分以内（週1回深夜実行）
- ログ保持期間: 30日間
- アラート応答時間: 重大エラーは15分以内に通知
- 手順書完備: すべての運用タスクに手順書が存在する

### 拡張性要件
- Docker Swarmワーカーノード追加: 追加ハードウェア導入時に対応可能
- AWS移行: docker-compose.ymlをAWS ECS Task Definitionに変換可能
- Kubernetes移行: 将来的な選択肢として残す（現時点で実装不要）

## 制約事項

### ハードウェア制約
- CPU: 6コア/12スレッド（物理制約）
- メモリ: 32GB（拡張可能だが初期段階では現状維持）
- ストレージ: SSD 460GB（OS/Docker領域）、HDD 3.6TB（データ領域）

### ソフトウェア制約
- OS: Rocky Linux 9.6（変更不可）
- Docker: Docker Engine CE（Community Edition）使用
- ネットワーク: libvirtネットワーク（10.0.x.0/24）は既存構成を維持

### 運用制約
- 運用者: 単独運用（初期段階）
- 監視時間: 24時間365日の監視は不要、重大エラーのみアラート
- バックアップ: 外付けHDD手動接続、週1回自動バックアップ

## 成功基準

### Phase 3完了の定義
1. ✅ Docker Engine + Docker Compose + Docker Swarmがインストール・起動済み
2. ✅ ストレージ設定完了（/var/lib/docker、/data/docker）
3. ✅ 外付けHDDバックアップスクリプトが週1回自動実行される
4. ✅ 監視・ロギングが動作し、テストアラートが正常に届く
5. ✅ セキュリティ設定完了（SSH公開鍵、fail2ban、SELinux、自動アップデート）
6. ✅ 統合テストで全項目がPASSする
7. ✅ 手順書に基づいて、技術者がゼロから環境を再現できる

### 検証方法
- 手順書に記載された検証コマンドを実行し、期待される出力を確認
- テストコンテナ（nginx）を起動し、HTTP接続を確認
- バックアップスクリプトを手動実行し、復元テストを実施
- fail2banテスト（意図的な失敗ログイン）でブロック動作を確認
- リソース使用率がメモリ70%以内、ストレージ80%以内であることを確認

## 前提条件

- Phase 1（KVM基盤構築）完了
- Phase 2（AWS VPC相当ネットワーク構築）完了
- Rocky Linux 9.6が正常稼働中
- インターネット接続が利用可能
- root権限またはsudo権限を持つユーザーでログイン可能

## リスクと対策

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| Dockerストレージ枯渇 | 中 | 高 | ストレージ使用率監視、80%でアラート、定期的なイメージ/ボリューム削除 |
| メモリ不足によるOOM Killer | 中 | 中 | コンテナリソース制限強制、メモリ使用率70%でアラート |
| Docker Engineクラッシュ | 低 | 中 | systemd自動再起動、fail時のログ記録 |
| セキュリティアップデート失敗 | 低 | 高 | dnf-automatic失敗時のメール通知、週次手動確認 |
| バックアップ失敗 | 中 | 高 | バックアップスクリプト実行ログ監視、失敗時のアラート |
| Docker Swarm設定ミス | 低 | 低 | 単一ノード構成のため影響限定、再初期化可能 |

## 次のステップ

Phase 3完了後、以下のフェーズに進む：

- **Phase 4**: ウェブメールシステム構築（Docker Compose使用）
- **Phase 5**: ブログ移行（WordPress on Docker）
- **Phase 6**: 商用サービス開発（学習システム等）
- **Phase 7**: AWS移行準備（Terraform設定、MGN準備）

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | - | - | - |
| インフラ担当 | - | - | - |

**END OF DOCUMENT**
