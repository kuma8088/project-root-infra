# 要件定義 - インフラストラクチャ

**作成者**: kuma8088（AWS認定ソリューションアーキテクト、ITストラテジスト）
**対象**: オンプレミス + クラウドハイブリッドインフラ

---

## 1. プロジェクト背景と目的

### 1.1 解決すべき課題

| 課題 | 詳細 | 影響 |
|-----|------|-----|
| レンタルサーバー依存 | Xserver等の外部サービスに依存 | コスト増、カスタマイズ制限 |
| 学習機会の欠如 | マネージドサービスでは運用スキルが身につかない | キャリア成長の阻害 |
| 柔軟性の欠如 | サービス仕様に縛られる | 将来の拡張が困難 |

### 1.2 プロジェクト目標

1. **自己ホスティング環境の構築** - メールサーバー、ブログシステムを自前で運用
2. **ハイブリッドクラウドの実践** - オンプレミス + AWS + SaaS の最適な組み合わせ
3. **運用スキルの獲得** - 本番環境での障害対応、セキュリティ対策の実践

---

## 2. 要件分析

### 2.1 機能要件

#### メールシステム
| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| M-001 | 複数ドメインでのメール送受信 | 必須 | ビジネス用途で複数ドメイン運用が必要 |
| M-002 | Webメールアクセス | 必須 | モバイル環境からのアクセス |
| M-003 | スパム/ウイルスフィルタリング | 必須 | セキュリティ要件 |
| M-004 | 送信ドメイン認証（SPF/DKIM/DMARC） | 必須 | メール到達率確保 |

#### ブログシステム
| 要件ID | 要件 | 優先度 | 判断理由 |
|--------|-----|--------|---------|
| B-001 | 複数WordPressサイトのホスティング | 必須 | 既存16サイトの移行 |
| B-002 | HTTPS対応 | 必須 | SEO、セキュリティ要件 |
| B-003 | 高可用性（99.9%以上） | 推奨 | ビジネスインパクト |

### 2.2 非機能要件

| カテゴリ | 要件 | 目標値 | 測定方法 |
|---------|-----|-------|---------|
| 可用性 | システム稼働率 | 99.9% | 月次ダウンタイム計測 |
| 性能 | メール配信遅延 | 5分以内 | 送受信タイムスタンプ差分 |
| 性能 | Webページ応答時間 | 3秒以内 | Lighthouse測定 |
| セキュリティ | パッチ適用 | 7日以内 | 脆弱性公開からの経過日数 |
| 運用性 | バックアップRPO | 24時間 | 日次バックアップ |
| 運用性 | 復旧RTO | 4時間 | 障害訓練で検証 |

### 2.3 セキュリティ要件

#### 多層防御（Defense in Depth）
| レイヤー | 要件 | 対策 |
|---------|------|------|
| エッジ | DDoS/WAF保護 | Cloudflare（L3/L4/L7防御、OWASP Top 10対策） |
| ネットワーク | ポート開放最小化 | Cloudflare Tunnel（Inboundポート開放不要） |
| アクセス制御 | VPN限定アクセス | Tailscale（IMAP/POP3/SMTPはVPN経由のみ） |
| アプリケーション | スパム/ウイルス対策 | Rspamd + ClamAV |
| データ | 改ざん・削除防止 | S3 Object Lock COMPLIANCE |

#### メール認証（なりすまし防止）
| 技術 | 要件 | 目的 |
|------|------|------|
| SPF | 送信サーバー認証 | 許可されたIPからの送信のみ許可 |
| DKIM | 電子署名 | メール改ざん検知 |
| DMARC | ポリシー制御 | 認証失敗メールの処理ルール |

#### アクセス制御
| 対象 | 要件 | 認証方式 |
|------|------|----------|
| Web（WordPress/Webmail） | 公開 | Cloudflare WAF経由 |
| IMAP/POP3/SMTP | VPN限定 | Tailscale登録デバイスのみ |
| SSH | 公開鍵のみ | パスワード認証無効、root禁止 |
| 管理ポータル | 内部のみ | ローカル/VPN |

### 2.4 ネットワーク要件

#### 自宅サーバー固有の制約と対策
| 制約 | 影響 | 要件 |
|------|------|------|
| ISPによるPort 25ブロック | メール受信不可 | Port 25以外でのMX受信手段 |
| 固定IPなし | DNS設定困難 | 動的IPでも安定したサービス公開 |
| ポート開放のリスク | 攻撃対象化 | Inboundポート開放なしでの公開 |
| SSL証明書管理 | 運用負荷 | 自動発行・更新 |

#### 通信経路要件
| 通信種別 | 要件 | 経路 |
|----------|------|------|
| Web公開（HTTPS） | CDN/WAF経由 | Cloudflare → Tunnel → Nginx |
| メール受信（MX） | Port 25不要 | Cloudflare Email → Worker → Tunnel → API |
| メールクライアント | VPN限定 | Tailscale → Dovecot/Postfix |
| メール送信 | 高到達率 | Postfix → SendGrid Relay |

### 2.5 バックアップ要件

#### 3-2-1ルール
| 要件 | 内容 |
|------|------|
| 3つのコピー | 本番データ + ローカルバックアップ + オフサイト |
| 2種類のメディア | SSD/HDD（ローカル）+ S3（クラウド） |
| 1つはオフサイト | AWS S3（物理的に別拠点） |

#### ランサムウェア対策
| 要件 | 対策 |
|------|------|
| バックアップ削除防止 | S3 Object Lock COMPLIANCE（管理者でも削除不可） |
| 保持期間 | 30日間（復旧猶予確保） |
| バージョニング | 全バージョン保持 |

#### RPO/RTO目標
| 指標 | 目標 | 実現方法 |
|------|------|----------|
| RPO（データ損失許容） | 24時間 | 日次バックアップ |
| RTO（復旧時間目標） | 4時間 | リストアスクリプト整備 |

### 2.6 可用性要件

#### 障害対策
| リスク | 影響度 | 対策 |
|-------|-------|------|
| 自宅停電 | 高 | UPS、Cloudflareでの一時保持 |
| ハードウェア障害 | 高 | 日次バックアップ、S3オフサイト |
| ネットワーク障害 | 中 | Cloudflare Tunnel自動再接続 |
| コンテナ障害 | 低 | Docker restart policy（自動再起動） |

---

## 3. トレードオフ分析

### 3.1 ホスティング方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **フルクラウド（AWS）** | 高可用性、スケーラビリティ | コスト高（月額$50-100+） | × |
| **フルオンプレミス** | コスト最小、完全制御 | 固定IP問題、可用性リスク | × |
| **ハイブリッド** | コスト最適化、柔軟性 | 複雑性増加 | ✓ |

**判断根拠**:
- 個人利用のため、フルクラウドのコストは過剰
- 自宅回線は固定IPなし → メール受信（Port 25）に制約
- **ハイブリッド構成でコストと機能のバランスを取る**

### 3.2 メール受信方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **EC2 MXゲートウェイ** | 標準的、実績あり | EC2コスト（月額$3程度）、OS/セキュリティパッチ運用負荷 | × |
| **Cloudflare Email Routing** | 無料、高信頼性 | Cloudflare依存 | ✓ |
| **AWS SES受信** | AWS統合 | 利用ハードル高（本番審査、サンドボックス検証済みアドレスのみ） | × |

**判断根拠**:
- 当初EC2を使用 → Cloudflare Email Routingに移行
- **コスト削減（月額$3→$0）+ 運用簡素化**
- Cloudflare Tunnel併用で統一的なアーキテクチャ

### 3.3 メール送信方式の選択

| 選択肢 | メリット | デメリット | 採用 |
|-------|---------|-----------|------|
| **直接送信** | コスト0 | IP評価問題、ブロックリスク | × |
| **SendGrid Relay** | 高到達率、無料枠あり | 外部依存 | ✓ |
| **AWS SES** | AWS統合 | 利用ハードル高（本番審査、サンドボックス検証済みアドレスのみ） | × |

**判断根拠**:
- 自宅IPからの直接送信はスパム判定リスクが高い
- SendGridは100通/日まで無料、SPF/DKIM/DMARC管理が容易
- **到達率優先でSendGrid採用**

---

## 4. 教訓と改善点

### 当初の失敗と学び

1. **AWS Fargate採用 → EC2へ変更**
   - 問題: FargateコンテナからTailscale VPNへのアクセス制限
   - 学び: サーバーレスの制約を事前に検証すべき

2. **EC2 MXゲートウェイ → Cloudflare Email Routing**
   - 問題: EC2維持コスト、運用負荷
   - 学び: マネージドサービスの活用でコア業務に集中

**原則**: 「動くものを作る → 運用しながら最適化」のイテレーティブアプローチ
