# メールサーバー構築プロジェクト - テスト手順書

**文書バージョン**: 2.0
**作成日**: 2025-11-01
**対象環境**: Dell RockyLinux 9.6 + Docker Compose + Tailscale VPN
**テスト実施者**:

---

## ⚠️ 重要な変更（v2.0 - Tailscale VPN対応）

**このテスト手順書はTailscale VPN前提のメールサーバー環境に対応しています。**

### v2.0での主要変更点:
- ✅ **Tailscale VPN接続必須**: 全てのテストはTailscale VPNクライアント起動が前提
- ✅ **MagicDNSホスト名使用**: `mail.example.com` → `mailserver.tail<xxxxx>.ts.net`
- ✅ **Tailscale HTTPS証明書**: Let's Encrypt証明書 → Tailscale自動プロビジョニング証明書
- ✅ **VPN-only Access**: インターネット経由の直接アクセス不可（Port 25を除く）
- ❌ **外部ポートスキャン削除**: VPN-onlyアクセスのためポートスキャンテスト不要

---

## 📋 目次

1. [テスト概要](#1-テスト概要)
2. [事前準備](#2-事前準備)
3. [機能テスト](#3-機能テスト)
4. [セキュリティテスト](#4-セキュリティテスト)
5. [パフォーマンステスト](#5-パフォーマンステスト)
6. [運用テスト](#6-運用テスト)
7. [結果記録](#7-結果記録)

---

## 1. テスト概要

### 1.1 テスト目的

構築したメールサーバーが要件定義書（01_requirements.md）で定義された機能要件・非機能要件を満たしていることを確認する。

### 1.2 テスト範囲

| カテゴリ | テスト項目数 | 所要時間 |
|---------|------------|---------|
| **機能テスト** | 15項目 | 約60分 |
| **セキュリティテスト** | 9項目 | 約30分 |
| **パフォーマンステスト** | 8項目 | 約30分 |
| **運用テスト** | 5項目 | 約30分 |
| **合計** | 37項目 | 約150分 |

### 1.3 合格基準

- **必須テスト（🔴）**: 100%合格必須
- **推奨テスト（🟡）**: 80%以上合格推奨
- **任意テスト（🟢）**: 参考情報

---

## 2. 事前準備

### 2.1 Tailscale接続確認

#### テスト 2.1.1: Tailscale接続確認テスト（🔴必須）

**目的**: テスト実施前にTailscale VPN接続が正常であることを確認

**手順**:
1. Tailscaleクライアント起動確認
   ```bash
   tailscale status
   ```
2. メールサーバーへの接続確認
   ```bash
   tailscale ping mailserver
   ```
3. MagicDNS名前解決確認
   ```bash
   ping -c 3 mailserver.tail<xxxxx>.ts.net
   ```

**期待結果**:
- ✅ Tailscaleクライアント起動中
- ✅ メールサーバーへのping成功
- ✅ MagicDNS名前解決成功

**実施結果**: [ 合格 / 不合格 ]

---

### 2.2 テスト環境確認

```bash
# Tailscale経由でサーバー接続確認（VPN必須）
ssh user@mailserver.tail<xxxxx>.ts.net

# 作業ディレクトリ移動
cd /opt/mailserver

# コンテナ稼働状況確認
docker compose ps
```

**✅ チェックポイント**:
- [ ] Tailscale VPN接続確認完了
- [ ] 全コンテナが `healthy` または `running` 状態
- [ ] MagicDNS名前解決が正常動作
- [ ] Tailscale証明書が有効

### 2.3 テストアカウント作成

```bash
# テスト用ユーザー作成（まだ作成していない場合）
/opt/mailserver/scripts/add-user.sh testuser1@example.com TestPass123!
/opt/mailserver/scripts/add-user.sh testuser2@example.com TestPass456!
```

### 2.4 外部メールアドレス準備

- Gmail、Yahoo!メール、Outlookなど外部メールアドレスを準備
- テストメール送受信に使用

---

## 3. 機能テスト

### 3.1 メール送信テスト（SMTP）

#### テスト 3.1.1: Port 587 SMTP認証送信（🔴必須）

**目的**: SMTP認証経由でメール送信できることを確認

**手順**:
1. メールクライアント（Thunderbird/Outlook/スマホアプリ）を開く
2. アカウント設定:
   - **メールアドレス**: testuser1@example.com
   - **受信サーバー**: mailserver.tail<xxxxx>.ts.net (IMAP, Port 993, SSL/TLS)
   - **送信サーバー**: mailserver.tail<xxxxx>.ts.net (SMTP, Port 587, STARTTLS)
   - **認証**: 必要
   - **ユーザー名**: testuser1@example.com
   - **パスワード**: TestPass123!
3. 外部アドレス（Gmail等）にテストメール送信

**⚠️ Tailscale VPN接続必須（VPNクライアント起動していない場合はアクセス不可）**

**期待結果**:
- ✅ メール送信成功
- ✅ エラーメッセージなし
- ✅ 5分以内に外部アドレスで受信

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.1.2: Port 465 SMTPS送信（🟡推奨）

**目的**: SMTP over SSL経由でメール送信できることを確認

**手順**:
1. メールクライアントの送信サーバー設定変更
   - **Port**: 465
   - **暗号化**: SSL/TLS
2. 外部アドレスにテストメール送信

**期待結果**:
- ✅ メール送信成功

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.1.3: 大容量添付ファイル送信（🔴必須）

**目的**: 1GB添付ファイルを送信できることを確認

**手順**:
1. 100MBのテストファイル作成
   ```bash
   dd if=/dev/zero of=test_100mb.bin bs=1M count=100
   ```
2. WEBメールまたはクライアントで添付ファイル付きメール送信

**期待結果**:
- ✅ 100MB添付ファイル送信成功
- ✅ エラーメッセージなし

**実施結果**: [ 合格 / 不合格 ]

---

### 3.2 メール受信テスト（IMAP/POP3）

#### テスト 3.2.1: IMAP受信（Port 993）（🔴必須）

**目的**: IMAP over SSL経由でメール受信できることを確認

**手順**:
1. 外部アドレスから testuser1@example.com にメール送信
2. メールクライアント（IMAP設定）で受信確認

**期待結果**:
- ✅ 5分以内にメール受信
- ✅ メール本文・件名が正しく表示
- ✅ 日本語文字化けなし

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.2.2: POP3受信（Port 995）（🟡推奨）

**目的**: POP3 over SSL経由でメール受信できることを確認

**手順**:
1. メールクライアントの受信サーバー設定変更
   - **プロトコル**: POP3
   - **Port**: 995
   - **暗号化**: SSL/TLS
2. メール受信確認

**期待結果**:
- ✅ メール受信成功

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.2.3: 複数デバイス同期（IMAP）（🟡推奨）

**目的**: IMAPで複数デバイス間でメール同期できることを確認

**手順**:
1. デバイスA（PC）でメールを読む
2. デバイスB（スマホ）で同じメールボックスを確認
3. 既読状態が同期されていることを確認

**期待結果**:
- ✅ 既読/未読状態が同期
- ✅ フォルダ構成が同期

**実施結果**: [ 合格 / 不合格 ]

---

### 3.3 WEBメール機能テスト

#### テスト 3.3.1: WEBメールログイン（🔴必須）

**目的**: HTTPSでWEBメールにログインできることを確認

**手順**:
1. ブラウザで `https://mailserver.tail<xxxxx>.ts.net` にアクセス
2. ログイン情報入力:
   - **ユーザー名**: testuser1@example.com
   - **パスワード**: TestPass123!
3. ログイン実行

**⚠️ Tailscale VPN接続必須（VPNクライアント起動していない場合はアクセス不可）**

**期待結果**:
- ✅ SSL証明書エラーなし（Tailscale証明書）
- ✅ ログイン成功
- ✅ 受信トレイ表示（3秒以内）

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.3.2: WEBメールでメール作成・送信（🔴必須）

**目的**: WEBメールからメール送信できることを確認

**手順**:
1. WEBメールで「新規作成」をクリック
2. 宛先、件名、本文を入力
3. 送信ボタンをクリック

**期待結果**:
- ✅ メール送信成功
- ✅ 送信済みフォルダに保存

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.3.3: WEBメールで添付ファイル（🔴必須）

**目的**: WEBメールから添付ファイル付きメール送信できることを確認

**手順**:
1. 10MBのファイルを添付してメール送信
2. 受信側で添付ファイルダウンロード

**期待結果**:
- ✅ 添付ファイル送信成功
- ✅ ダウンロード可能

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.3.4: WEBメールUI日本語表示（🔴必須）

**目的**: WEBメールが日本語で表示されることを確認

**手順**:
1. WEBメール画面を確認
2. 日本語メール送受信

**期待結果**:
- ✅ UI が日本語表示
- ✅ 日本語メールが文字化けなし

**実施結果**: [ 合格 / 不合格 ]

---

### 3.4 複数ドメインテスト

#### テスト 3.4.1: 別ドメイン追加（🔴必須）

**目的**: 複数ドメインでメールアドレスを作成できることを確認

**手順**:
1. 2つ目のドメイン（example2.com）のDNS設定実行
2. DKIM鍵生成
   ```bash
   /opt/mailserver/scripts/generate-dkim.sh example2.com
   ```
3. ユーザー作成
   ```bash
   /opt/mailserver/scripts/add-user.sh testuser@example2.com TestPass789!
   ```
4. メール送受信テスト

**期待結果**:
- ✅ 新ドメインでメール送受信可能

**実施結果**: [ 合格 / 不合格 ]

---

### 3.5 認証テスト

#### テスト 3.5.1: 誤パスワードでログイン失敗（🔴必須）

**目的**: 誤ったパスワードでログインできないことを確認

**手順**:
1. WEBメールに誤パスワードでログイン試行

**期待結果**:
- ✅ ログイン拒否
- ✅ エラーメッセージ表示

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 3.5.2: SMTP認証なし送信拒否（🔴必須）

**目的**: SMTP認証なしでメール送信できないことを確認

**手順**:
1. SMTP認証設定をオフにしてメール送信試行

**期待結果**:
- ✅ 送信拒否
- ✅ 認証エラーメッセージ

**実施結果**: [ 合格 / 不合格 ]

---

## 4. セキュリティテスト

### 4.1 SSL/TLS接続テスト

#### テスト 4.1.1: HTTPS接続（🔴必須）

**目的**: HTTPS接続が正常に動作することを確認

**手順**:
```bash
curl -I https://mailserver.tail<xxxxx>.ts.net
```

**期待結果**:
- ✅ HTTP/2 200 OK
- ✅ SSL証明書有効（Tailscale証明書）
- ✅ TLS 1.2 以上

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 4.1.2: SSL証明書検証（🔴必須）

**目的**: Tailscale SSL証明書が正しく設定されていることを確認

**手順**:
```bash
openssl s_client -connect mailserver.tail<xxxxx>.ts.net:443 -showcerts < /dev/null
```

**期待結果**:
- ✅ Verify return code: 0 (ok)
- ✅ Tailscale-issued certificate（Let's Encryptではない）
- ✅ 有効期限内
- ✅ 正しいMagicDNSホスト名

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 4.1.3: 平文プロトコル無効化（🔴必須）

**目的**: 平文（非SSL）接続が無効化されていることを確認

**注**: Tailscale VPN環境でも平文プロトコルは無効化されています

**手順**:
```bash
# IMAP平文接続試行（Port 143）- 失敗するはず
telnet mailserver.tail<xxxxx>.ts.net 143

# POP3平文接続試行（Port 110）- 失敗するはず
telnet mailserver.tail<xxxxx>.ts.net 110
```

**期待結果**:
- ✅ Port 143 接続拒否または強制STARTTLS
- ✅ Port 110 接続拒否または強制STARTTLS

**実施結果**: [ 合格 / 不合格 ]

---

### 4.2 送信ドメイン認証テスト

#### テスト 4.2.1: SPF設定確認（🔴必須）

**目的**: SPFレコードが正しく設定されていることを確認

**注**: Tailscale VPN環境ではSPFは外部メール受信時のみ関連（外部SMTP Relay経由送信のため）

**手順**:
```bash
dig TXT example.com | grep spf
```

**期待結果**:
- ✅ SPFレコード存在
- ✅ 外部SMTP Relay（Gmail/SendGrid/Mailgun）のIPが含まれている

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 4.2.2: DKIM署名確認（🔴必須）

**目的**: 送信メールにDKIM署名が付与されることを確認

**手順**:
1. 外部アドレス（Gmail等）にテストメール送信
2. 受信メールのヘッダーを確認
3. `DKIM-Signature:` ヘッダーが存在するか確認

**期待結果**:
- ✅ DKIM署名ヘッダー存在
- ✅ `d=example.com` が含まれる

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 4.2.3: DMARC設定確認（🔴必須）

**目的**: DMARCレコードが正しく設定されていることを確認

**手順**:
```bash
dig TXT _dmarc.example.com
```

**期待結果**:
- ✅ DMARCレコード存在
- ✅ `v=DMARC1` が含まれる

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 4.2.4: メール認証統合テスト（🔴必須）

**目的**: SPF/DKIM/DMARCが統合的に動作することを確認

**手順**:
1. https://www.mail-tester.com/ にアクセス
2. 表示されたテストアドレスにメール送信
3. スコア確認

**期待結果**:
- ✅ スコア 8/10 以上
- ✅ SPF: Pass
- ✅ DKIM: Pass
- ✅ DMARC: Pass

**実施結果**: [ 合格 / 不合格 / スコア: ___/10 ]

---

### 4.3 アクセス制御テスト

#### テスト 4.3.1: ファイアウォール設定確認（🔴必須）

**目的**: 必要なポートとTailscaleサービスが有効化されていることを確認

**手順**:
```bash
sudo firewall-cmd --list-all
```

**期待結果**:
- ✅ Tailscaleサービス有効: tailscale
- ✅ メールサービス開放: smtp, submission, imaps, pop3s, https
- ✅ Port 25（外部SMTP受信）は条件付き開放

**実施結果**: [ 合格 / 不合格 ]

---

### 4.4 スパム対策テスト

#### テスト 4.4.1: 不正中継拒否（🔴必須）

**目的**: 第三者中継（Open Relay）が無効化されていることを確認

**手順**:
```bash
# 外部ドメイン同士のメール送信試行（認証なし）
telnet mailserver.tail<xxxxx>.ts.net 25
HELO test
MAIL FROM: attacker@external.com
RCPT TO: victim@another-domain.com
# 拒否されるはず
```

**期待結果**:
- ✅ `Relay access denied` エラー
- ✅ 送信拒否

**実施結果**: [ 合格 / 不合格 ]

---

## 5. パフォーマンステスト

### 5.1 レスポンステスト

#### テスト 5.1.1: WEBメール初回表示時間（🔴必須）

**目的**: WEBメール画面が3秒以内に表示されることを確認

**注**: Tailscale VPN経由のため、ネットワーク遅延は通常のインターネット接続より改善される可能性あり

**手順**:
1. ブラウザの開発者ツールを開く
2. ネットワークタブで読み込み時間を計測
3. `https://mailserver.tail<xxxxx>.ts.net` にアクセス

**期待結果**:
- ✅ 初回表示 3秒以内

**実施結果**: [ 合格 / 不合格 / 表示時間: ___秒 ]

---

#### テスト 5.1.2: メール送信完了時間（🟡推奨）

**目的**: メール送信が5分以内に完了することを確認

**手順**:
1. テストメール送信
2. 送信完了から受信までの時間を計測

**期待結果**:
- ✅ 送信完了 5分以内

**実施結果**: [ 合格 / 不合格 / 送信時間: ___分 ]

---

### 5.2 負荷テスト

#### テスト 5.2.1: 同時接続テスト（🟡推奨）

**目的**: 5名が同時にログインできることを確認

**手順**:
1. 5つのブラウザタブで同時にWEBメールログイン
2. 各タブで基本操作実行

**期待結果**:
- ✅ 全タブでログイン成功
- ✅ 操作遅延なし

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 5.2.2: 大量メール受信（🟢任意）

**目的**: 100通/日のメール処理能力を確認

**手順**:
1. 外部から50通のテストメール送信
2. すべて受信できることを確認

**期待結果**:
- ✅ 全メール受信
- ✅ サーバー負荷正常

**実施結果**: [ 合格 / 不合格 ]

---

### 5.3 容量テスト

#### テスト 5.3.1: メールボックス容量確認（🟡推奨）

**目的**: 2GB/ユーザーの容量制限が機能することを確認

**手順**:
```bash
# メールボックス容量確認
du -sh /opt/mailserver/data/mail/example.com/testuser1/
```

**期待結果**:
- ✅ 容量制限設定確認
- ✅ 容量超過時の警告/拒否動作

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 5.3.2: ディスク容量監視（🟡推奨）

**目的**: ディスク容量が十分であることを確認

**手順**:
```bash
df -h /opt/mailserver/
```

**期待結果**:
- ✅ 使用率 70%以下
- ✅ 空き容量 10GB以上

**実施結果**: [ 合格 / 不合格 / 使用率: ___%  ]

---

## 6. 運用テスト

### 6.1 バックアップ・リストアテスト

#### テスト 6.1.1: バックアップ実行（🔴必須）

**目的**: バックアップスクリプトが正常に動作することを確認

**手順**:
```bash
/opt/mailserver/scripts/backup.sh
ls -lh /opt/mailserver/backups/
```

**期待結果**:
- ✅ バックアップファイル作成
- ✅ mail_*.tar.gz, db_*.sql 存在

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 6.1.2: リストア実行（🟡推奨）

**目的**: バックアップからデータ復元できることを確認

**手順**:
1. テストメールを削除
2. バックアップから復元
   ```bash
   tar -xzf /opt/mailserver/backups/mail_<DATE>.tar.gz -C /opt/mailserver/data/
   docker compose restart dovecot
   ```
3. メールが復元されていることを確認

**期待結果**:
- ✅ データ復元成功
- ✅ メール再表示

**実施結果**: [ 合格 / 不合格 ]

---

### 6.2 自動化テスト

#### テスト 6.2.1: Tailscale証明書自動更新（🔴必須）

**目的**: Tailscale SSL証明書が自動更新されることを確認

**注**: Certbot更新テストはv2.0で削除（Tailscale証明書自動プロビジョニングに変更）

**手順**:
```bash
# Tailscale証明書更新スクリプト実行
/opt/mailserver/scripts/tailscale-renew.sh

# 証明書確認
ls -la /var/lib/tailscale/certs/
openssl x509 -in /var/lib/tailscale/certs/mailserver.tail<xxxxx>.ts.net.crt -noout -dates
```

**期待結果**:
- ✅ 証明書自動更新成功
- ✅ 有効期限が延長されている
- ✅ エラーなし

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 6.2.2: ログローテーション（🟡推奨）

**目的**: ログが適切にローテーションされることを確認

**手順**:
```bash
# ログファイル確認
ls -lh /opt/mailserver/logs/postfix/
ls -lh /opt/mailserver/logs/nginx/
```

**期待結果**:
- ✅ ログファイル存在
- ✅ 古いログが圧縮されている

**実施結果**: [ 合格 / 不合格 ]

---

### 6.3 ユーザー管理テスト

#### テスト 6.3.1: ユーザー追加（🔴必須）

**目的**: 管理スクリプトでユーザー追加できることを確認

**手順**:
```bash
/opt/mailserver/scripts/add-user.sh newuser@example.com NewPass123!
```

**期待結果**:
- ✅ ユーザー追加成功
- ✅ メール送受信可能

**実施結果**: [ 合格 / 不合格 ]

---

#### テスト 6.3.2: パスワード変更（🟡推奨）

**目的**: ユーザーパスワードを変更できることを確認

**手順**:
1. Dovecot usersファイルのハッシュ値を変更
2. ログインテスト

**期待結果**:
- ✅ パスワード変更成功
- ✅ 新パスワードでログイン可能

**実施結果**: [ 合格 / 不合格 ]

---

## 7. 結果記録

### 7.1 テスト結果サマリー

| カテゴリ | 合格 | 不合格 | スキップ | 合格率 |
|---------|------|--------|---------|--------|
| **機能テスト** | ___/15 | ___/15 | ___/15 | ___%  |
| **セキュリティテスト** | ___/9 | ___/9 | ___/9 | ___% |
| **パフォーマンステスト** | ___/8 | ___/8 | ___/8 | ___% |
| **運用テスト** | ___/5 | ___/5 | ___/5 | ___% |
| **合計** | ___/37 | ___/37 | ___/37 | ___% |

### 7.2 総合評価

**システム稼働判定**: [ ✅ 本番稼働可 / ⚠️ 条件付き稼働可 / ❌ 稼働不可 ]

**判定基準**:
- ✅ 本番稼働可: 必須テスト100%合格、推奨テスト80%以上合格
- ⚠️ 条件付き稼働可: 必須テスト100%合格、推奨テスト60%以上合格
- ❌ 稼働不可: 必須テスト不合格あり

### 7.3 不合格項目と対策

| テストID | 不合格内容 | 原因 | 対策 | 対応予定日 |
|---------|----------|------|------|----------|
|  |  |  |  |  |
|  |  |  |  |  |

### 7.4 改善推奨事項

| 優先度 | 推奨事項 | 期待効果 | 実施予定 |
|--------|---------|---------|---------|
|  |  |  |  |
|  |  |  |  |

---

## 8. 次のアクション

テストが完了したら、以下を実施してください：

### 8.1 必須テスト不合格時
1. 不合格原因の調査
2. 構築手順書の該当箇所を確認
3. 設定修正・再テスト
4. 再度テスト実施

### 8.2 全テスト合格時
1. 本番運用開始
2. 定期メンテナンス計画作成
3. 監視・アラート設定（必要に応じて）
4. ドキュメント最終化

### 8.3 継続的改善
1. スパム対策強化（SpamAssassin/ClamAV導入）
2. 監視ツール導入（Prometheus/Grafana等）
3. セキュリティ監査の定期実施
4. パフォーマンスチューニング

---

## 9. 承認

| 役割 | 氏名 | テスト日 | 署名 |
|------|------|---------|------|
| テスト実施者 |  |  |  |
| テスト確認者 |  |  |  |
| 承認者 |  |  |  |

---

**文書改訂履歴**

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2025-10-31 | 初版作成 | Claude |
| 2.0 | 2025-11-01 | Tailscale VPN対応（MagicDNSホスト名、Tailscale証明書、VPN-only Access、外部ポートスキャン削除） | Claude |
