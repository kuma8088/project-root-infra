# Docker基盤環境 統合テスト・検証手順書

## 概要

本手順書は、Phase 3で構築したDocker基盤環境（Docker Engine + Docker Compose + Docker Swarm + ストレージ/バックアップ + 監視/セキュリティ）が正常に動作し、要件定義書で定めた成功基準を満たしていることを検証する手順を記載します。

## 前提条件

以下の手順書が完了していること：

- **3.1-docker-environment-setup.md**: Docker環境構築完了
- **3.2-storage-backup-setup.md**: ストレージ・バックアップ設定完了
- **3.3-monitoring-security-setup.md**: 監視・セキュリティ設定完了

## 検証スコープ

以下の6つの要件に対する統合テストを実施します：

1. **要件1**: Docker基盤環境の構築（Docker Engine + Compose + Swarm）
2. **要件2**: ストレージ管理とバックアップ
3. **要件3**: 監視・ロギング（最小構成）
4. **要件4**: セキュリティ基盤
5. **要件5**: リソース配分管理
6. **要件6**: Docker Swarm初期化（将来拡張準備）

## 推定所要時間

- **基本検証**: 30分
- **統合テスト**: 45分
- **負荷テスト**: 30分
- **合計**: 約105分（1時間45分）

---

## セクション1: Docker基盤環境の検証

### 1.1 Docker Engineバージョン確認

**目的**: Docker Engineが最新安定版でインストールされていることを確認

**コマンド**:
```bash
docker --version
docker info
```

**期待される出力**:
```
Docker version 24.0.x, build xxxxx

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 24.0.x
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
 Logging Driver: json-file
 Cgroup Driver: systemd
 Cgroup Version: 2
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog
 Swarm: active
  NodeID: xxxxxxxxx
  Is Manager: true
  ClusterID: xxxxxxxxx
  Managers: 1
  Nodes: 1
 Docker Root Dir: /data/docker
 Live Restore Enabled: false # Swarmはコンテナの起動・停止を自身で管理するため、live-restore による「デーモン再起動時もコンテナ維持」機能と競合する。
```

**検証ポイント**:
- ✅ Docker version が 24.0.x 以上
- ✅ Storage Driver が `overlay2`
- ✅ Docker Root Dir が `/data/docker`（HDD領域）
- ✅ Swarm が `active` かつ `Is Manager: true`
- ✅ Live Restore が `Enabled: false`

### 1.2 Docker Composeバージョン確認

**コマンド**:
```bash
docker compose version
```

**期待される出力**:
```
Docker Compose version v2.x.x
```

**検証ポイント**:
- ✅ Docker Compose v2系がインストールされている

### 1.3 Dockerサービス自動起動確認

**コマンド**:
```bash
sudo systemctl status docker
sudo systemctl is-enabled docker
```

**期待される出力**:
```
● docker.service - Docker Application Container Engine
     Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)
     Active: active (running) since ...
...

enabled
```

**検証ポイント**:
- ✅ Active: `active (running)`
- ✅ Enabled: `enabled`

### 1.4 Dockerグループ所属確認

**コマンド**:
```bash
groups $USER | grep docker
docker ps  # sudo不要で実行できることを確認
```

**期待される出力**:
```
wheel docker
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
```

**検証ポイント**:
- ✅ ユーザーが `docker` グループに所属している
- ✅ `sudo` なしで `docker ps` が実行できる

### 1.5 Dockerネットワーク独立性確認

**コマンド**:
```bash
docker network ls
ip addr show docker0
virsh net-list --all  # libvirtネットワークと比較
```

**期待される出力**:
```
NETWORK ID     NAME              DRIVER    SCOPE
xxxxxxxxxxxx   bridge            bridge    local
xxxxxxxxxxxx   host              host      local
xxxxxxxxxxxx   none              null      local
xxxxxxxxxxxx   ingress           overlay   swarm
xxxxxxxxxxxx   docker_gwbridge   bridge    local

5: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0

 Name      State    Autostart   Persistent
--------------------------------------------
 default   active   yes         yes
```

**検証ポイント**:
- ✅ Docker bridge が `172.17.0.0/16` セグメントを使用
- ✅ libvirt networks が `10.0.x.0/24` セグメントを使用
- ✅ Docker と libvirt のネットワークが独立している

### 1.6 Docker daemon.json設定確認

**コマンド**:
```bash
cat /etc/docker/daemon.json
```

**期待される出力**:
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "data-root": "/data/docker",
  "live-restore": false,
  "userland-proxy": false,
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  }
}
```

**検証ポイント**:
- ✅ `data-root` が `/data/docker`
- ✅ `storage-driver` が `overlay2`
- ✅ `live-restore` が `false`
- ✅ ログローテーション設定が適用されている

---

## セクション2: ストレージ・バックアップ検証

### 2.1 Dockerストレージ配置確認

**コマンド**:
```bash
df -h /var/lib/docker /data/docker
ls -la /var/lib/docker/
ls -la /data/docker/
```

**期待される出力**:
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        50G   5G   45G  10% /               # /var/lib/dockerはルートパーティション
/dev/sdb1       3.6T  100G  3.4T   3% /data          # /data/dockerはHDDパーティション

/var/lib/docker/:
(システム用Dockerファイルが格納されている)

/data/docker/:
drwx--x--x. 4 root root   4096 ... buildkit
drwx--x---. 2 root root   4096 ... containers
drwx------. 3 root root   4096 ... image
drwxr-x---. 3 root root   4096 ... network
drwx--x---. 2 root root   4096 ... overlay2
drwx------. 4 root root   4096 ... plugins
drwx------. 2 root root   4096 ... swarm
drwx------. 2 root root   4096 ... tmp
drwx------. 2 root root   4096 ... volumes
```

**検証ポイント**:
- ✅ `/data/docker` が HDD パーティション（/dev/sdb1）にマウントされている
- ✅ ストレージ使用率が80%未満

### 2.2 外付けHDDマウント確認

**コマンド**:
```bash
mount | grep /mnt/backup-hdd
df -h /mnt/backup-hdd
cat /etc/fstab | grep backup-hdd
```

**期待される出力**:
```
/dev/sdc1 on /mnt/backup-hdd type ext4 (rw,relatime)

Filesystem      Size  Used Avail Use% Mounted on
/dev/sdc1       1.8T   50G  1.7T   3% /mnt/backup-hdd

UUID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx /mnt/backup-hdd ext4 defaults,nofail 0 2
```

**検証ポイント**:
- ✅ 外付けHDDが `/mnt/backup-hdd` にマウントされている
- ✅ `/etc/fstab` に自動マウント設定が追加されている
- ✅ `nofail` オプションが設定されている（外付けHDD未接続でも起動可能）

### 2.3 バックアップスクリプト存在確認

**コマンド**:
```bash
ls -l /usr/local/bin/docker-backup.sh
cat /usr/local/bin/docker-backup.sh | head -20
crontab -l | grep docker-backup
```

**期待される出力**:
```
-rwxr-xr-x. 1 root root 2345 ... /usr/local/bin/docker-backup.sh

#!/bin/bash
# Docker基盤環境バックアップスクリプト
...

0 2 * * 0 /usr/local/bin/docker-backup.sh
```

**検証ポイント**:
- ✅ バックアップスクリプトが `/usr/local/bin/` に配置されている
- ✅ 実行権限が付与されている（`-rwxr-xr-x`）
- ✅ cronで週1回（日曜2時）自動実行される設定

### 2.4 バックアップ手動実行テスト

**コマンド**:
```bash
# テスト用Dockerボリュームを作成
docker volume create test-volume
docker run --rm -v test-volume:/data alpine sh -c "echo 'backup test data' > /data/test.txt"

# バックアップスクリプトを手動実行
sudo /usr/local/bin/docker-backup.sh

# バックアップファイルの確認
BACKUP_DATE=$(date +\%Y\%m\%d)
ls -lh /mnt/backup-hdd/docker/$BACKUP_DATE/
ls -lh /mnt/backup-hdd/docker/$BACKUP_DATE/volumes/test-volume/_data/
sudo tail -20 /var/log/docker-backup.log
```

**期待される出力**:
```
/mnt/backup-hdd/docker/20240115/:
drwx------. 3 root root 4.0K ... volumes
drwx------. 2 root root 4.0K ... images
drwx------. 2 root root 4.0K ... compose
drwx------. 2 root root 4.0K ... swarm
-rw-------. 1 root root 1.2K ... checksums.md5

/mnt/backup-hdd/docker/20240115/volumes/test-volume/_data/:
-rw-r--r--. 1 root root 16 ... test.txt

[2024-01-15 14:30:01] === Docker Backup Started ===
[2024-01-15 14:30:05] Backing up Docker volumes...
[2024-01-15 14:30:06] Volumes backup completed
[2024-01-15 14:30:30] === Docker Backup Completed ===
```

**検証ポイント**:
- ✅ バックアップファイルが作成されている
- ✅ ログファイルに成功メッセージが記録されている
- ✅ バックアップ実行時間が30分以内

### 2.5 バックアップ復元テスト

**コマンド**:
```bash
# テストボリュームを削除
docker volume rm test-volume

# バックアップから復元
BACKUP_DATE=$(date +\%Y\%m\%d)
docker volume create test-volume
sudo rsync -av /mnt/backup-hdd/docker/$BACKUP_DATE/volumes/test-volume/_data/ \
    /data/docker/volumes/test-volume/_data/

# 復元確認
docker volume ls | grep test-volume
docker run --rm -v test-volume:/data alpine cat /data/test.txt
```

**期待される出力**:
```
DRIVER    VOLUME NAME
local     test-volume

backup test data
```

**検証ポイント**:
- ✅ バックアップからボリュームが復元できる
- ✅ 復元したデータが正しく読み込める

---

## セクション3: 監視・ロギング検証

### 3.1 systemd journald ログ収集確認

**コマンド**:
```bash
sudo journalctl -u docker --since "1 hour ago" --no-pager | head -20
```

**期待される出力**:
```
Jan 15 14:00:01 workstation dockerd[1234]: time="2024-01-15T14:00:01Z" level=info msg="API listen on /var/run/docker.sock"
Jan 15 14:05:23 workstation dockerd[1234]: time="2024-01-15T14:05:23Z" level=info msg="Container started" container=nginx_test
...
```

**検証ポイント**:
- ✅ Dockerサービスのログが journald に記録されている
- ✅ ログのタイムスタンプが正確

### 3.2 logwatch 設定確認

**コマンド**:
```bash
rpm -qa | grep logwatch
ls -l /etc/cron.daily/0logwatch
ls -l /etc/logwatch/scripts/services/docker
sudo /usr/sbin/logwatch --detail High --service docker --range today --output stdout | head -50
```

**期待される出力**:
```
logwatch-7.x.x-x.el9.noarch

-rwxr-xr-x. 1 root root 123 ... /etc/cron.daily/0logwatch

-rwxr-xr-x. 1 root root 456 ... /etc/logwatch/scripts/services/docker

################### Logwatch 7.x.x (MM/DD/YY) ####################
        Processing Initiated: Mon Jan 15 14:30:01 2024
        Date Range Processed: today
        Detail Level of Output: High
        Type of Output/Format: stdout / text
        Logfiles for Host: workstation.example.com

 --------------------- Docker Begin ------------------------

 Container Started: 5 events
 Container Stopped: 3 events
 Image Pulled: 2 events

 ---------------------- Docker End -------------------------

（Dockerイベントが発生していない場合は、各カウンタが `0 events` か `No Docker events recorded for the selected range.` と表示されても成功とみなす）
```

**検証ポイント**:
- ✅ logwatch パッケージがインストールされている
- ✅ 日次実行が cron.daily に設定されている
- ✅ Docker ログ解析スクリプトが配置され、実行権限がある
- ✅ Docker ログが解析されている（0件でもエラーが出なければ合格）
- ⚠️ `Logwatch does not know how to process service: docker` が表示された場合は `/etc/logwatch/scripts/services/docker` の有無と実行権限を確認し、必要に応じて再配置する

### 3.3 Discord Webhook通知テスト

**コマンド**:
```bash
# テスト通知を送信
/usr/local/bin/send-alert.sh "統合テスト: Discord通知テスト"

# fail2ban経由でのテスト（別の端末から意図的に失敗ログイン）
```

**期待される動作**:
- ✅ Discordチャンネルに通知メッセージが届く
- ✅ メッセージにホスト名、重要度、内容が含まれている

### 3.4 システムリソース監視スクリプト確認

**コマンド**:
```bash
ls -l /usr/local/bin/system-monitor.sh
sudo grep system-monitor /var/log/cron
sudo /usr/local/bin/system-monitor.sh
```

**期待される出力**:
```
-rwxr-xr-x. 1 root root 1234 ... /usr/local/bin/system-monitor.sh

*/10 * * * * /usr/local/bin/system-monitor.sh

(通常時は出力なし、閾値超過時のみアラート)
```

**検証ポイント**:
- ✅ 監視スクリプトが配置されている
- ✅ 10分間隔で自動実行される設定
- ✅ CPU/メモリ/ディスク使用率を監視している

---

## セクション4: セキュリティ基盤検証

### 4.1 SSH公開鍵認証確認

**コマンド**:
```bash
sudo sshd -T | egrep 'permitrootlogin|pubkeyauthentication|passwordauthentication'
```

**期待される出力**:
```
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication no
```

**検証ポイント**:
- ✅ root ログイン禁止
- ✅ 公開鍵認証有効
- ✅ パスワード認証無効

**セキュリティテスト**（別のクライアント端末から）:
```bash
# パスワード認証でログインを試みる（失敗することを確認）
ssh -o PubkeyAuthentication=no user@workstation

# 公開鍵認証でログインできることを確認
ssh user@workstation
```

**期待される動作**:
- ✅ パスワード認証はブロックされる
- ✅ 公開鍵認証でログインできる

### 4.2 fail2ban動作確認

**コマンド**:
```bash
sudo systemctl status fail2ban
sudo fail2ban-client status
sudo fail2ban-client status sshd
```

**期待される出力**:
```
● fail2ban.service - Fail2Ban Service
     Loaded: loaded (/usr/lib/systemd/system/fail2ban.service; enabled; vendor preset: disabled)
     Active: active (running) since ...

Status
|- Number of jail:      1
`- Jail list:   sshd

Status for the jail: sshd
|- Filter
|  |- Currently failed: 0
|  |- Total failed:     0
|  `- File list:        /var/log/secure
`- Actions
   |- Currently banned: 0
   |- Total banned:     0
   `- Banned IP list:
```

**検証ポイント**:
- ✅ fail2ban サービスが起動している
- ✅ sshd jail が有効化されている

**fail2banテスト**（別のクライアント端末から）:
```bash
# 意図的に5回ログイン失敗させる
for i in {1..5}; do ssh invalid_user@workstation; done

# Ban状態を確認
sudo fail2ban-client status sshd
```

**期待される出力**:
```
Status for the jail: sshd
|- Actions
   |- Currently banned: 1
   `- Banned IP list:   192.168.1.100
```

**検証ポイント**:
- ✅ 5回失敗後にIPアドレスがBanされる
- ✅ 10分後に自動的にUnbanされる
- ✅ Discord通知が届く

### 4.3 SELinux状態確認

**コマンド**:
```bash
getenforce
sudo sestatus
sudo ausearch -m AVC -ts recent | head -10
```

**期待される出力**:
```
Enforcing

SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Memory protection checking:     actual (secure)
Max kernel policy version:      33

(AVC拒否ログが少数であることを確認、多数ある場合は要調査)
```

**検証ポイント**:
- ✅ SELinux が `Enforcing` モード
- ✅ AVC拒否ログが異常に多くない（通常運用レベル）

### 4.4 dnf-automatic自動更新確認

**コマンド**:
```bash
sudo systemctl status dnf-automatic.timer
sudo grep "apply_updates" /etc/dnf/automatic.conf
sudo journalctl -u dnf-automatic --since "7 days ago" | grep -i "apply"
```

**期待される出力**:
```
● dnf-automatic.timer - dnf-automatic timer
     Loaded: loaded (/usr/lib/systemd/system/dnf-automatic.timer; enabled; vendor preset: disabled)
     Active: active (waiting) since ...

apply_updates = yes

Jan 08 03:00:01 workstation systemd[1]: Starting dnf-automatic...
Jan 08 03:05:32 workstation dnf-automatic[12345]: Applying updates: 15 packages updated
```

**検証ポイント**:
- ✅ dnf-automatic.timer が有効化されている
- ✅ `apply_updates = yes` 設定
- ✅ 週1回の自動更新が実行されている

### 4.5 firewalld Docker API保護確認

**コマンド**:
```bash
sudo firewall-cmd --list-ports
sudo firewall-cmd --list-services
sudo firewall-cmd --zone=public --list-all
```

**期待される出力**:
```
2377/tcp 7946/tcp 7946/udp 4789/udp  # Docker Swarmポートのみ開放

ssh

public (active)
  target: default
  interfaces: ens33
  sources:
  services: ssh
  ports: 2377/tcp 7946/tcp 7946/udp 4789/udp
  protocols:
  forward: yes
```

**検証ポイント**:
- ✅ Docker API（2375/2376）が外部に公開されていない
- ✅ Docker Swarmポート（2377, 7946, 4789）のみ開放
- ✅ SSH サービスが有効化されている

---

## セクション5: リソース配分管理検証

### 5.1 ホストOSリソース確認

**コマンド**:
```bash
nproc  # CPU コア数
free -h  # メモリ容量
df -h  # ストレージ容量
```

**期待される出力**:
```
6

               total        used        free      shared  buff/cache   available
Mem:            31Gi       8.0Gi       20Gi       100Mi       3.0Gi        22Gi
Swap:          8.0Gi          0B       8.0Gi

Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        50G   10G   40G  20% /
/dev/sdb1       3.6T  100G  3.4T   3% /data
```

**検証ポイント**:
- ✅ CPU: 6コア（12スレッド）
- ✅ メモリ: 32GB
- ✅ SSD: 50GB（OS/Docker領域）
- ✅ HDD: 3.6TB（データ領域）

### 5.2 リソース配分設定確認

**コマンド**:
```bash
cat /proc/sys/vm/swappiness
sudo cat /etc/sysctl.d/99-docker-performance.conf
docker system info | grep -E "CPUs|Total Memory"
```

**期待される出力**:
```
10

vm.swappiness = 10

CPUs: 6
Total Memory: 31.2GiB
```

**検証ポイント**:
- ✅ swappiness = 10（スワップ使用を最小限に）
- ✅ `/etc/sysctl.d/99-docker-performance.conf` に `vm.swappiness = 10` が設定されている
- ✅ Docker が全CPU/メモリリソースを認識している

### 5.3 コンテナリソース制限テスト

**コマンド**:
```bash
# メモリ制限付きコンテナ起動
docker run --name resource-test -d --memory="512m" --cpus="1.0" nginx:alpine

# リソース制限確認
docker inspect resource-test | grep -A 10 "Memory\|NanoCpus"

# 動作確認
curl -I http://localhost:80  # エラーになる場合は docker run -p 8080:80 で再実行
docker stats resource-test --no-stream

# クリーンアップ
docker stop resource-test && docker rm resource-test
```

**期待される出力**:
```
"Memory": 536870912,  # 512MB = 512 * 1024 * 1024
"NanoCpus": 1000000000,  # 1.0 CPU

HTTP/1.1 200 OK

CONTAINER ID   NAME            CPU %     MEM USAGE / LIMIT   MEM %     NET I/O     BLOCK I/O
abc123def456   resource-test   0.00%     2.5MiB / 512MiB    0.49%     1.2kB/0B    0B/0B
```

**検証ポイント**:
- ✅ メモリ制限（512MB）が適用されている
- ✅ CPU制限（1.0コア）が適用されている
- ✅ コンテナが正常に起動・動作する

### 5.4 ストレージ使用率確認

**コマンド**:
```bash
df -h / /data
docker system df
```

**期待される出力**:
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda2        50G   10G   40G  20% /
/dev/sdb1       3.6T  100G  3.4T   3% /data

TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          10        5         2.5GB     1.2GB (48%)
Containers      5         2         100MB     50MB (50%)
Local Volumes   8         3         500MB     200MB (40%)
Build Cache     20        0         1.5GB     1.5GB (100%)
```

**検証ポイント**:
- ✅ ルートパーティション使用率が80%未満（現在20%）
- ✅ データパーティション使用率が80%未満（現在3%）
- ✅ Docker システムディスク使用状況が可視化されている

---

## セクション6: Docker Swarm機能検証

### 6.1 Swarm初期化状態確認

**コマンド**:
```bash
docker node ls
docker node inspect self --format '{{ .Status.State }}'
docker network ls | grep -E "ingress|docker_gwbridge"
```

**期待される出力**:
```
ID                            HOSTNAME     STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
abc123def456 *                workstation  Ready     Active         Leader           24.0.x

ready

NETWORK ID     NAME              DRIVER    SCOPE
xxxxxxxxxxxx   ingress           overlay   swarm
xxxxxxxxxxxx   docker_gwbridge   bridge    local
```

**検証ポイント**:
- ✅ 単一ノードマネージャーとして初期化されている
- ✅ ノードステータスが `Ready`
- ✅ Swarm ネットワーク（ingress, docker_gwbridge）が作成されている

### 6.2 Swarm Tokenの保存確認

**コマンド**:
```bash
ls -l /root/.docker-swarm-worker-token
ls -l /root/.docker-swarm-manager-token
cat /root/.docker-swarm-worker-token
cat /root/.docker-swarm-manager-token
```

**期待される出力**:
```
-rw------- 1 root root ... /root/.docker-swarm-manager-token
-rw------- 1 root root ... /root/.docker-swarm-worker-token

Manager Token: SWMTKN-1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Worker Token: SWMTKN-1-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
```

**検証ポイント**:
- ✅ Swarm Token が `/root/swarm-join-tokens.txt` に保存されている
- ✅ ファイル権限が `600`（root のみ読み書き可能）

### 6.3 Swarm Serviceデプロイテスト

**コマンド**:
```bash
# テストサービスをデプロイ
docker service create --name test-web --replicas 2 --publish 8080:80 nginx:alpine

# サービス状態確認
docker service ls
docker service ps test-web
sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload

# 動作確認
sleep 10  # サービス起動待機
curl -I http://127.0.0.1:8080
# localhost は IPv6(::1) に解決される環境では通信できません。Docker は IPv4(0.0.0.0) でポート公開されるため、127.0.0.1 を使用してください。

# クリーンアップ
docker service rm test-web
```

**期待される出力**:
```
ID             NAME       MODE         REPLICAS   IMAGE          PORTS
abc123def456   test-web   replicated   2/2        nginx:alpine   *:8080->80/tcp

ID             NAME         IMAGE          NODE         DESIRED STATE   CURRENT STATE
xyz123abc456   test-web.1   nginx:alpine   workstation  Running         Running 10 seconds ago
def456ghi789   test-web.2   nginx:alpine   workstation  Running         Running 10 seconds ago

HTTP/1.1 200 OK
Server: nginx/1.x.x
```

**検証ポイント**:
- ✅ `docker service create` コマンドでサービスがデプロイできる
- ✅ レプリカ数（2個）が正常に起動する
- ✅ ポート公開（8080:80）が機能している
- ✅ サービスが正常に動作する

---

## セクション7: 統合シナリオテスト

### 7.1 シナリオ1: Webアプリケーションデプロイ

**目的**: Docker Composeを使った実践的なWebアプリケーションデプロイを検証

**手順**:

```bash
# 1. テスト用ディレクトリ作成
mkdir -p ~/docker-test/webapp
cd ~/docker-test/webapp

# 2. docker-compose.yml作成
cat > docker-compose.yml <<'EOF'
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html:ro
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: testdb
    volumes:
      - db_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    restart: unless-stopped

volumes:
  db_data:
EOF

# 3. HTMLファイル作成
mkdir html
echo "<h1>Docker Integration Test OK</h1>" > html/index.html

# 4. アプリケーション起動
docker compose up -d

# 5. 起動確認
docker compose ps
docker compose logs

# 6. 動作確認
curl http://localhost:8080
docker exec webapp-db-1 psql -U postgres -d testdb -c "SELECT version();"

# 7. リソース使用状況確認
docker stats --no-stream

# 8. クリーンアップ
docker compose down -v
cd ~ && rm -rf ~/docker-test
```

**期待される結果**:
- ✅ docker-compose.yml が正常に解析される
- ✅ webコンテナとdbコンテナが起動する
- ✅ HTTPリクエストが成功する
- ✅ PostgreSQLデータベースが動作する
- ✅ リソース制限が適用されている

### 7.2 シナリオ2: バックアップ・復元フロー

**目的**: 本番運用を想定したバックアップと復元の完全フロー検証

**手順**:

```bash
# 1. テストデータ作成
docker volume create production_data
docker run --rm -v production_data:/data alpine sh -c "echo 'Critical Production Data' > /data/important.txt"

# 2. バックアップ実行
sudo /usr/local/bin/docker-backup.sh

# 3. バックアップディレクトリ確認
BACKUP_DATE=$(date +\%Y\%m\%d)
ls -l /mnt/backup-hdd/docker/$BACKUP_DATE/volumes/production_data/_data/

# 4. 本番データ削除（障害シミュレーション）
docker volume rm production_data
docker volume ls | grep production_data || echo "production_data volume not found (expected)"

# 5. バックアップから復元
docker volume create production_data
sudo rsync -av /mnt/backup-hdd/docker/$BACKUP_DATE/volumes/production_data/_data/ \
    /data/docker/volumes/production_data/_data/

# 6. データ復元確認
docker run --rm -v production_data:/data alpine cat /data/important.txt

# 7. クリーンアップ
docker volume rm production_data
```

**期待される結果**:
- ✅ バックアップが正常に実行される
- ✅ `/mnt/backup-hdd/docker/$BACKUP_DATE/volumes/production_data/_data/` 以下にバックアップが保存される
- ✅ 削除したボリュームを再作成後に `rsync` で復元できる
- ✅ `docker run --rm -v production_data:/data alpine cat /data/important.txt` で `Critical Production Data` が表示される

### 7.3 シナリオ3: セキュリティインシデント対応

**目的**: セキュリティアラートと自動防御機能の検証

**手順** （別のクライアント端末から実施）:

```bash
# 1. SSH不正アクセステスト
for i in {1..5}; do
  ssh -o BatchMode=yes -o StrictHostKeyChecking=accept-new invalid_user@<workstation_ip> "exit 0" || true
  sleep 2
done

# 2. fail2ban Ban確認（workstation側で実行）
sudo fail2ban-client status sshd | grep "Banned IP"

# 3. Discord通知確認
# Discordチャンネルに「SSH不正アクセス検知」通知が届くことを確認

# 4. ログ確認
sudo journalctl -u fail2ban --since "5 minutes ago" | grep Ban

# 5. 手動Unban（テスト後）
sudo fail2ban-client set sshd unbanip <banned_ip>
```

**期待される結果**:
- ✅ 5回失敗後にIPがBanされる
- ✅ Discord通知が即座に届く
- ✅ journaldログに記録される
- ✅ `bantime = 3600`（1時間）が有効で、1時間経過後に自動Unbanされる（または手動Unban可能）

### 7.4 シナリオ4: リソース制限動作検証

**目的**: メモリ/CPU制限が正しく機能することを検証

**手順**:

```bash
# 1. メモリ制限テスト
docker run --name mem-test -d --memory="100m" --memory-swap="100m" \
  alpine sh -c 'while true; do dd if=/dev/zero of=/dev/shm/fill bs=1M count=80 >/dev/null 2>&1; rm -f /dev/shm/fill; sleep 1; done'

# 2. メモリ使用状況確認（制限値内に収まっているか）
docker stats mem-test --no-stream

# 3. OOM Killerテスト（メモリ制限超過時の動作確認）
docker run --rm --memory="50m" --memory-swap="50m" \
  alpine sh -c 'dd if=/dev/zero of=/dev/shm/fill bs=1M count=120' || echo "OOMテスト完了（予想通り失敗）"

# 4. CPU制限テスト
docker run --name cpu-test -d --cpus="0.5" \
  alpine sh -c 'while true; do sha1sum /etc/hostname >/dev/null 2>&1; done'

# 5. CPU使用率確認
docker stats cpu-test --no-stream

# 6. クリーンアップ
docker rm -f mem-test cpu-test
```

**期待される結果**:
- ✅ メモリ制限が強制される
- ✅ メモリ超過時にOOM Killerが動作する
- ✅ CPU制限が適用される
- ✅ docker stats で制限値が確認できる

---

## セクション8: Phase 3完了チェックリスト

以下のすべての項目が ✅ であることを確認してください：

### Docker基盤環境
- [ ] Docker Engine 24.0.x 以上がインストールされている
- [ ] Docker Compose v2系がインストールされている
- [ ] Dockerサービスが自動起動する（systemd enabled）
- [ ] dockerグループでsudo不要実行が可能
- [ ] Dockerネットワークがlibvirtと独立している
- [ ] /etc/docker/daemon.json が正しく設定されている

### ストレージ・バックアップ
- [ ] /data/docker（HDD）にDockerデータが配置されている
- [ ] 外付けHDDが /mnt/backup-hdd にマウントされている
- [ ] バックアップスクリプトが週1回自動実行される
- [ ] バックアップ/復元テストが成功する
- [ ] ストレージ使用率が80%未満である

### 監視・ロギング
- [ ] systemd journald でDockerログが収集されている
- [ ] logwatch が日次実行される
- [ ] Discord Webhook通知が機能している
- [ ] システムリソース監視が10分間隔で実行される
- [ ] ログローテーション設定が適用されている

### セキュリティ基盤
- [ ] SSH公開鍵認証が強制されている（パスワード認証無効）
- [ ] fail2ban が動作し、不正アクセスをブロックする
- [ ] SELinux が Enforcing モードで動作している
- [ ] dnf-automatic で週1回自動更新される
- [ ] Docker APIポート（2375/2376）が外部非公開である
- [ ] firewalld が適切に設定されている

### リソース配分管理
- [ ] swappiness=10 が設定されている
- [ ] コンテナリソース制限（CPU/メモリ）が機能している
- [ ] メモリ使用率が70%未満である
- [ ] ストレージ使用率が80%未満である

### Docker Swarm
- [ ] 単一ノードマネージャーとして初期化されている
- [ ] Swarm Token が安全に保存されている
- [ ] docker service コマンドでサービスデプロイができる
- [ ] Swarm ネットワーク（ingress, docker_gwbridge）が作成されている

### 統合テスト
- [ ] シナリオ1（Webアプリケーションデプロイ）が成功する
- [ ] シナリオ2（バックアップ・復元フロー）が成功する
- [ ] シナリオ3（セキュリティインシデント対応）が成功する
- [ ] シナリオ4（リソース制限動作検証）が成功する

---

## セクション9: トラブルシューティング

### 問題1: Dockerサービスが起動しない

**症状**: `sudo systemctl start docker` が失敗する

**診断**:
```bash
sudo journalctl -u docker -n 50
sudo dockerd --debug
```

**考えられる原因と対策**:
- **daemon.json構文エラー**: JSON構文を確認、`jq . /etc/docker/daemon.json` でバリデーション
- **ストレージドライバーエラー**: `/data/docker` のパーミッション確認、`sudo chown -R root:root /data/docker`
- **ネットワーク競合**: `ip addr show docker0` でDocker0の状態確認

### 問題2: バックアップスクリプトが失敗する

**症状**: バックアップログにエラーメッセージが記録される

**診断**:
```bash
sudo tail -50 /var/log/docker-backup.log
ls -l /mnt/backup-hdd
```

**考えられる原因と対策**:
- **外付けHDD未接続**: `mount | grep /mnt/backup-hdd` で確認、HDD接続を確認
- **ディスク容量不足**: `df -h /mnt/backup-hdd` で容量確認、古いバックアップ削除
- **パーミッションエラー**: `sudo chown -R root:root /mnt/backup-hdd`

### 問題3: fail2banがIPをBanしない

**症状**: 不正アクセスがあってもBanされない

**診断**:
```bash
sudo fail2ban-client status sshd
sudo journalctl -u fail2ban -n 50
sudo grep "Failed password" /var/log/secure
```

**考えられる原因と対策**:
- **jail設定エラー**: `/etc/fail2ban/jail.local` の構文確認
- **ログファイルパス誤り**: `logpath = /var/log/secure` を確認
- **maxretry設定**: `maxretry = 5` を確認、値を調整

### 問題4: Docker Swarmサービスが起動しない

**症状**: `docker service create` がタイムアウトする

**診断**:
```bash
docker node ls
docker service ps <service_name>
docker service logs <service_name>
```

**考えられる原因と対策**:
- **ファイアウォールブロック**: Swarmポート（2377, 7946, 4789）開放確認
- **ネットワークエラー**: `docker network ls | grep ingress` で ingress ネットワーク確認
- **リソース不足**: `docker stats` でホストリソース確認

### 問題5: Discord通知が届かない

**症状**: アラートスクリプト実行時に通知が届かない

**診断**:
```bash
/usr/local/bin/send-alert.sh "TEST" "テストメッセージ"
curl -X POST -H "Content-Type: application/json" -d '{"content":"Test"}' <WEBHOOK_URL>
```

**考えられる原因と対策**:
- **Webhook URL誤り**: スクリプト内のURLを確認
- **ネットワーク到達性**: `ping discord.com` で外部接続確認
- **curlエラー**: `sudo dnf install curl` でcurl再インストール

---

## セクション10: 完了報告書テンプレート

Phase 3完了時に以下のレポートを作成してください：

```markdown
# Phase 3 完了報告書

## プロジェクト情報
- **プロジェクト名**: Docker基盤環境構築（Phase 3）
- **実施日**: YYYY年MM月DD日
- **実施者**: [担当者名]
- **所要時間**: [合計時間]

## 実施内容サマリー
- Docker環境構築: [完了/未完了]
- ストレージ・バックアップ設定: [完了/未完了]
- 監視・セキュリティ設定: [完了/未完了]
- 統合テスト: [完了/未完了]

## 環境情報
- **OS**: Rocky Linux 9.6
- **Docker Engine**: v24.0.x
- **Docker Compose**: v2.x.x
- **Docker Swarm**: 単一ノード構成

## テスト結果
| テスト項目 | 結果 | 備考 |
|-----------|------|------|
| Docker基盤環境検証 | ✅ PASS | すべての検証項目クリア |
| ストレージ・バックアップ検証 | ✅ PASS | バックアップ/復元成功 |
| 監視・ロギング検証 | ✅ PASS | Discord通知動作確認済み |
| セキュリティ基盤検証 | ✅ PASS | fail2ban動作確認済み |
| リソース配分管理検証 | ✅ PASS | リソース制限機能確認済み |
| Docker Swarm検証 | ✅ PASS | Serviceデプロイ成功 |
| 統合シナリオテスト | ✅ PASS | 全4シナリオ成功 |

## 発生した問題と対応
| 問題 | 影響度 | 対応状況 |
|------|--------|---------|
| [問題があれば記載] | [高/中/低] | [対応内容] |

## 次のステップ
- Phase 4: ウェブメールシステム構築
- Phase 5: ブログ移行
- Phase 6: 商用サービス開発

## 承認
- **技術責任者**: ________________ 日付: __________
- **プロジェクトオーナー**: ________________ 日付: __________
```

---

## 参考資料

- **要件定義書**: Docs/infra/3.0-DOCKER-INFRASTRUCTURE-REQUIREMENTS.md
- **設計書**: Docs/infra/3.0-DOCKER-INFRASTRUCTURE-DESIGN.md
- **Docker環境構築手順**: procedures/3.1-docker-environment-setup.md
- **ストレージ・バックアップ手順**: procedures/3.2-storage-backup-setup.md
- **監視・セキュリティ手順**: procedures/3.3-monitoring-security-setup.md

**END OF DOCUMENT**
