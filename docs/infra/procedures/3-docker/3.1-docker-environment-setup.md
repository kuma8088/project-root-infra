# Phase 3.1: Docker環境構築

## 概要

Rocky Linux 9.6上にDocker Engine、Docker Compose、Docker Swarmをインストールし、コンテナ基盤環境を構築します。ホスト直接実行方式を採用し、将来的な商用サービス開発・検証のための基盤を整備します。

## 前提条件

- Phase 1（KVM基盤構築）完了
- Phase 2（AWS VPC相当ネットワーク構築）完了
- Rocky Linux 9.6が正常稼働中
- インターネット接続が利用可能
- root権限またはsudo権限を持つユーザーでログイン可能

## 推定所要時間

45分

## 構築手順

### ステップ1: 既存Docker関連パッケージの削除

既存のDockerパッケージが存在する場合は削除します。クリーンな状態からインストールを開始します。

#### 実行コマンド

```bash
# 既存Dockerパッケージの確認
sudo dnf list installed | grep -i docker

# 既存パッケージの削除（存在する場合）
sudo dnf remove -y docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine \
                  podman \
                  runc
```

#### 期待される出力

```
# パッケージが存在しない場合
No match for argument: docker
No match for argument: docker-client
...

# または削除成功
Removed:
  docker-...
Complete!
```

#### 検証項目

- **アクション**: `rpm -qa | grep -i docker` を実行する
- **期待結果**: 何も表示されない（Dockerパッケージが完全に削除されている）
- **失敗時**: 再度 `sudo dnf remove -y <残存パッケージ>` を実行

---

### ステップ2: Docker公式リポジトリの追加

Docker公式リポジトリを追加し、最新安定版をインストールできるようにします。

#### 実行コマンド

```bash
# dnf-pluginsのインストール
sudo dnf install -y dnf-plugins-core

# Docker公式リポジトリの追加
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
```

#### 期待される出力

```
Adding repo from: https://download.docker.com/linux/centos/docker-ce.repo
```

#### 検証項目

- **アクション**: `ls /etc/yum.repos.d/docker-ce.repo` を実行する
- **期待結果**: リポジトリファイルが存在する
- **失敗時**: URL確認、ネットワーク接続確認後に再実行

---

### ステップ3: Docker Engine + Docker Composeのインストール

Docker Engine（最新安定版）とDocker Compose Plugin（v2系）をインストールします。

#### 実行コマンド

```bash
# Docker Engine + Docker Compose Pluginのインストール
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# インストール確認
docker --version
docker compose version
```

#### 期待される出力

```
Docker version 24.x.x, build xxxxx
Docker Compose version v2.x.x
```

#### 検証項目

- **アクション**: `rpm -qa | grep docker-ce` を実行する
- **期待結果**: docker-ce、docker-ce-cli、docker-compose-pluginが表示される
- **失敗時**: リポジトリが正しく追加されているか確認、`sudo dnf clean all && sudo dnf makecache` 後に再実行

---

### ステップ4: Dockerサービスの起動と自動起動設定

Docker Engineをsystemd経由で起動し、OS再起動時に自動起動するよう設定します。

#### 実行コマンド

```bash
# Dockerサービスの起動
sudo systemctl start docker

# 自動起動の設定
sudo systemctl enable docker

# サービス状態の確認
sudo systemctl status docker
```

#### 期待される出力

```
● docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)
   Active: active (running) since ...
```

#### 検証項目

- **アクション**: `sudo systemctl is-active docker` と `sudo systemctl is-enabled docker` を実行する
- **期待結果**: どちらも `active` と `enabled` が表示される
- **失敗時**: `sudo journalctl -u docker -xe` でログを確認、エラー内容に応じて対処

---

### ステップ5: dockerグループへのユーザー追加

現在のユーザーをdockerグループに追加し、sudo不要でDockerコマンドを実行できるようにします。

#### 実行コマンド

```bash
# dockerグループへのユーザー追加
sudo usermod -aG docker $USER

# グループ確認
id $USER
```

#### 期待される出力

```
uid=1000(username) gid=1000(username) groups=1000(username),...,993(docker)
```

#### 検証項目

- **アクション**: 一度ログアウト・ログイン後に `docker ps` を実行する（sudoなし）
- **期待結果**: エラーなく実行できる
- **失敗時**: `groups $USER` で docker グループが表示されるか確認、表示されない場合は再ログイン

**注意**: グループ変更を反映するため、**必ずログアウト・ログインが必要**です。

```bash
# ログアウト
exit

# 再ログイン後
docker ps
```

---

### ステップ6: データディレクトリの作成と権限設定

Dockerデータ格納用ディレクトリを作成し、適切な権限とSELinuxコンテキストを設定します。

#### 実行コマンド

```bash
# データディレクトリの作成
sudo mkdir -p /data/docker
sudo mkdir -p /data/docker/volumes
sudo mkdir -p /data/docker/images
sudo mkdir -p /data/docker-compose

# 権限設定
sudo chown -R root:root /data/docker
sudo chmod -R 755 /data/docker

# SELinuxコンテキスト設定（Enforcingモードで必須）
sudo semanage fcontext -a -t container_file_t "/data/docker(/.*)?"
sudo restorecon -Rv /data/docker

# ディレクトリ確認
ls -la /data/
ls -laZ /data/docker
```

#### 期待される出力

```
drwxr-xr-x  3 root root 4096 ... docker
drwxr-xr-x  2 root root 4096 ... docker-compose

# SELinuxコンテキスト確認
drwxr-xr-x. root root unconfined_u:object_r:container_file_t:s0 /data/docker
```

#### 検証項目

- **アクション**: `df -h /data` と `ls -laZ /data/docker` を実行する
- **期待結果**:
  - /data がマウントされており、docker ディレクトリが存在する
  - SELinuxコンテキストが `container_file_t` に設定されている
- **失敗時**:
  - /data がマウントされていない場合は Phase 2 の設定を確認
  - SELinuxコンテキストエラーの場合は `sudo semanage fcontext -l | grep container_file_t` で確認

---

### ステップ7: Dockerデーモン設定ファイルの作成

/etc/docker/daemon.json を作成し、ストレージドライバ、データルート、ログ設定を最適化します。

#### 実行コマンド

```bash
# 設定ディレクトリの確認
sudo mkdir -p /etc/docker

# daemon.json の作成
sudo tee /etc/docker/daemon.json > /dev/null <<'EOF'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3",
    "labels": "service,environment"
  },
  "storage-driver": "overlay2",
  "data-root": "/data/docker",
  "live-restore": false, # DockerSwarmとの管理矛盾を回避するため"false"とする
  "userland-proxy": false,
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  },
  "max-concurrent-downloads": 3,
  "max-concurrent-uploads": 5
}
EOF

# 設定ファイルの確認
sudo cat /etc/docker/daemon.json
```

#### 期待される出力

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    ...
  },
  ...
}
```

#### 検証項目

- **アクション**: `sudo cat /etc/docker/daemon.json | jq .` を実行する（jq未インストールの場合は `sudo dnf install -y jq`）
- **期待結果**: JSON形式が正しく表示される（構文エラーなし）
- **失敗時**: JSON構文エラーがある場合は再作成

---

### ステップ8: Dockerサービスの再起動と設定反映

daemon.json の設定を反映するため、Dockerサービスを再起動します。

#### 実行コマンド

```bash
# Dockerサービスの再起動
sudo systemctl restart docker

# サービス状態の確認
sudo systemctl status docker

# Docker情報確認（設定反映確認）
docker info | grep -E "Storage Driver|Docker Root Dir"
```

#### 期待される出力

```
Storage Driver: overlay2
Docker Root Dir: /data/docker
```

#### 検証項目

- **アクション**: `docker info` を実行し、`Data Root`、`Storage Driver`、`Logging Driver` を確認する
- **期待結果**:
  - Storage Driver: overlay2
  - Docker Root Dir: /data/docker
  - Logging Driver: json-file
- **失敗時**: daemon.json の構文エラーを確認、`sudo journalctl -u docker -xe` でログ確認

---

### ステップ9: カーネルパラメータの設定

Dockerネットワーク機能に必要なカーネルパラメータを設定します。

#### 実行コマンド

```bash
# カーネルパラメータ設定ファイルの作成
sudo tee /etc/sysctl.d/99-docker.conf > /dev/null <<'EOF'
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
fs.inotify.max_user_watches=524288
fs.inotify.max_user_instances=512
EOF

# 設定の適用
sudo sysctl -p /etc/sysctl.d/99-docker.conf

# 設定確認
sysctl net.ipv4.ip_forward
sysctl net.bridge.bridge-nf-call-iptables
```

#### 期待される出力

```
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
```

#### 検証項目

- **アクション**: `sysctl -a | grep -E "ip_forward|bridge-nf"` を実行する
- **期待結果**: すべてのパラメータが `1` に設定されている
- **失敗時**: `sudo modprobe br_netfilter` を実行後に再適用

---

### ステップ10: Docker Swarmの初期化

Docker Swarmを単一ノードマネージャーとして初期化します。将来のマルチノード拡張に備えます。

#### 実行コマンド

```bash
# ホストIPアドレスの確認
ip -4 addr show | grep inet

# プライマリネットワークインターフェースのIPアドレス自動取得
HOST_IP=$(ip -4 addr show $(ip route | grep default | awk '{print $5}' | head -1) | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)
echo "検出されたIPアドレス: $HOST_IP"

# Docker Swarmの初期化（自動取得したIPアドレスを使用）
sudo docker swarm init --advertise-addr $HOST_IP

# Swarm状態確認
docker info | grep Swarm
docker node ls
```

#### 期待される出力

```
検出されたIPアドレス: 192.168.x.x
Swarm initialized: current node (xxxxxx) is now a manager.

To add a worker to this swarm, run the following command:
    docker swarm join --token SWMTKN-1-xxxxx 192.168.x.x:2377
```

#### 検証項目

- **アクション**: `docker info | grep "Swarm:"` を実行する
- **期待結果**: `Swarm: active` が表示される
- **失敗時**: ポート2377が開いているか確認 `sudo ss -tulpn | grep 2377`、firewalld設定確認

---

### ステップ11: Swarmトークンの保存

将来のワーカーノード追加に備え、Swarm Join Tokenを安全に保存します。

#### 実行コマンド

```bash
# Swarmワーカートークンの取得と保存
docker swarm join-token worker | sudo tee /root/.docker-swarm-worker-token > /dev/null

# Swarmマネージャートークンの取得と保存
docker swarm join-token manager | sudo tee /root/.docker-swarm-manager-token > /dev/null

# Swarmトークンを一連で登録する場合
docker swarm join-token -q manager > /root/.docker-swarm-manager-token
docker swarm join-token -q worker  > /root/.docker-swarm-worker-token
docker swarm join-token manager > /root/swarm-join-tokens.txt
docker swarm join-token worker  >> /root/swarm-join-tokens.txt

# または
sudo bash -c '{
  echo "Manager Token: $(cat /root/.docker-swarm-manager-token)"
  echo "Worker Token:  $(cat /root/.docker-swarm-worker-token)"
} > /root/swarm-join-tokens.txt'

# 権限設定（セキュリティ強化）
sudo chmod 600 /root/.docker-swarm-worker-token
sudo chmod 600 /root/.docker-swarm-manager-token
sudo chmod 600 /root/swarm-join-tokens.txt
sudo chown root:root /root/swarm-join-tokens.txt

# 確認
sudo ls -la /root/.docker-swarm-*
```

#### 期待される出力

```
-rw------- 1 root root ... /root/.docker-swarm-manager-token
-rw------- 1 root root ... /root/.docker-swarm-worker-token
```

#### 検証項目

- **アクション**: `sudo cat /root/.docker-swarm-worker-token` を実行する
- **期待結果**: `docker swarm join --token SWMTKN-1-...` のコマンドが表示される
- **失敗時**: Swarmが正しく初期化されているか `docker info | grep Swarm` で確認

---

### ステップ12: ファイアウォール設定

Docker Swarm動作に必要なポートをfirewalldで許可します。

#### 実行コマンド

```bash
# Docker Swarm用ポートの許可
sudo firewall-cmd --permanent --add-port=2377/tcp   # Swarm管理通信
sudo firewall-cmd --permanent --add-port=7946/tcp   # ノード間通信
sudo firewall-cmd --permanent --add-port=7946/udp   # ノード間通信
sudo firewall-cmd --permanent --add-port=4789/udp   # overlay network

# Docker API（ローカルのみ許可、外部からは遮断）
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="127.0.0.1" port port="2375" protocol="tcp" accept'

# 設定の再読み込み
sudo firewall-cmd --reload

# 設定確認
sudo firewall-cmd --list-all
```

#### 期待される出力

```
ports: 22/tcp 2201-2280/tcp 2377/tcp 4789/udp 7946/tcp 7946/udp
```

#### 検証項目

- **アクション**: `sudo firewall-cmd --list-ports` を実行する
- **期待結果**: 2377/tcp、7946/tcp、7946/udp、4789/udp が表示される
- **失敗時**: `sudo firewall-cmd --reload` を再実行、firewalldが起動しているか確認

---

### ステップ13: テストコンテナの起動

nginxコンテナを起動し、Docker環境が正常動作することを確認します。

#### 実行コマンド

```bash
# nginxテストコンテナの起動
docker run -d --name test-nginx -p 8080:80 nginx:latest

# コンテナ状態確認
docker ps

# HTTP接続テスト
curl http://localhost:8080
```

#### 期待される出力

```
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                  NAMES
xxxxxx         nginx:latest   "/docker-entrypoint.…"   5 seconds ago   Up 4 seconds   0.0.0.0:8080->80/tcp   test-nginx

<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...
```

#### 検証項目

- **アクション**: `docker ps | grep test-nginx` と `curl -I http://localhost:8080` を実行する
- **期待結果**: コンテナがUpステータス、HTTPステータス200が返る
- **失敗時**: `docker logs test-nginx` でエラー確認、ポート8080が競合していないか確認

---

### ステップ14: テストコンテナのクリーンアップ

テスト完了後、nginxコンテナを削除します。

#### 実行コマンド

```bash
# テストコンテナの停止と削除
docker stop test-nginx
docker rm test-nginx

# イメージも削除（オプション）
docker rmi nginx:latest

# 確認
docker ps -a
```

#### 期待される出力

```
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
（何も表示されない）
```

#### 検証項目

- **アクション**: `docker ps -a` を実行する
- **期待結果**: test-nginxコンテナが存在しない
- **失敗時**: 手動で `docker rm -f test-nginx` を実行

---

## 包括的動作確認手順

### 1. Docker Engine基本動作確認

```bash
# Dockerバージョン確認
docker --version
docker compose version

# Docker情報確認
docker info

# Dockerサービス状態確認
sudo systemctl status docker
sudo systemctl is-enabled docker
```

**期待される結果**:
- Docker version 24.x以上
- Docker Compose version v2.x以上
- Storage Driver: overlay2
- Docker Root Dir: /data/docker
- サービスが active (running) かつ enabled

---

### 2. Docker Swarm動作確認

```bash
# Swarm状態確認
docker info | grep Swarm
docker node ls

# Swarmネットワーク確認
docker network ls | grep -E "ingress|docker_gwbridge"
```

**期待される結果**:
- Swarm: active
- ノードリストに1台のmanagerノードが表示される
- ingressとdocker_gwbridgeネットワークが存在する

---

### 3. ストレージ設定確認

```bash
# データディレクトリ確認
ls -la /data/docker
df -h /data/docker

# Docker Root Dir確認
docker info | grep "Docker Root Dir"
```

**期待される結果**:
- /data/docker ディレクトリが存在
- Docker Root Dir: /data/docker
- 十分な空き容量がある（>100GB推奨）

---

### 4. ネットワーク設定確認

```bash
# カーネルパラメータ確認
sysctl net.ipv4.ip_forward
sysctl net.bridge.bridge-nf-call-iptables

# Dockerネットワーク確認
docker network ls

# ファイアウォール設定確認
sudo firewall-cmd --list-ports | grep -E "2377|7946|4789"
```

**期待される結果**:
- net.ipv4.ip_forward = 1
- net.bridge.bridge-nf-call-iptables = 1
- bridgeネットワークが存在
- Swarmポート（2377, 7946, 4789）が許可されている

---

### 5. ユーザー権限確認

```bash
# dockerグループ所属確認
groups $USER | grep docker

# sudo不要でDocker実行確認
docker ps
```

**期待される結果**:
- 現在のユーザーがdockerグループに所属
- sudoなしでdockerコマンドが実行できる

---

### 6. エラーログ確認

```bash
# システムログ確認
sudo journalctl -u docker --since "1 hour ago" | grep -i error
sudo journalctl -u docker --since "1 hour ago" | grep -i fail

# 一般的なシステムエラー確認
sudo dmesg | grep -i error | tail -10
```

**期待される結果**:
- 致命的なエラーログがない
- 警告レベルのログのみ、または正常なログのみ

---

## 最終確認チェックリスト

以下の全項目が ✅ になることを確認してください：

- [ ] Docker Engine がインストールされている（`docker --version`）
- [ ] Docker Compose がインストールされている（`docker compose version`）
- [ ] Dockerサービスが active (running) 状態（`systemctl status docker`）
- [ ] Dockerサービスが自動起動設定済み（`systemctl is-enabled docker`）
- [ ] dockerグループに現在のユーザーが所属（`groups $USER`）
- [ ] sudoなしでdockerコマンド実行可能（`docker ps`）
- [ ] Docker Root Dir が /data/docker（`docker info`）
- [ ] Storage Driver が overlay2（`docker info`）
- [ ] Docker Swarm が active 状態（`docker info | grep Swarm`）
- [ ] Swarmノードリストに1台表示（`docker node ls`）
- [ ] カーネルパラメータが正しく設定（`sysctl net.ipv4.ip_forward`）
- [ ] ファイアウォールでSwarmポート許可（`firewall-cmd --list-ports`）
- [ ] テストコンテナが正常起動・HTTP接続可能
- [ ] /data/docker ディレクトリが存在（`ls -la /data/docker`）
- [ ] 致命的なエラーログがない（`journalctl -u docker`）

## 次のステップ

**✅ 上記の全確認項目が成功した場合のみ**、次の手順に進んでください。

- **Phase 3.2**: ストレージ・バックアップ設定（`procedures/3.2-storage-backup-setup.md`）

問題が発見された場合は、該当するトラブルシューティングセクションを参照して解決してから次のフェーズに進行してください。

## トラブルシューティング

### Docker起動失敗

**症状**: `sudo systemctl start docker` が失敗する

**確認**:
```bash
sudo journalctl -u docker -xe
```

**原因と対策**:
1. **ストレージドライバエラー**: daemon.json の構文エラー → JSON構文確認
2. **ポート競合**: 他のサービスがポート使用 → `sudo ss -tulpn | grep 2375` 確認
3. **SELinuxコンテキスト**: /data/docker の権限問題 → `sudo chcon -Rt svirt_sandbox_file_t /data/docker`

---

### dockerグループ反映されない

**症状**: `docker ps` で権限エラー

**確認**:
```bash
groups $USER
id $USER
```

**対策**:
1. ログアウト・ログインを実行（必須）
2. それでも反映されない場合: `newgrp docker` を実行
3. 最終手段: OS再起動

---

### Docker Swarm初期化失敗

**症状**: `docker swarm init` がエラー

**確認**:
```bash
sudo ss -tulpn | grep 2377
docker info | grep Swarm
```

**原因と対策**:
1. **ポート2377使用中**: 既にSwarm初期化済み → `docker swarm leave --force` 後に再実行
2. **ネットワーク設定問題**: IPアドレス指定ミス → `ip -4 addr show` で正しいIP確認
3. **ファイアウォール**: ポート遮断 → `firewall-cmd --list-ports` 確認

---

### データディレクトリ作成失敗

**症状**: `/data/docker` が作成できない

**確認**:
```bash
df -h /data
ls -la /data
```

**原因と対策**:
1. **/dataマウントされていない**: Phase 2の設定確認 → `/etc/fstab` 確認
2. **権限不足**: root権限で実行 → `sudo mkdir -p /data/docker`
3. **ディスク容量不足**: 空き容量確認 → 不要ファイル削除

---

### テストコンテナ起動失敗

**症状**: `docker run nginx` がエラー

**確認**:
```bash
docker logs test-nginx
docker inspect test-nginx
```

**原因と対策**:
1. **イメージpull失敗**: インターネット接続確認 → プロキシ設定確認
2. **ポート競合**: 8080番ポート使用中 → `sudo ss -tulpn | grep 8080` で確認、別ポート使用
3. **リソース不足**: メモリ不足 → `free -h` で確認、他のプロセス停止

---

## 修正履歴

### Version 1.1 (2025-01-28)
**修正内容**:
1. **ステップ6とステップ7の順序入れ替え** (課題#5対応)
   - 理由: daemon.jsonで参照する前に/data/dockerディレクトリを作成する必要があるため
   - 変更: 旧ステップ6(daemon.json作成) → 新ステップ7、旧ステップ7(ディレクトリ作成) → 新ステップ6

2. **SELinuxコンテキスト設定の追加** (課題#3対応 - 🔴 CRITICAL)
   - 理由: SELinux Enforcingモードで/data/dockerへのアクセス拒否を防止
   - 追加コマンド:
     ```bash
     sudo semanage fcontext -a -t container_file_t "/data/docker(/.*)?"
     sudo restorecon -Rv /data/docker
     ```
   - 影響: SELinux有効環境での致命的障害を防止

3. **Swarm初期化時のIPアドレス自動取得** (課題#10対応 - 🟢 Nice-to-have)
   - 理由: 手動でのIPアドレス入力ミスを防止
   - 追加コマンド:
     ```bash
     HOST_IP=$(ip -4 addr show $(ip route | grep default | awk '{print $5}' | head -1) | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -1)
     ```
   - 影響: Swarm初期化の信頼性向上

**影響度評価**:
- 🔴 CRITICAL: 本番環境で障害を引き起こす可能性のある問題 (課題#3)
- 🟡 IMPORTANT: 早期対応が望ましい問題 (課題#5)
- 🟢 Nice-to-have: 利便性・保守性の向上 (課題#10)

---

**END OF DOCUMENT**
