# Phase 3.2: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®š

## æ¦‚è¦

Dockerãƒœãƒªãƒ¥ãƒ¼ãƒ ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€Composeãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚å¤–ä»˜ã‘HDDã‚’ãƒžã‚¦ãƒ³ãƒˆã—ã€é€±1å›žã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

- Phase 3.1ï¼ˆDockerç’°å¢ƒæ§‹ç¯‰ï¼‰å®Œäº†
- å¤–ä»˜ã‘HDDï¼ˆUSBæŽ¥ç¶šï¼‰ã‚’æº–å‚™
- rootæ¨©é™ã¾ãŸã¯sudoæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½

## æŽ¨å®šæ‰€è¦æ™‚é–“

30åˆ†

## æ§‹ç¯‰æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: å¤–ä»˜ã‘HDDã®æŽ¥ç¶šã¨ç¢ºèª

å¤–ä»˜ã‘HDDã‚’USBãƒãƒ¼ãƒˆã«æŽ¥ç¶šã—ã€LinuxãŒèªè­˜ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã®ç¢ºèª
lsblk

# USBæŽ¥ç¶šãƒ‡ãƒã‚¤ã‚¹ã®ç¢ºèª
sudo fdisk -l | grep -i "Disk /dev/sd"

# dmesgã§æŽ¥ç¶šãƒ­ã‚°ç¢ºèª
dmesg | tail -20
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
sdd      8:16   0 931.5G  0 disk
â””â”€sdd1   8:17   0 931.5G  0 part
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `lsblk` ã‚’å®Ÿè¡Œã—ã€æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ï¼ˆä¾‹: sdbã€sdcï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹
- **æœŸå¾…çµæžœ**: å¤–ä»˜ã‘HDDã®ãƒ‡ãƒã‚¤ã‚¹åï¼ˆä¾‹: /dev/sdbï¼‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- **å¤±æ•—æ™‚**: USBã‚±ãƒ¼ãƒ–ãƒ«æŽ¥ç¶šç¢ºèªã€åˆ¥ã®USBãƒãƒ¼ãƒˆè©¦è¡Œã€`dmesg | grep -i usb` ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª

**æ³¨æ„**: ãƒ‡ãƒã‚¤ã‚¹åï¼ˆsdb, sdcç­‰ï¼‰ã¯ç’°å¢ƒã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚ä»¥é™ã®æ‰‹é †ã§ã¯ `/dev/sdb1` ã¨è¡¨è¨˜ã—ã¾ã™ãŒã€**å®Ÿéš›ã®ãƒ‡ãƒã‚¤ã‚¹åã«ç½®ãæ›ãˆã¦**å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—2: å¤–ä»˜ã‘HDDã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç¢ºèªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½œæˆ

å¤–ä»˜ã‘HDDã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œæˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æƒ…å ±ç¢ºèª
sudo fdisk -l /dev/sdd

# ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ç¢ºèª
sudo blkid /dev/sdd1
```

**æ—¢ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå­˜åœ¨ã™ã‚‹å ´åˆ**: ã‚¹ãƒ†ãƒƒãƒ—3ã¸é€²ã‚€

**ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„å ´åˆ**: ä»¥ä¸‹ã‚’å®Ÿè¡Œ

```bash
# ext4ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ä½œæˆï¼ˆæ³¨æ„: ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰
sudo mkfs.ext4 /dev/sdd1

# ãƒ©ãƒ™ãƒ«è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
sudo e2label /dev/sdd1 backup-hdd

# ç¢ºèª
sudo blkid /dev/sdd1
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
/dev/sdb1: LABEL="backup-hdd" UUID="xxxx-xxxx-xxxx-xxxx" TYPE="ext4"
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `sudo blkid /dev/sdb1 | grep ext4` ã‚’å®Ÿè¡Œã™ã‚‹
- **æœŸå¾…çµæžœ**: TYPE="ext4" ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- **å¤±æ•—æ™‚**: ãƒ‡ãƒã‚¤ã‚¹åãŒæ­£ã—ã„ã‹ç¢ºèªã€`lsblk` ã§å†åº¦ãƒ‡ãƒã‚¤ã‚¹ç¢ºèª

**è­¦å‘Š**: `mkfs.ext4` ã¯**æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤**ã—ã¾ã™ã€‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯äº‹å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã®ä½œæˆã¨å¤–ä»˜ã‘HDDã®ãƒžã‚¦ãƒ³ãƒˆ

å¤–ä»˜ã‘HDDç”¨ã®ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã€æ‰‹å‹•ãƒžã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
sudo mkdir -p /mnt/backup-hdd

# å¤–ä»˜ã‘HDDã®ãƒžã‚¦ãƒ³ãƒˆ
sudo mount /dev/sdd1 /mnt/backup-hdd

# ãƒžã‚¦ãƒ³ãƒˆç¢ºèª
df -h /mnt/backup-hdd
ls -la /mnt/backup-hdd
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb1       916G  77M  870G   1% /mnt/backup
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `mount | grep /mnt/backup` ã‚’å®Ÿè¡Œã™ã‚‹
- **æœŸå¾…çµæžœ**: /dev/sdb1 ãŒ /mnt/backup ã«ãƒžã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹
- **å¤±æ•—æ™‚**: ãƒ‡ãƒã‚¤ã‚¹ãŒä½¿ç”¨ä¸­ã§ãªã„ã‹ç¢ºèªã€`sudo umount /mnt/backup` å¾Œã«å†ãƒžã‚¦ãƒ³ãƒˆ

---

### ã‚¹ãƒ†ãƒƒãƒ—4: UUIDã®å–å¾—ã¨/etc/fstabè¨­å®šï¼ˆè‡ªå‹•ãƒžã‚¦ãƒ³ãƒˆï¼‰

OSå†èµ·å‹•å¾Œã‚‚è‡ªå‹•ãƒžã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã€/etc/fstab ã«è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# UUIDã®å–å¾—
UUID=$(sudo blkid /dev/sdd1 | grep -oP 'UUID="\K[^"]+')
echo "UUID: $UUID"

# /etc/fstabã¸ã®ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
echo "UUID=$UUID /mnt/backup-hdd ext4 defaults,nofail 0 2" | sudo tee -a /etc/fstab

# è¨­å®šç¢ºèª
sudo cat /etc/fstab | grep backup-hdd
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
UUID: xxxx-xxxx-xxxx-xxxx
UUID=xxxx-xxxx-xxxx-xxxx /mnt/backup ext4 defaults,nofail 0 2
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `sudo mount -a` ã‚’å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‹ç¢ºèªã™ã‚‹
- **æœŸå¾…çµæžœ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„
- **å¤±æ•—æ™‚**: /etc/fstab ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ç¢ºèªã€`sudo mount -a -v` ã§è©³ç´°ç¢ºèª

**æ³¨æ„**: `nofail` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚Šã€å¤–ä»˜ã‘HDDæŽ¥ç¶šãªã—ã§ã‚‚OSãŒèµ·å‹•ã—ã¾ã™ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½œæˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
sudo mkdir -p /mnt/backup-hdd/docker/{volumes,images,compose,swarm,logs}

# æ¨©é™è¨­å®š
sudo chown -R root:root /mnt/backup-hdd/docker
sudo chmod -R 755 /mnt/backup-hdd/docker

# ç¢ºèª
tree -L 2 /mnt/backup-hdd/docker || ls -la /mnt/backup-hdd/docker
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
/mnt/backup/docker
â”œâ”€â”€ compose
â”œâ”€â”€ images
â”œâ”€â”€ logs
â”œâ”€â”€ swarm
â””â”€â”€ volumes
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `ls -la /mnt/backup/docker` ã‚’å®Ÿè¡Œã™ã‚‹
- **æœŸå¾…çµæžœ**: volumes, images, compose, swarm, logs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹
- **å¤±æ•—æ™‚**: æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ sudo ã‚’ä½¿ç”¨ã—ã¦å†å®Ÿè¡Œ

---

### ã‚¹ãƒ†ãƒƒãƒ—6: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

é€±1å›žå®Ÿè¡Œã•ã‚Œã‚‹è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
sudo tee /usr/local/bin/docker-backup.sh > /dev/null <<'EOF'
#!/bin/bash

# Docker ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
# å®Ÿè¡Œé »åº¦: é€±1å›žï¼ˆæ—¥æ›œæ—¥ 2:00AMï¼‰

set -eo pipefail

BACKUP_ROOT="/mnt/backup-hdd/docker"
DATE=$(date +%Y%m%d)
BACKUP_DIR="$BACKUP_ROOT/$DATE"
LOG_FILE="/var/log/docker-backup.log"
SUCCESS_COUNT=0
FAILURE_COUNT=0

# ãƒ­ã‚°è¨˜éŒ²é–¢æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹
log "=== Docker Backup Started ==="

# ãƒžã‚¦ãƒ³ãƒˆç¢ºèª
if ! mountpoint -q /mnt/backup-hdd; then
    log "ERROR: /mnt/backup-hdd is not mounted. Aborting."
    exit 1
fi

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$BACKUP_DIR"/{volumes,images,compose,swarm}

# 1. Dockerãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
log "Backing up Docker volumes..."
if [ -d /data/docker/volumes ]; then
    if rsync -av /data/docker/volumes/ "$BACKUP_DIR/volumes/" >> "$LOG_FILE" 2>&1; then
        log "Volumes backup completed"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Volumes backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—: Dockerãƒœãƒªãƒ¥ãƒ¼ãƒ "
    fi
else
    log "WARNING: /data/docker/volumes not found"
fi

# 2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
log "Backing up Docker images..."
if [ "$(docker images -q | wc -l)" -gt 0 ]; then
    if docker images --format "{{.Repository}}:{{.Tag}}" | \
        xargs -I {} docker save {} 2>/dev/null | \
        gzip > "$BACKUP_DIR/images/all-images-$DATE.tar.gz"; then
        log "Images backup completed: $(du -sh $BACKUP_DIR/images/all-images-$DATE.tar.gz 2>/dev/null | cut -f1)"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Images backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸"
    fi
else
    log "INFO: No Docker images to backup"
fi

# 3. Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
log "Backing up Docker Compose files..."
if [ -d /data/docker-compose ]; then
    if rsync -av /data/docker-compose/ "$BACKUP_DIR/compose/" >> "$LOG_FILE" 2>&1; then
        log "Compose files backup completed"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        log "ERROR: Compose files backup failed"
        FAILURE_COUNT=$((FAILURE_COUNT + 1))
        [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—: Docker Composeãƒ•ã‚¡ã‚¤ãƒ«"
    fi
else
    log "INFO: /data/docker-compose not found"
fi

# 4. Docker Swarmè¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
log "Backing up Docker Swarm configs..."
if docker config ls --format "{{.Name}}" 2>/dev/null | \
    xargs -I {} docker config inspect {} > "$BACKUP_DIR/swarm/configs.json" 2>/dev/null && \
   docker secret ls --format "{{.Name}}" 2>/dev/null | \
    xargs -I {} docker secret inspect {} > "$BACKUP_DIR/swarm/secrets.json" 2>/dev/null; then
    log "Swarm configs backup completed"
    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
else
    log "WARNING: Swarm configs backup failed (may not be initialized)"
fi

# 5. ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆï¼ˆæ•´åˆæ€§æ¤œè¨¼ç”¨ï¼‰
log "Generating checksums..."
if cd "$BACKUP_DIR" && find . -type f -exec md5sum {} \; > checksums.md5 2>/dev/null; then
    log "Checksums saved: checksums.md5"
    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
else
    log "ERROR: Checksum generation failed"
    FAILURE_COUNT=$((FAILURE_COUNT + 1))
fi

# 6. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
chmod -R 600 "$BACKUP_DIR" 2>/dev/null || log "WARNING: Permission setting failed"

# 7. å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šå¤ã„ã‚‚ã®ï¼‰
log "Cleaning up old backups..."
find "$BACKUP_ROOT" -maxdepth 1 -type d -name "20*" -mtime +30 -exec rm -rf {} \;
log "Old backups cleaned"

# æœ€çµ‚çµæžœ
log "=== Docker Backup Completed ==="
log "Success: $SUCCESS_COUNT tasks, Failures: $FAILURE_COUNT tasks"
log "Total backup size: $(du -sh $BACKUP_DIR 2>/dev/null | cut -f1)"

if [ "$FAILURE_COUNT" -gt 0 ]; then
    log "WARNING: Backup completed with $FAILURE_COUNT failures"
    [ -x /usr/local/bin/send-alert.sh ] && /usr/local/bin/send-alert.sh "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—éƒ¨åˆ†å¤±æ•—: $SUCCESS_COUNTæˆåŠŸ, $FAILURE_COUNTå¤±æ•—"
    exit 1
fi

exit 0
EOF

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ä»˜ä¸Ž
sudo chmod +x /usr/local/bin/docker-backup.sh

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
ls -la /usr/local/bin/docker-backup.sh
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
-rwxr-xr-x 1 root root ... /usr/local/bin/docker-backup.sh
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `sudo bash -n /usr/local/bin/docker-backup.sh` ã‚’å®Ÿè¡Œã™ã‚‹ï¼ˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼‰
- **æœŸå¾…çµæžœ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„
- **å¤±æ•—æ™‚**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹ã‚’å†ç¢ºèªã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£

---

### ã‚¹ãƒ†ãƒƒãƒ—7: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ‰‹å‹•å®Ÿè¡Œãƒ†ã‚¹ãƒˆ

ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ã€æ‰‹å‹•å®Ÿè¡Œã—ã¦ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ‰‹å‹•å®Ÿè¡Œ
sudo /usr/local/bin/docker-backup.sh

# ãƒ­ã‚°ç¢ºèª
sudo tail -30 /var/log/docker-backup.log

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
ls -lh /mnt/backup/docker/$(date +%Y%m%d)/
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
[2024-xx-xx xx:xx:xx] === Docker Backup Started ===
[2024-xx-xx xx:xx:xx] Backing up Docker volumes...
[2024-xx-xx xx:xx:xx] Volumes backup completed
[2024-xx-xx xx:xx:xx] Backing up Docker images...
[2024-xx-xx xx:xx:xx] Images backup completed: xxxM
[2024-xx-xx xx:xx:xx] === Docker Backup Completed ===
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `ls /mnt/backup/docker/$(date +%Y%m%d)` ã‚’å®Ÿè¡Œã™ã‚‹
- **æœŸå¾…çµæžœ**: volumes, images, compose, swarm ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹
- **å¤±æ•—æ™‚**: `/var/log/docker-backup.log` ã§ã‚¨ãƒ©ãƒ¼å†…å®¹ç¢ºèªã€ãƒžã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆç¢ºèª

---

### ã‚¹ãƒ†ãƒƒãƒ—8: cronè¨­å®šï¼ˆé€±1å›žè‡ªå‹•å®Ÿè¡Œï¼‰

cronã‚’ä½¿ç”¨ã—ã¦ã€é€±1å›žï¼ˆæ—¥æ›œæ—¥2:00AMï¼‰è‡ªå‹•å®Ÿè¡Œã™ã‚‹ã‚ˆã†è¨­å®šã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# cronè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
sudo tee /etc/cron.d/docker-backup > /dev/null <<'EOF'
# Dockerè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# æ¯Žé€±æ—¥æ›œæ—¥ 2:00AM ã«å®Ÿè¡Œ
0 2 * * 0 root /usr/local/bin/docker-backup.sh >> /var/log/docker-backup.log 2>&1
EOF

# cronè¨­å®šã®ç¢ºèª
sudo cat /etc/cron.d/docker-backup

# cronã‚µãƒ¼ãƒ“ã‚¹ã®å†èª­ã¿è¾¼ã¿
sudo systemctl reload crond

# cronå®Ÿè¡Œãƒ­ã‚°ç¢ºèªï¼ˆæ¬¡å›žå®Ÿè¡Œæ™‚ã«ç¢ºèªï¼‰
sudo journalctl -u crond --since today
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
# Dockerè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# æ¯Žé€±æ—¥æ›œæ—¥ 2:00AM ã«å®Ÿè¡Œ
0 2 * * 0 root /usr/local/bin/docker-backup.sh >> /var/log/docker-backup.log 2>&1
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `sudo ls /etc/cron.d/docker-backup` ã¾ãŸã¯ `sudo cat /etc/cron.d/docker-backup` ã‚’å®Ÿè¡Œã™ã‚‹
- **æœŸå¾…çµæžœ**: docker-backup ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€è¨­å®šãŒæ­£ã—ã„
- **å¤±æ•—æ™‚**: cronæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ç¢ºèªã€crondã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª `systemctl status crond`

---

### ã‚¹ãƒ†ãƒƒãƒ—9: ãƒªã‚¹ãƒˆã‚¢æ‰‹é †ã®ãƒ†ã‚¹ãƒˆ

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®ãƒªã‚¹ãƒˆã‚¢ï¼ˆå¾©å…ƒï¼‰ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒ†ã‚¹ãƒˆç”¨ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ä½œæˆ
docker volume create test-volume
echo "test data" | docker run --rm -v test-volume:/data alpine sh -c 'cat > /data/test.txt'

# ãƒ‡ãƒ¼ã‚¿ç¢ºèª
docker run --rm -v test-volume:/data alpine cat /data/test.txt

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
sudo /usr/local/bin/docker-backup.sh

# ãƒ†ã‚¹ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’å‰Šé™¤
docker volume rm test-volume

# ãƒªã‚¹ãƒˆã‚¢ï¼ˆå¾©å…ƒï¼‰å®Ÿè¡Œ
BACKUP_DATE=$(date +%Y%m%d)
docker volume create test-volume
sudo rsync -av /mnt/backup-hdd/docker/$BACKUP_DATE/volumes/test-volume/_data/ \
    /var/lib/docker/volumes/test-volume/_data/

# ãƒ‡ãƒ¼ã‚¿å¾©å…ƒç¢ºèª
docker run --rm -v test-volume:/data alpine cat /data/test.txt

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
docker volume rm test-volume
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
test data
ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚°ï¼‰
test data
ï¼ˆãƒªã‚¹ãƒˆã‚¢æˆåŠŸï¼‰
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ãƒªã‚¹ãƒˆã‚¢å¾Œã®ãƒ‡ãƒ¼ã‚¿ç¢ºèªã§ "test data" ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã™ã‚‹
- **æœŸå¾…çµæžœ**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã‚‹
- **å¤±æ•—æ™‚**: rsyncã®ãƒ‘ã‚¹ç¢ºèªã€æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯sudoä½¿ç”¨ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª

---

### ã‚¹ãƒ†ãƒƒãƒ—10: ã‚¹ãƒ¯ãƒƒãƒ—å‹•ä½œã®æœ€é©åŒ–ï¼ˆswappinessè¨­å®šï¼‰

Dockerãƒ›ã‚¹ãƒˆã®ã‚¹ãƒ¯ãƒƒãƒ—ä½¿ç”¨ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ãŸã‚ã€`vm.swappiness` ã‚’ 10 ã«è¨­å®šã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰

```bash
# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
sudo tee /etc/sysctl.d/99-docker-performance.conf > /dev/null <<'EOF'
vm.swappiness = 10
EOF

# è¨­å®šã®å³æ™‚åæ˜ 
sudo sysctl -p /etc/sysctl.d/99-docker-performance.conf

# ç¾åœ¨å€¤ã®ç¢ºèª
cat /proc/sys/vm/swappiness
```

#### æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›

```
vm.swappiness = 10
10
```

#### æ¤œè¨¼é …ç›®

- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: `cat /proc/sys/vm/swappiness` ã‚’å®Ÿè¡Œã—ã€å€¤ãŒ `10` ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
- **æœŸå¾…çµæžœ**: `10` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- **å¤±æ•—æ™‚**: `/etc/sysctl.d/99-docker-performance.conf` ã®å†…å®¹ã‚’ç¢ºèªã—ã€èª¤è¨˜ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã€‚å¿…è¦ã«å¿œã˜ã¦ `sudo sysctl -w vm.swappiness=10` ã‚’å†å®Ÿè¡Œã™ã‚‹

---

## åŒ…æ‹¬çš„å‹•ä½œç¢ºèªæ‰‹é †

### 1. å¤–ä»˜ã‘HDDçŠ¶æ…‹ç¢ºèª

```bash
# ãƒžã‚¦ãƒ³ãƒˆçŠ¶æ…‹ç¢ºèª
mountpoint /mnt/backup-hdd
df -h /mnt/backup-hdd

# fstabè¨­å®šç¢ºèª
grep backup /etc/fstab

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³ç¢ºèª
du -sh /mnt/backup-hdd/docker
```

**æœŸå¾…ã•ã‚Œã‚‹çµæžœ**:
- /mnt/backup ãŒãƒžã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹
- fstabã«è‡ªå‹•ãƒžã‚¦ãƒ³ãƒˆè¨­å®šãŒå­˜åœ¨
- ååˆ†ãªç©ºãå®¹é‡ãŒã‚ã‚‹

---

### 2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•ä½œç¢ºèª

```bash
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå­˜åœ¨ç¢ºèª
ls -la /usr/local/bin/docker-backup.sh

# å®Ÿè¡Œæ¨©é™ç¢ºèª
sudo bash -n /usr/local/bin/docker-backup.sh

# æ‰‹å‹•å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
sudo /usr/local/bin/docker-backup.sh

# ãƒ­ã‚°ç¢ºèª
sudo tail -50 /var/log/docker-backup.log
```

**æœŸå¾…ã•ã‚Œã‚‹çµæžœ**:
- ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œå¯èƒ½
- ã‚¨ãƒ©ãƒ¼ãªãå®Œäº†
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨˜éŒ²

---

### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
ls -la /mnt/backup-hdd/docker/$(date +%Y%m%d)

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
ls -la /mnt/backup-hdd/docker/$(date +%Y%m%d)/volumes/

# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
ls -lh /mnt/backup-hdd/docker/$(date +%Y%m%d)/images/

# Composeãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
ls -la /mnt/backup-hdd/docker/$(date +%Y%m%d)/compose/
```

**æœŸå¾…ã•ã‚Œã‚‹çµæžœ**:
- å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨
- ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©åˆ‡ãªã‚µã‚¤ã‚ºï¼ˆæ•°MBã€œæ•°GBï¼‰
- ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨

---

### 4. cronè¨­å®šç¢ºèª

```bash
# cronè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
sudo cat /etc/cron.d/docker-backup

# crondã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
sudo systemctl status crond

# cronå®Ÿè¡Œå±¥æ­´ç¢ºèªï¼ˆæ¬¡å›žå®Ÿè¡Œå¾Œï¼‰
sudo grep docker-backup /var/log/cron
```

**æœŸå¾…ã•ã‚Œã‚‹çµæžœ**:
- cronè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹
- crondã‚µãƒ¼ãƒ“ã‚¹ãŒ active (running)
- è‡ªå‹•èµ·å‹•ãŒæœ‰åŠ¹

---

### 5. ãƒªã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆç¢ºèª

```bash
# æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥ä»˜ç¢ºèª
LATEST_BACKUP=$(ls -1 /mnt/backup-hdd/docker/ | grep "^20" | sort -r | head -1)
echo "Latest backup: $LATEST_BACKUP"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
find /mnt/backup-hdd/docker/$LATEST_BACKUP -type f | wc -l
```

**æœŸå¾…ã•ã‚Œã‚‹çµæžœ**:
- æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨
- è¤‡æ•°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨

---

## æœ€çµ‚ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ä»¥ä¸‹ã®å…¨é …ç›®ãŒ âœ… ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] å¤–ä»˜ã‘HDDãŒæŽ¥ç¶šã•ã‚Œã€èªè­˜ã•ã‚Œã¦ã„ã‚‹ï¼ˆ`lsblk`ï¼‰
- [ ] å¤–ä»˜ã‘HDDãŒãƒžã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ï¼ˆ`mountpoint /mnt/backup`ï¼‰
- [ ] /etc/fstab ã«è‡ªå‹•ãƒžã‚¦ãƒ³ãƒˆè¨­å®šãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆ`ls /mnt/backup/docker`ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå­˜åœ¨ã—ã€å®Ÿè¡Œå¯èƒ½ï¼ˆ`ls -la /usr/local/bin/docker-backup.sh`ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ‰‹å‹•å®Ÿè¡Œã§æˆåŠŸã™ã‚‹
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆ`/var/log/docker-backup.log`ï¼‰
- [ ] cronè¨­å®šãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã‚‹ï¼ˆ`/etc/cron.d/docker-backup`ï¼‰
- [ ] crondã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹ï¼ˆ`systemctl status crond`ï¼‰
- [ ] ãƒªã‚¹ãƒˆã‚¢ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ï¼ˆ`ls /mnt/backup/docker/`ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒé©åˆ‡ï¼ˆæ•°MBä»¥ä¸Šï¼‰
- [ ] å¤–ä»˜ã‘HDDæŽ¥ç¶šãªã—ã§ã‚‚OSèµ·å‹•å¯èƒ½ï¼ˆnofailã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**âœ… ä¸Šè¨˜ã®å…¨ç¢ºèªé …ç›®ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿**ã€æ¬¡ã®æ‰‹é †ã«é€²ã‚“ã§ãã ã•ã„ã€‚

- **Phase 3.3**: ç›£è¦–ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šï¼ˆ`procedures/3.3-monitoring-security-setup.md`ï¼‰

å•é¡ŒãŒç™ºè¦‹ã•ã‚ŒãŸå ´åˆã¯ã€è©²å½“ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦è§£æ±ºã—ã¦ã‹ã‚‰æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²è¡Œã—ã¦ãã ã•ã„ã€‚

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å¤–ä»˜ã‘HDDãŒèªè­˜ã•ã‚Œãªã„

**ç—‡çŠ¶**: `lsblk` ã«å¤–ä»˜ã‘HDDãŒè¡¨ç¤ºã•ã‚Œãªã„

**ç¢ºèª**:
```bash
dmesg | tail -30
lsusb
```

**åŽŸå› ã¨å¯¾ç­–**:
1. **USBæŽ¥ç¶šä¸è‰¯**: ã‚±ãƒ¼ãƒ–ãƒ«æŽ¥ç¶šç¢ºèªã€åˆ¥ã®USBãƒãƒ¼ãƒˆè©¦è¡Œ
2. **é›»æºä¸è¶³**: USB 3.0ãƒãƒ¼ãƒˆä½¿ç”¨ã€å¤–éƒ¨é›»æºä»˜ãHDDä½¿ç”¨
3. **ãƒ‰ãƒ©ã‚¤ãƒå•é¡Œ**: `sudo modprobe usb-storage` ã§ãƒ‰ãƒ©ã‚¤ãƒãƒ­ãƒ¼ãƒ‰

---

### ãƒžã‚¦ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `sudo mount /dev/sdb1 /mnt/backup` ãŒã‚¨ãƒ©ãƒ¼

**ç¢ºèª**:
```bash
sudo mount -v /dev/sdb1 /mnt/backup
dmesg | grep -i error
```

**åŽŸå› ã¨å¯¾ç­–**:
1. **æ—¢ã«ãƒžã‚¦ãƒ³ãƒˆæ¸ˆã¿**: `sudo umount /mnt/backup` å¾Œã«å†ãƒžã‚¦ãƒ³ãƒˆ
2. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸æ­£**: `sudo fsck /dev/sdb1` ã§ä¿®å¾©
3. **æ¨©é™ä¸è¶³**: sudo ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œ

---

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå¤±æ•—

**ç—‡çŠ¶**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚¨ãƒ©ãƒ¼ã§çµ‚äº†

**ç¢ºèª**:
```bash
sudo /usr/local/bin/docker-backup.sh
sudo cat /var/log/docker-backup.log
```

**åŽŸå› ã¨å¯¾ç­–**:
1. **/mnt/backupæœªãƒžã‚¦ãƒ³ãƒˆ**: `mountpoint /mnt/backup` ç¢ºèªã€æ‰‹å‹•ãƒžã‚¦ãƒ³ãƒˆ
2. **ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³**: `df -h /mnt/backup` ç¢ºèªã€å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤
3. **æ¨©é™ã‚¨ãƒ©ãƒ¼**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’rootæ¨©é™ã§å®Ÿè¡Œ

---

### cronè‡ªå‹•å®Ÿè¡Œã•ã‚Œãªã„

**ç—‡çŠ¶**: æ—¥æ›œæ—¥2:00AMã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œãªã„

**ç¢ºèª**:
```bash
sudo systemctl status crond
sudo grep docker-backup /var/log/cron
sudo cat /etc/cron.d/docker-backup
```

**åŽŸå› ã¨å¯¾ç­–**:
1. **crondã‚µãƒ¼ãƒ“ã‚¹åœæ­¢**: `sudo systemctl start crond && sudo systemctl enable crond`
2. **cronæ§‹æ–‡ã‚¨ãƒ©ãƒ¼**: `/etc/cron.d/docker-backup` ã®æ§‹æ–‡ç¢ºèª
3. **æ™‚åˆ»ãšã‚Œ**: `timedatectl` ã§æ™‚åˆ»ç¢ºèªã€NTPåŒæœŸè¨­å®š

---

### ãƒªã‚¹ãƒˆã‚¢å¤±æ•—

**ç—‡çŠ¶**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©å…ƒãŒã§ããªã„

**ç¢ºèª**:
```bash
ls -la /mnt/backup/docker/$(date +%Y%m%d)/volumes/
ls -la /var/lib/docker/volumes/
```

**åŽŸå› ã¨å¯¾ç­–**:
1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ä¸åœ¨**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæ­£å¸¸å®Ÿè¡Œã•ã‚ŒãŸã‹ç¢ºèª
2. **ãƒ‘ã‚¹é–“é•ã„**: rsyncã®ã‚½ãƒ¼ã‚¹ãƒ»å®›å…ˆãƒ‘ã‚¹ç¢ºèª
3. **æ¨©é™ã‚¨ãƒ©ãƒ¼**: sudo ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¹ãƒˆã‚¢å®Ÿè¡Œ

---

## ä¿®æ­£å±¥æ­´

### Version 1.1 (2025-01-28)
**ä¿®æ­£å†…å®¹**:
1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–** (èª²é¡Œ#4å¯¾å¿œ - ðŸ”´ CRITICAL)
   - ç†ç”±: éƒ¨åˆ†çš„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—æ™‚ã®å‡¦ç†ãŒä¸æ˜Žç¢ºã§ã€ã‚µã‚¤ãƒ¬ãƒ³ãƒˆéšœå®³ã®ãƒªã‚¹ã‚¯ãŒã‚ã£ãŸ
   - è¿½åŠ æ©Ÿèƒ½:
     - SUCCESS_COUNT/FAILURE_COUNTã‚«ã‚¦ãƒ³ã‚¿ã«ã‚ˆã‚‹æˆåŠŸ/å¤±æ•—è¿½è·¡
     - å„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒƒãƒ—ã§ã®å€‹åˆ¥ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
     - å¤±æ•—æ™‚ã®Discordã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ï¼ˆsend-alert.shçµŒç”±ï¼‰
     - éƒ¨åˆ†å¤±æ•—æ™‚ã® exit 1 ã«ã‚ˆã‚‹æ˜Žç¢ºãªå¤±æ•—é€šçŸ¥
   - å½±éŸ¿: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—éšœå®³ã®æ—©æœŸæ¤œçŸ¥ã¨å¯¾å¿œãŒå¯èƒ½ã«

2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§æ¤œè¨¼ã®è‡ªå‹•åŒ–** (èª²é¡Œ#7å¯¾å¿œ - ðŸŸ¡ IMPORTANT)
   - ç†ç”±: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ç ´ææ¤œçŸ¥æ©Ÿæ§‹ãŒæ¬ å¦‚ã—ã¦ã„ãŸ
   - è¿½åŠ æ©Ÿèƒ½:
     - md5sumã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ã‚µãƒ è‡ªå‹•ç”Ÿæˆ
     - checksums.md5ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ä¿å­˜
     - å°†æ¥ã®ãƒªã‚¹ãƒˆã‚¢å‰æ¤œè¨¼ã«åˆ©ç”¨å¯èƒ½
   - å½±éŸ¿: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼ã¨ãƒªã‚¹ãƒˆã‚¢ä¿¡é ¼æ€§ã®å‘ä¸Š

3. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š** (èª²é¡Œ#4é–¢é€£ - ðŸŸ¡ IMPORTANT)
   - ç†ç”±: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ãŸã‚æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æ¨©é™åˆ¶å¾¡ãŒå¿…è¦
   - è¿½åŠ æ©Ÿèƒ½:
     ```bash
     chmod -R 600 "$BACKUP_DIR"
     ```
   - å½±éŸ¿: rootä»¥å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š

4. **rsync --deleteã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å‰Šé™¤** (èª²é¡Œ#1é–¢é€£ - ðŸŸ¡ IMPORTANT)
   - ç†ç”±: åˆå›žãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã®ãƒ‡ãƒ¼ã‚¿å–ªå¤±ãƒªã‚¹ã‚¯è»½æ¸›
   - å¤‰æ›´: `rsync -av --delete` â†’ `rsync -av`
   - å½±éŸ¿: å®‰å…¨æ€§ã®å‘ä¸Šï¼ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç®¡ç†ã¯åˆ¥é€”å®Ÿæ–½ï¼‰

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ä¾‹**:
```
[2025-01-28 02:00:15] === Docker Backup Started ===
[2025-01-28 02:00:20] Volumes backup completed
[2025-01-28 02:00:45] Images backup completed: 2.3G
[2025-01-28 02:00:50] Compose files backup completed
[2025-01-28 02:00:52] Swarm configs backup completed
[2025-01-28 02:01:10] Checksums saved: checksums.md5
[2025-01-28 02:01:15] Old backups cleaned
[2025-01-28 02:01:15] === Docker Backup Completed ===
[2025-01-28 02:01:15] Success: 5 tasks, Failures: 0 tasks
[2025-01-28 02:01:15] Total backup size: 2.5G
```

**å½±éŸ¿åº¦è©•ä¾¡**:
- ðŸ”´ CRITICAL: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—æ¤œçŸ¥æ©Ÿèƒ½ï¼ˆèª²é¡Œ#4ï¼‰
- ðŸŸ¡ IMPORTANT: æ•´åˆæ€§æ¤œè¨¼ï¼ˆèª²é¡Œ#7ï¼‰ã€ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®šã€rsyncå®‰å…¨åŒ–

---

**END OF DOCUMENT**
