# Phase 1: KVM 最小構成環境の構築

## 概要

Phase: phase_1_minimal

## 前提条件

- Rocky Linux 9.6 がインストールされていること
- root 権限または sudo 権限があること
- インターネット接続が利用可能であること
- CPU 仮想化機能が有効であること

## 推定所要時間

1 時間 5 分

## 構築手順

### ステップ 1: システム要件の確認

KVM 仮想化環境構築のためのシステム要件を確認します。CPU 仮想化サポート、十分なメモリ、ストレージ容量を検証します。

#### 実行コマンド

```bash
# CPU仮想化サポートの確認
```

```bash
egrep -c '(vmx|svm)' /proc/cpuinfo
```

```bash
# メモリ容量の確認
```

```bash
free -h
```

```bash
# ディスク容量の確認
```

```bash
df -h
```

#### 期待される出力

```
CPU仮想化サポート: 1以上の数値
メモリ: 8GB以上の空き容量
ディスク: 100GB以上の空き容量
```

#### 検証項目

- CPU 仮想化機能が有効であること
- 8GB 以上のメモリが利用可能であること
- 100GB 以上のディスク容量があること

#### トラブルシューティング

- CPU 仮想化が無効の場合: BIOS/UEFI で仮想化機能を有効化
- メモリ不足の場合: 不要なプロセスを停止
- ディスク容量不足の場合: 不要ファイルを削除

---

### ステップ 2: KVM/QEMU/LibVirt のインストール

仮想化に必要なパッケージをインストールします。KVM ハイパーバイザー、QEMU エミュレーター、LibVirt 管理ツールを導入します。

#### 実行コマンド

```bash
# パッケージリストの更新
```

```bash
sudo dnf update -y
```

```bash
# KVM関連パッケージのインストール
```

```bash
sudo dnf install -y qemu-kvm libvirt virt-install virt-manager
```

```bash
# 追加ツールのインストール（Rocky 9対応）
```

```bash
sudo dnf install -y virt-top libguestfs-tools
```

#### 期待される出力

```
パッケージが正常にインストールされ、エラーメッセージが表示されないこと
```

#### 検証項目

- qemu-kvm パッケージがインストールされていること
- libvirtd サービスが利用可能であること
- virt-manager が起動可能であること
- **注意**: bridge-utils は Rocky 9 では削除済み（NetworkManager が代替）

#### トラブルシューティング

- パッケージが見つからない場合: EPEL リポジトリを有効化
- 権限エラーの場合: sudo コマンドを使用
- ネットワークエラーの場合: インターネット接続を確認

---

### ステップ 3: LibVirt サービスの起動と設定

LibVirt 管理サービスを起動し、自動起動を設定します。ユーザーを libvirt グループに追加して管理権限を付与します。

#### 実行コマンド

```bash
# LibVirtサービスの起動
```

```bash
sudo systemctl start libvirtd
```

```bash
# 自動起動の設定
```

```bash
sudo systemctl enable libvirtd
```

```bash
# ユーザーをlibvirtグループに追加
```

```bash
sudo usermod -aG libvirt $USER
```

```bash
# サービス状態の確認
```

```bash
sudo systemctl status libvirtd
```

#### 期待される出力

```
libvirtdサービスがactive (running)状態であること
```

#### 検証項目

- libvirtd サービスが起動していること
- 自動起動が有効になっていること
- 現在のユーザーが libvirt グループに所属していること

#### トラブルシューティング

- サービス起動失敗の場合: journalctl -u libvirtd でログを確認
- 権限エラーの場合: ログアウト・ログインでグループ変更を反映
- ポート競合の場合: 他の仮想化ソフトウェアを停止

---

### ステップ 4: デフォルトネットワークの確認と設定（テスト用）

LibVirt のデフォルト NAT ネットワークを確認し、テスト用として設定します。

**⚠️ 重要**: この default ネットワーク（192.168.122.0/24）は Phase 1 のテスト用です。Phase 2（タスク 2.2）で AWS VPC 相当の独自ネットワーク（10.0.x.0/24）に移行し、default ネットワークは停止します。

#### 実行コマンド

```bash
# ネットワーク一覧の確認
```

```bash
virsh net-list --all
```

```bash
# デフォルトネットワークの起動
```

```bash
virsh net-start default
```

```bash
# 自動起動の設定
```

```bash
virsh net-autostart default
```

```bash
# ネットワーク設定の確認
```

```bash
virsh net-dumpxml default
```

#### 期待される出力

```
defaultネットワークがactive状態で、autostart=yesになっていること
```

#### 検証項目

- default ネットワークが起動していること
- 自動起動が設定されていること
- 192.168.122.0/24 の IP アドレス範囲が設定されていること

#### トラブルシューティング

- ネットワーク起動失敗の場合: iptables ルールを確認
- IP 競合の場合: 別のサブネット範囲に変更
- DNS 問題の場合: /etc/resolv.conf を確認

---

### ステップ 5: 最初の VM の作成とテスト（テスト用）

最小構成のテスト VM を作成し、基本的な動作を確認します。

**⚠️ 注意**: この VM は default ネットワーク上で作成されます。Phase 2（タスク 2.2）で独自ネットワークに移行するため、この VM は一時的なテスト用です。

#### 実行コマンド

```bash
# VM用ディスクイメージの作成
```

```bash
qemu-img create -f qcow2 /var/lib/libvirt/images/test-vm.qcow2 10G
```

```bash
# CentOS Stream 9のISOダウンロード（例）
```

```bash
cd /var/lib/libvirt/images/
```

```bash
sudo wget https://mirror.stream.centos.org/9-stream/BaseOS/x86_64/iso/CentOS-Stream-9-latest-x86_64-boot.iso
```

```bash
# VMの作成（対話式インストール）
```

```bash
sudo virt-install \
  --name test-vm \
  --ram 2048 \
  --vcpus 2 \
  --os-variant centos8 \
  --disk path=/var/lib/libvirt/images/test-vm.qcow2,bus=virtio \
  --network bridge=virbr0,model=virtio \
  --graphics none \
  --location /var/lib/libvirt/images/CentOS-Stream-9-latest-x86_64-boot.iso \
  --extra-args="console=ttyS0,115200n8"
```

#### 期待される出力

```
VMが正常に作成され、インストール画面が表示されること
```

#### 検証項目

- VM が作成されていること
- VNC コンソールでアクセス可能であること
- ネットワーク接続が確立されていること

#### トラブルシューティング

- ディスク作成失敗の場合: /var/lib/libvirt/images の権限を確認
- ISO 取得失敗の場合: 別のミラーサイトを使用
- VM 起動失敗の場合: ハードウェア仮想化が有効か確認

```bash
sudo virsh list --all # 起動中のVM確認
sudo virsh shutdown test-vm # 起動中のVMの停止
sudo virsh undefine test-vm --remove-all-storage # VM定義削除
sudo rm -f /var/lib/libvirt/images/test-vm.qcow2 # ストレージイメージを削除
sudo qemu-img create -f qcow2 /var/lib/libvirt/images/test-vm.qcow2 10G # 再作成
```

---

## 包括的動作確認手順

### 1. KVM ホスト環境の基本動作確認

#### 1.1 LibVirt サービスの詳細状態確認

```bash
# サービス状態の詳細確認
sudo systemctl status libvirtd
sudo systemctl is-enabled libvirtd
sudo systemctl is-active libvirtd

# LibVirtデーモンの動作確認
sudo virsh version
sudo virsh nodeinfo
```

**期待される結果**:

- libvirtd サービスが `active (running)` 状態
- 自動起動が `enabled` 状態
- virsh コマンドが正常に動作し、ホスト情報が表示される

#### 1.2 KVM モジュールの読み込み確認

```bash
# KVMモジュールの確認
lsmod | grep kvm
cat /proc/cpuinfo | grep -E "(vmx|svm)"

# 仮想化機能の動作テスト
sudo virt-host-validate
```

**期待される結果**:

- `kvm` および `kvm_intel` または `kvm_amd` モジュールが読み込まれている
- CPU 仮想化機能が有効
- `virt-host-validate` で全項目が PASS または WARN（重要でない警告）

### 2. ネットワーク機能の検証

#### 2.1 デフォルトネットワークの接続性テスト

```bash
# ネットワーク状態の確認
sudo virsh net-list --all
sudo virsh net-info default

# ブリッジネットワークの確認
ip addr show virbr0
# NetworkManagerでブリッジ情報確認（Rocky 9対応）
nmcli connection show
ip link show type bridge
```

**期待される結果**:

- default ネットワークが `active` 状態で `autostart` が `yes`
- virbr0 ブリッジが存在し、IP アドレス 192.168.122.1 が設定されている
- `ip link show type bridge` で virbr0 が表示される（Rocky 9 では NetworkManager 管理）

#### 2.2 DNS 解決とネットワーク接続の確認

**目的**: VM からインターネットに接続できることを確認

##### 💻 VM 内での確認（test-vm にログイン後）

**前提**: test-vm が起動しており、OS インストールが完了していること

```bash
# VMにコンソール接続
sudo virsh console test-vm
# または VNC接続: virt-viewer test-vm

# === VM内で実行 ===
# VM内でのネットワーク設定確認
ip addr show
ip route show
cat /etc/resolv.conf

# VM内でのDNS解決確認
nslookup google.com
dig google.com

# VM内でのネットワーク接続テスト
ping -c 3 8.8.8.8
ping -c 3 google.com
```

**期待される結果**:

- **VM 側**: DHCP で IP アドレス取得（192.168.122.x）、DNS 解決とインターネット接続が正常

**注意**: ホスト側のネットワーク状態確認は「2.1 デフォルトネットワークの接続性テスト」で既に実施済み

### 3. ストレージ機能の検証

#### 3.1 ストレージプールの動作確認

```bash
# ストレージプールの確認
sudo virsh pool-list --all
sudo virsh pool-info default

# ストレージプールの容量確認
sudo virsh pool-refresh default
sudo virsh vol-list default

# 不要なストレージの削除
sudo virsh pool-destroy `ストレージ名`
sudo virsh pool-undefine `ストレージ名`
sudo rm -rf /var/lib/libvirt/`ストレージ名`
```

**期待される結果**:

- default ストレージプールが `active` 状態
- 十分な容量が利用可能

#### 3.2 仮想ディスクの作成・削除テスト

```bash
# テスト用仮想ディスクの作成
sudo qemu-img create -f qcow2 /var/lib/libvirt/images/test-disk.qcow2 1G

# 作成されたディスクの確認
sudo ls -la /var/lib/libvirt/images/test-disk.qcow2
sudo qemu-img info /var/lib/libvirt/images/test-disk.qcow2

# テスト用ディスクの削除
sudo rm /var/lib/libvirt/images/test-disk.qcow2
```

**期待される結果**:

- 仮想ディスクが正常に作成・削除される
- 適切な権限設定がされている

### 4. VM 作成・管理機能の検証

#### 4.1 テスト VM の作成確認

```bash
# 作成されたVMの確認
sudo virsh list --all
sudo virsh dominfo test-vm

# VM状態の確認
sudo virsh domstate test-vm
```

**期待される結果**:

- test-vm が一覧に表示される
- VM 情報が正常に取得できる

#### 4.2 VM 操作の動作確認

```bash
# VM起動テスト（ISOがある場合）
sudo virsh start test-vm

# VM状態確認
sudo virsh domstate test-vm

# VM停止テスト
sudo virsh shutdown test-vm

# 強制停止テスト
sudo virsh destroy test-vm
```

**期待される結果**:

- VM 起動・停止コマンドが正常に実行される
- 状態変化が正しく反映される

#### 4.3 コンソールアクセスの確認

```bash
# VNCポートの確認
sudo virsh vncdisplay test-vm

# コンソール接続テスト（バックグラウンドで実行）
sudo virsh console test-vm --force &
sleep 2
sudo pkill -f "virsh console"
```

**期待される結果**:

- VNC ポートが正しく割り当てられている
- コンソール接続が可能

### 5. システム全体の統合テスト

#### 5.1 リソース使用量の監視

```bash
# システムリソースの確認
free -h
df -h /var/lib/libvirt/images
top -n 1 -b | head -20

# LibVirt関連プロセスの確認
ps aux | grep -E "(libvirt|qemu|kvm)"
```

**期待される結果**:

- メモリ使用量が適切な範囲内
- ディスク容量に十分な空きがある
- LibVirt 関連プロセスが正常に動作

#### 5.2 エラーログの確認

```bash
# システムログの確認
sudo journalctl -u libvirtd --since "1 hour ago" | grep -i error
sudo journalctl -u libvirtd --since "1 hour ago" | grep -i fail

# 一般的なシステムエラーの確認
sudo dmesg | grep -i error | tail -10
sudo tail -20 /var/log/messages | grep -i error
```

**期待される結果**:

- 致命的なエラーログがない
- 警告レベルのログのみ、または正常なログのみ

### 6. 最終確認チェックリスト

以下の全項目が ✅ になることを確認してください：

- [ ] libvirtd サービスが active (running) 状態
- [ ] KVM モジュールが正常に読み込まれている
- [ ] virt-host-validate で全項目が PASS
- [ ] default ネットワークが active 状態
- [ ] インターネット接続が確立されている
- [ ] ストレージプールが正常に動作
- [ ] 仮想ディスクの作成・削除が可能
- [ ] VM の作成・起動・停止が可能
- [ ] VNC コンソールアクセスが可能
- [ ] システムリソースが正常範囲内
- [ ] 致命的なエラーログがない

## 次のステップ

**✅ 上記の全確認項目が成功した場合のみ**、Phase 2 の構築に進んでください。

## Phase 2 への移行について

**重要**: Phase 2（タスク 2.2）では以下の移行作業を行います：

1. **新しいネットワーク作成**: AWS VPC 相当の独自ネットワーク（10.0.x.0/24 セグメント）
2. **VM 移行**: 既存の test-vm を新しいネットワークに移行
3. **default ネットワーク停止**: テスト用 default ネットワーク（192.168.122.0/24）を無効化

問題が発見された場合は、該当するトラブルシューティングセクションを参照して解決してから次のフェーズに進行してください。
