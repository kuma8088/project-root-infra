# タスク 2.2: 仮想ネットワーク基盤の構築

## 概要

AWS VPC 相当の仮想ネットワーク基盤を構築し、libvirt type=nat 機能を活用してセグメント別ネットワークを作成します。
各セグメントでは libvirt 組み込みの dnsmasq により DNS/DHCP を提供し、ゲートウェイ IP（10.0.x.1）を名称解決・配布元として扱います。

## 前提条件

- Rocky Linux 9.6 がインストールされていること
- タスク 2.1（Rocky Linux ホスト環境設定）が完了していること
- root 権限または sudo 権限があること
- libvirt/KVM が正常に動作していること

## 推定所要時間

60 分

## 構築手順

### ステップ 1: 必要なパッケージの確認とインストール

仮想ネットワーク構築に必要なパッケージがインストールされていることを確認します。

#### 実行コマンド

```bash
# 必要なパッケージの確認
rpm -q libvirt libvirt-daemon libvirt-daemon-config-network libvirt-daemon-driver-network libvirt-client qemu-kvm qemu-img dnsmasq iptables NetworkManager

# 不足しているパッケージのインストール
sudo dnf install -y libvirt libvirt-daemon libvirt-daemon-config-network libvirt-daemon-driver-network libvirt-client qemu-kvm qemu-img dnsmasq iptables NetworkManager

# 管理ツール（必要に応じて）
# sudo dnf install -y virt-manager virt-install

# 仮想化環境一括導入の例（必要に応じて）
# sudo dnf group list --available | grep -i virtualization
# sudo dnf groupinstall -y "Virtualization Host"

# libvirtdサービスの起動と有効化
sudo systemctl enable --now libvirtd
sudo systemctl status libvirtd
```

#### 検証項目

- **アクション**: `rpm -q libvirt libvirt-daemon libvirt-daemon-config-network libvirt-daemon-driver-network libvirt-client qemu-kvm qemu-img dnsmasq iptables NetworkManager` と `systemctl is-active libvirtd` を実行する。
- **期待結果**: すべてのパッケージ名が表示され、`systemctl` の結果が `active` になる。
- **失敗時**: インストールされていないパッケージがある場合は `sudo dnf install <package>` を再実行するか、利用可能なグループを `sudo dnf group list --available | grep -i virtualization` で確認し、`Virtualization Host` または `Virtualization Tools` が表示される場合は `sudo dnf groupinstall -y <group名>` を検討する。`libvirtd` が起動しない場合は `sudo systemctl restart libvirtd` と `sudo journalctl -u libvirtd -xe` でログを確認する。

---

### ステップ 2: Management Network (10.0.0.0/24) の作成

管理用ネットワークを作成します。SSH ポート範囲: 2201-2210
※ VLAN タグ付けは実施せず、libvirt が生成する仮想ブリッジ（`br-mgmt` など）で論理分離します。

#### 実行コマンド

```bash
# ネットワーク設定ディレクトリの作成
sudo mkdir -p /etc/kvm-networks

# Management Network設定ファイルの作成
sudo tee /etc/kvm-networks/kvm-management.xml << 'EOF'
<network>
  <name>kvm-management</name>
  <uuid>$(uuidgen)</uuid>
  <bridge name='br-mgmt' stp='on' delay='0'/>
  <mac address='52:54:00:00:00:01'/>
  <domain name='lab.local'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.0.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.0.10' end='10.0.0.50'/>
    </dhcp>
  </ip>
  <dns>
    <host ip='10.0.0.1'>
      <hostname>gateway.lab.local</hostname>
    </host>
  </dns>
</network>
EOF

# UUIDを実際に生成して置換
sudo sed -i "s/\$(uuidgen)/$(uuidgen)/" /etc/kvm-networks/kvm-management.xml

# ネットワークの定義と開始
sudo virsh net-define /etc/kvm-networks/kvm-management.xml
sudo virsh net-autostart kvm-management
sudo virsh net-start kvm-management
```

#### 検証項目

- **アクション**: `sudo virsh net-info kvm-management` と `sudo virsh net-list --all | grep kvm-management` を実行する。
- **期待結果**: `net-info` で `Active: yes`、`Autostart: yes` が表示され、`net-list` に `active` として `kvm-management` が現れる。
- **失敗時**: `sudo virsh net-undefine kvm-management` で削除後に XML を見直し再定義し、`sudo virsh net-dumpxml kvm-management` で構文エラーがないか確認する。

---

### ステップ 3: Public Subnet (10.0.1.0/24) の作成

パブリックサブネットを作成します。SSH ポート範囲: 2211-2230

#### 実行コマンド

```bash
# Public Network設定ファイルの作成
sudo tee /etc/kvm-networks/kvm-public.xml << 'EOF'
<network>
  <name>kvm-public</name>
  <uuid>$(uuidgen)</uuid>
  <bridge name='br-public' stp='on' delay='0'/>
  <mac address='52:54:00:00:01:01'/>
  <domain name='lab.local'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.1.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.1.100' end='10.0.1.200'/>
    </dhcp>
  </ip>
  <dns>
    <host ip='10.0.1.1'>
      <hostname>public-gateway.lab.local</hostname>
    </host>
  </dns>
</network>
EOF

# UUIDを実際に生成して置換
sudo sed -i "s/\$(uuidgen)/$(uuidgen)/" /etc/kvm-networks/kvm-public.xml

# ネットワークの定義と開始
sudo virsh net-define /etc/kvm-networks/kvm-public.xml
sudo virsh net-autostart kvm-public
sudo virsh net-start kvm-public
```

#### 検証項目

- **アクション**: `sudo virsh net-info kvm-public` と `sudo virsh net-list --all | grep kvm-public` を実行する。
- **期待結果**: `Active: yes` と `Autostart: yes` が表示され、`net-list` に `kvm-public` が `active` として並ぶ。
- **失敗時**: XML 内のブリッジ名や DHCP 範囲が重複していないか見直し、`sudo virsh net-define /etc/kvm-networks/kvm-public.xml` を再実行し、`/var/log/libvirt/libvirtd.log` にエラーがないか確認する。

---

### ステップ 4: Private Subnet (10.0.2.0/24) の作成

プライベートサブネットを作成します。SSH ポート範囲: 2231-2250

#### 実行コマンド

```bash
# Private Network設定ファイルの作成
sudo tee /etc/kvm-networks/kvm-private.xml << 'EOF'
<network>
  <name>kvm-private</name>
  <uuid>$(uuidgen)</uuid>
  <bridge name='br-private' stp='on' delay='0'/>
  <mac address='52:54:00:00:02:01'/>
  <domain name='lab.local'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.2.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.2.100' end='10.0.2.200'/>
    </dhcp>
  </ip>
  <dns>
    <host ip='10.0.2.1'>
      <hostname>private-gateway.lab.local</hostname>
    </host>
  </dns>
</network>
EOF

# UUIDを実際に生成して置換
sudo sed -i "s/\$(uuidgen)/$(uuidgen)/" /etc/kvm-networks/kvm-private.xml

# ネットワークの定義と開始
sudo virsh net-define /etc/kvm-networks/kvm-private.xml
sudo virsh net-autostart kvm-private
sudo virsh net-start kvm-private
```

#### 検証項目

- **アクション**: `sudo virsh net-info kvm-private` と `sudo virsh net-list --all | grep kvm-private` を実行する。
- **期待結果**: `Active: yes` と `Autostart: yes` が表示され、`kvm-private` が `active` として一覧に出る。
- **失敗時**: `kvm-private.xml` の DHCP 範囲が他セグメントと重複していないか確認し、`sudo virsh net-undefine kvm-private` 後に再定義する。`/etc/libvirt/qemu/networks/autostart` にシンボリックリンクが作成されているかも確認する。

---

### ステップ 5: Database Subnet (10.0.3.0/24) の作成

データベース専用サブネットを作成します。SSH ポート範囲: 2251-2260

#### 実行コマンド

```bash
# Database Network設定ファイルの作成
sudo tee /etc/kvm-networks/kvm-database.xml << 'EOF'
<network>
  <name>kvm-database</name>
  <uuid>$(uuidgen)</uuid>
  <bridge name='br-database' stp='on' delay='0'/>
  <mac address='52:54:00:00:03:01'/>
  <domain name='lab.local'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.3.1' netmask='255.255.255.0'>
  </ip>
  <dns>
    <host ip='10.0.3.1'>
      <hostname>db-gateway.lab.local</hostname>
    </host>
  </dns>
</network>
EOF

# UUIDを実際に生成して置換
sudo sed -i "s/\$(uuidgen)/$(uuidgen)/" /etc/kvm-networks/kvm-database.xml

# ネットワークの定義と開始
sudo virsh net-define /etc/kvm-networks/kvm-database.xml
sudo virsh net-autostart kvm-database
sudo virsh net-start kvm-database
```

#### 検証項目

- **アクション**: `sudo virsh net-dumpxml kvm-database` で DHCP セクションを確認し、`sudo virsh net-info kvm-database` を実行する。
- **期待結果**: XML に `<dhcp>` セクションが無く、`net-info` で `Active: yes` と表示される。
- **失敗時**: DHCP 要素が残っている場合は XML を編集し直して再定義し、アクティブ化できない場合は `sudo virsh net-start kvm-database` のエラー詳細を `journalctl -u libvirtd` で確認する。

---

### ステップ 6: Container Subnet (10.0.4.0/24) の作成

コンテナネットワークを作成します。SSH ポート範囲: 2261-2280

#### 実行コマンド

```bash
# Container Network設定ファイルの作成
sudo tee /etc/kvm-networks/kvm-container.xml << 'EOF'
<network>
  <name>kvm-container</name>
  <uuid>$(uuidgen)</uuid>
  <bridge name='br-container' stp='on' delay='0'/>
  <mac address='52:54:00:00:04:01'/>
  <domain name='lab.local'/>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <ip address='10.0.4.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='10.0.4.100' end='10.0.4.200'/>
    </dhcp>
  </ip>
  <dns>
    <host ip='10.0.4.1'>
      <hostname>container-gateway.lab.local</hostname>
    </host>
  </dns>
</network>
EOF

# UUIDを実際に生成して置換
sudo sed -i "s/\$(uuidgen)/$(uuidgen)/" /etc/kvm-networks/kvm-container.xml

# ネットワークの定義と開始
sudo virsh net-define /etc/kvm-networks/kvm-container.xml
sudo virsh net-autostart kvm-container
sudo virsh net-start kvm-container
```

#### 検証項目

- **アクション**: `sudo virsh net-info kvm-container` と `sudo virsh net-list --all | grep kvm-container` を実行する。
- **期待結果**: `Active: yes` と `Autostart: yes` が表示され、`kvm-container` が `active` として一覧に出る。
- **失敗時**: ブリッジ名が既存のものと競合していないか確認し、`sudo virsh net-undefine kvm-container` で再作成する。`sudo firewall-cmd --list-all` で 10.0.4.0/24 からの通信が遮断されていないかも確認する。

---

### ステップ 6.5: test-vm を使ったネットワーク疎通確認

タスク 2.1 で作成した `test-vm`（default ネットワーク接続）を順次各ネットワークへ付け替え、ゲートウェイ疎通を確認します。default ネットワークを停止する前に実施してください。

#### 実行コマンド

```bash
# test-vm の状態確認
sudo virsh domstate test-vm

# 稼働中であればシャットダウン（必要に応じて --force）
sudo virsh shutdown test-vm
sudo virsh domstate test-vm

# 接続中インターフェースの確認（default ネットワークの MAC を控える）
sudo virsh domiflist test-vm

# default ネットワークから切り離し（MAC は上記で確認した値に置き換える）
sudo virsh detach-interface test-vm --type bridge --mac <defaultネットワークMAC> --config

# 任意のネットワークへ付け替え（例: kvm-management）
sudo virsh attach-interface --domain test-vm --type network --source kvm-management --model virtio --config

# VM を起動
sudo virsh start test-vm

# コンソール接続でゲストにログイン（終了は Ctrl+]）
sudo virsh console test-vm

# ゲスト OS 側で IP とゲートウェイ疎通を確認
ip -4 addr show
ping -c 3 10.0.0.1
exit

# 他セグメントを検証する場合は再び shutdown し、attach-interface の --source を
# kvm-public / kvm-private / kvm-database / kvm-container に入れ替えて繰り返す
```

#### 検証項目

- **アクション**: ゲスト内で `ip -4 addr show` を実行し、付け替え先ネットワークの DHCP 範囲に収まる IP が割り当てられているか確認する。続けて各ゲートウェイ（10.0.x.1）へ `ping -c 3` を実行する。
- **期待結果**: `test-vm` が接続したネットワークのゲートウェイに対して 0% packet loss で応答し、`ip route` にデフォルト経路が 10.0.x.1 経由で追加される。
- **失敗時**: DHCP で IP が付与されない場合は `sudo virsh net-dhcp-leases <ネットワーク名>` でリース状況を確認し、必要なら `sudo virsh reboot test-vm` を実行する。`ping` が失敗する場合はホスト側で `sudo tcpdump -i br-<seg> icmp` を実行し、パケットがブリッジに届いているか確認する。

> **補足**: `test-vm` の再配線が難しい場合は、タスク 2.1 の `virt-install` コマンドをベースに `--network network=kvm-<segment>` を指定して検証用 VM を複製してもよい。

---

### ステップ 7: default ネットワークの停止

libvirt の default ネットワーク（192.168.122.0/24）を停止し、新規作成したネットワークへ移行します。既存の VM が default ネットワークを使用している場合は、事前にインターフェースを付け替えてから実行してください。

#### 実行コマンド

```bash
# 既存ネットワークの確認
sudo virsh net-list --all

# default ネットワークの停止と自動起動無効化
sudo virsh net-destroy default
sudo virsh net-autostart default --disable
```

#### 検証項目

- **アクション**: `sudo virsh net-list --all | grep default` と `sudo ls /etc/libvirt/qemu/networks/autostart/` を確認する。
- **期待結果**: `default` が `inactive` かつ `autostart` 列が `no` で表示され、`autostart` ディレクトリに `default.xml` のリンクが存在しない。
- **失敗時**: `sudo virsh net-destroy default` と `sudo virsh net-autostart default --disable` を再実行し、VM が default ネットワークを参照していないか `sudo virsh dumpxml <vm名>` で確認する。

---

### ステップ 8: ファイアウォール設定

libvirt サービスと SSH 非標準ポート範囲を許可します。

#### 実行コマンド

```bash
# libvirt用のファイアウォール設定
sudo firewall-cmd --permanent --add-service=libvirt
sudo firewall-cmd --permanent --add-service=libvirt-tls

# SSH非標準ポート範囲の許可
sudo firewall-cmd --permanent --add-port=2201-2280/tcp

# 仮想ネットワーク間の通信制御
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="10.0.0.0/16" accept'

# 設定の再読み込み
sudo firewall-cmd --reload
```

#### 検証項目

- **アクション**: `sudo firewall-cmd --list-all` と `sudo firewall-cmd --list-rich-rules`、`sudo firewall-cmd --list-ports` を実行する。
- **期待結果**: services に `libvirt` と `libvirt-tls` が含まれ、ports に `2201-2280/tcp` が表示され、rich rule として `10.0.0.0/16` 許可ルールが存在する。
- **失敗時**: 設定が反映されない場合は `sudo firewall-cmd --reload` を再実行し、`firewalld` が停止している場合は `sudo systemctl status firewalld` を確認する。

---

### ステップ 9: ルーティング設定

IP 転送を有効化し、セグメント間通信を制御します。

#### 実行コマンド

```bash
# IP転送の有効化
echo 'net.ipv4.ip_forward = 1' | sudo tee /etc/sysctl.d/99-kvm-forwarding.conf
sudo sysctl -p /etc/sysctl.d/99-kvm-forwarding.conf

# iptablesルールの設定（セグメント間通信制御）
# Management -> 全セグメントアクセス可能
sudo iptables -I FORWARD -s 10.0.0.0/24 -d 10.0.0.0/16 -j ACCEPT

# Public -> Private, Database, Container アクセス可能
sudo iptables -I FORWARD -s 10.0.1.0/24 -d 10.0.2.0/24 -j ACCEPT
sudo iptables -I FORWARD -s 10.0.1.0/24 -d 10.0.3.0/24 -j ACCEPT
sudo iptables -I FORWARD -s 10.0.1.0/24 -d 10.0.4.0/24 -j ACCEPT

# Private -> Database, Container アクセス可能
sudo iptables -I FORWARD -s 10.0.2.0/24 -d 10.0.3.0/24 -j ACCEPT
sudo iptables -I FORWARD -s 10.0.2.0/24 -d 10.0.4.0/24 -j ACCEPT

# Database -> 他セグメントからのアクセスのみ（発信制限）
sudo iptables -I FORWARD -s 10.0.3.0/24 -d 10.0.1.0/24 -j DROP
sudo iptables -I FORWARD -s 10.0.3.0/24 -d 10.0.2.0/24 -j DROP
sudo iptables -I FORWARD -s 10.0.3.0/24 -d 10.0.4.0/24 -j DROP

# iptables設定の永続化
sudo iptables-save | sudo tee /etc/sysconfig/iptables
```

#### 検証項目

- **アクション**: `sysctl net.ipv4.ip_forward` と `sudo iptables -S FORWARD | grep 10.0.`、`sudo iptables-save | grep 10.0.` を実行する。
- **期待結果**: `net.ipv4.ip_forward = 1` が表示され、FORWARD チェーンに 10.0.x.0/24 宛ての許可・拒否ルールが期待通りに並ぶ。
- **失敗時**: 値が 1 でない場合は `sudo sysctl -p /etc/sysctl.d/99-kvm-forwarding.conf` を再実行し、ルールが欠けている場合は対応する `sudo iptables -I ...` コマンドを再適用して `sudo iptables-save` で永続化する。

---

## 最終検証

### ホスト (Rocky Linux) で実施する確認

1. ネットワークの状態を確認

   ```bash
   sudo virsh net-list --all
   ```

   - 期待結果: `kvm-management` / `kvm-public` / `kvm-private` / `kvm-database` / `kvm-container` が `active`、`default` は `inactive` か `autostart: no` で表示される。

2. ブリッジと IP 割り当ての確認

   ```bash
   nmcli device status | grep br-
   ip addr show | grep br-
   ```

   - 期待結果: `nmcli` の出力に `br-mgmt` などのブリッジが `connected` と表示され、各ブリッジに 10.0.x.1 が付与されている。

3. ルーティングと NAT の確認

   ```bash
   ip route show | grep 10.0
   sudo iptables -t nat -L | grep LIBVIRT
   ```

   - 期待結果: 10.0.x.0/24 宛てのルートが存在し、`LIBVIRT_PRT` などのチェーンに 10.0.x.0/24 向け MASQUERADE ルールが表示される。

4. ファイアウォールと IP 転送の確認

   ```bash
   sudo firewall-cmd --list-all
   sysctl net.ipv4.ip_forward
   ```

   - 期待結果: `services: libvirt libvirt-tls` と `ports: 2201-2280/tcp` が許可され、`net.ipv4.ip_forward = 1` が出力される。

### VM 側で実施する確認（ステップ 6.5 の test-vm 付け替え、または検証用 VM）

1. DHCP によるアドレス割り当て

   ```bash
   ip -4 addr show
   ```

   - 期待結果: 接続したネットワークの DHCP 範囲（例: Public なら 10.0.1.100-200）内のアドレスが割り当てられる。

2. インターネット接続と名前解決

   ```bash
   ping -c 3 8.8.8.8
   nslookup google.com
   ```

   - 期待結果: ICMP 応答が返り、`nslookup` が libvirt DNS（10.0.x.1）経由で外部ドメインを解決できる。

3. セグメント相互接続

   | 送信元セグメント | 宛先セグメント | 代表コマンド例        | 期待結果     | 備考               |
   | ---------------- | -------------- | --------------------- | ------------ | ------------------ |
   | Management       | 全セグメント   | `ping -c 3 10.0.x.1`  | 全て応答     | 管理用は全許可     |
   | Public           | Private        | `ping -c 3 10.0.2.1`  | 応答あり     | アプリ → 内部通信  |
   | Public           | Database       | `ping -c 3 10.0.3.10` | 応答あり     | DB 静的 IP 例      |
   | Public           | Container      | `ping -c 3 10.0.4.10` | 応答あり     | CI/CD 用           |
   | Private          | Database       | `ping -c 3 10.0.3.10` | 応答あり     | アプリ →DB         |
   | Private          | Container      | `ping -c 3 10.0.4.10` | 応答あり     | バッチ処理         |
   | Database         | Public         | `ping -c 3 10.0.1.1`  | タイムアウト | アウトバウンド抑止 |
   | Database         | Private        | `ping -c 3 10.0.2.1`  | タイムアウト | アウトバウンド抑止 |
   | Database         | Container      | `ping -c 3 10.0.4.1`  | タイムアウト | アウトバウンド抑止 |

   - **アクション**: 各セグメントに接続したテスト VM から表の通り `ping` または `curl http://10.0.x.1:80`（必要に応じて）を実行し、`traceroute 10.0.x.1` で経路を確認する。
   - **期待結果**: 許可された経路は 3 パケットともに `0% packet loss` で応答し、遮断対象はタイムアウトまたは `Destination Host Unreachable` になる。
   - **失敗時**: 許可経路で失敗した場合は `sudo iptables -S FORWARD | grep <セグメント>` で該当ルールが存在するか確認し、DHCP で割り当てられた IP が期待範囲内か `ip -4 addr` で再確認する。禁止経路で通過してしまう場合はルール順序を見直し、`sudo iptables -L FORWARD --line-numbers` で不要な ACCEPT を削除する。

## VM 作成時のネットワーク指定例

### Management ネットワークで VM 作成

```bash
virt-install --name test-mgmt-vm \
  --network network=kvm-management \
  --ram 1024 --vcpus 1 \
  --disk size=10 \
  --os-variant rocky9
```

### Public ネットワークで VM 作成

```bash
virt-install --name test-public-vm \
  --network network=kvm-public \
  --ram 1024 --vcpus 1 \
  --disk size=10 \
  --os-variant rocky9
```

## SSH 接続管理

### 手動での SSH ポート管理

```bash
# Management セグメント: 2201-2210
ssh -p 2201 user@10.0.0.10

# Public セグメント: 2211-2230
ssh -p 2215 user@10.0.1.150

# Private セグメント: 2231-2250
ssh -p 2235 user@10.0.2.100

# Database セグメント: 2251-2260
ssh -p 2255 user@10.0.3.50

# Container セグメント: 2261-2280
ssh -p 2265 user@10.0.4.120
```

## トラブルシューティング

### よくある問題

1. **ネットワーク作成失敗**

   - libvirtd サービスの再起動: `sudo systemctl restart libvirtd`
   - SELinux の確認: `sudo getenforce`

2. **インターネット接続失敗**

   - ホストの DNS 設定確認: `cat /etc/resolv.conf`
   - iptables ルールの確認: `sudo iptables -t nat -L`

3. **ブリッジ作成失敗**

   - nmcli でデバイス状態を確認: `nmcli device status | grep br-`
   - ブリッジプロファイルの確認: `nmcli connection show br-mgmt`（存在しない場合は `virsh net-dumpxml` でブリッジ名を再確認）

4. **セグメント間通信が期待通りでない**

   - ルール確認: `sudo iptables -L FORWARD --line-numbers | grep 10.0.` で許可/拒否の順序を確認し、誤った ACCEPT を削除する。
   - IP 範囲確認: テスト VM 側で `ip -4 addr` を実行し、想定セグメントのレンジに属しているか確認する。
   - ファイアウォール確認: `sudo firewall-cmd --list-all` で `10.0.0.0/16` 許可ルールが残っているかチェックする。
   - パケットトレース: `sudo tcpdump -i br-<seg> icmp` で ICMP/TCP がブリッジに届いているか監視する。

### ログファイル

- libvirt ログ: `/var/log/libvirt/`
- システムログ: `journalctl -u libvirtd`

## 参考情報

### 作成されるネットワーク構成

| セグメント | CIDR        | ゲートウェイ | DHCP 範囲       | SSH ポート | 用途         |
| ---------- | ----------- | ------------ | --------------- | ---------- | ------------ |
| Management | 10.0.0.0/24 | 10.0.0.1     | 10.0.0.10-50    | 2201-2210  | 管理用       |
| Public     | 10.0.1.0/24 | 10.0.1.1     | 10.0.1.100-200  | 2211-2230  | パブリック   |
| Private    | 10.0.2.0/24 | 10.0.2.1     | 10.0.2.100-200  | 2231-2250  | プライベート |
| Database   | 10.0.3.0/24 | 10.0.3.1     | なし（静的 IP） | 2251-2260  | データベース |
| Container  | 10.0.4.0/24 | 10.0.4.1     | 10.0.4.100-200  | 2261-2280  | コンテナ     |

### libvirt 統合機能

- **NAT 機能**: 全セグメントでインターネット接続
- **内蔵 DHCP**: dnsmasq による自動 IP 割り当て
- **内蔵 DNS**: lab.local ドメインでの名前解決
- **ポートフォワーディング**: 1024-65535 ポート範囲

## 次のステップ

1. **基盤環境のテスト**（タスク 2.3）

   - 総合的な接続性テスト
   - インターネット接続テスト
   - NAT 機能の検証
   - DNS 名前解決テスト

2. **KVM リソース管理システム**（タスク 3.1）
   - VM 作成・管理機能の実装
   - libvirt 統合機能の活用
