# 運用設計

**作成者**: kuma8088（AWS認定ソリューションアーキテクト、ITストラテジスト）
**運用形態**: 個人運用（自動化重視）

---

## 1. 運用方針

### 1.1 運用原則

| 原則 | 説明 | 実践例 |
|-----|------|-------|
| **自動化優先** | 繰り返しタスクは自動化 | cron, Docker restart policy |
| **監視駆動** | 問題は監視で検知 | ヘルスチェック, ログ監視 |
| **文書化** | すべての手順を文書化 | トラブルシューティングガイド |
| **最小権限** | 必要最小限のアクセス権 | 専用ユーザー, 読み取り専用マウント |

### 1.2 SLA目標

| 指標 | 目標 | 測定方法 |
|-----|-----|---------|
| 可用性 | 99.9%（月間ダウンタイム43分以内） | Uptime監視 |
| メール配信 | 99%到達率 | SendGrid統計 |
| 復旧時間（RTO） | 4時間以内 | 障害訓練 |
| データ損失（RPO） | 24時間以内 | バックアップ頻度 |

---

## 2. 監視設計

### 2.1 監視レイヤー

```
┌─────────────────────────────────────────────────────────────┐
│                    Layer 1: 外形監視                        │
│  Cloudflare Analytics, UptimeRobot (将来)                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 2: インフラ監視                     │
│  Docker healthcheck, ホストリソース監視                      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 3: アプリケーション監視              │
│  ログ監視, エラー検知                                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 4: セキュリティ監視                  │
│  ClamAV, rkhunter, 不正アクセス検知                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 ヘルスチェック

| サービス | チェック間隔 | 失敗閾値 | アクション |
|---------|------------|---------|-----------|
| 全コンテナ | 30秒 | 3回 | 自動再起動 |
| MariaDB | 30秒 | 3回 | 自動再起動 |
| Postfix | 30秒 | 3回 | 自動再起動 + アラート |
| Dovecot | 30秒 | 3回 | 自動再起動 + アラート |

### 2.3 リソース監視

```bash
# 監視対象メトリクス
- CPU使用率: 警告 80%, 危険 95%
- メモリ使用率: 警告 80%, 危険 95%
- ディスク使用率: 警告 70%, 危険 85%
- Docker volume: 警告 70%, 危険 85%
```

### 2.4 ログ管理

| ログ種別 | 保存場所 | 保存期間 | ローテーション |
|---------|---------|---------|---------------|
| Dockerログ | Docker logging driver | 7日 | 自動（100MB/ファイル） |
| アプリログ | ./logs/{service}/ | 30日 | logrotate |
| 監査ログ | /var/log/audit/ | 90日 | logrotate |

### 2.5 外部サービス監視

| サービス | 監視対象 | 確認方法 |
|---------|---------|---------|
| **Cloudflare** | Tunnel接続状態、WAFイベント | Zero Trust Dashboard |
| **SendGrid** | 送信成功率、バウンス率、ブロック | SendGrid Dashboard |
| **AWS S3** | バックアップ同期状態、コスト | CloudWatch、Billing Dashboard |
| **Tailscale** | デバイス接続状態 | Tailscale Admin Console |

---

## 3. バックアップ設計

### 3.1 バックアップ戦略（3-2-1ルール）

```
3つのコピー:
  ├── 本番データ（Docker volumes）
  ├── ローカルバックアップ（HDD）
  └── オフサイトバックアップ（S3）

2種類のメディア:
  ├── SSD/HDD（ローカル）
  └── S3（クラウド）

1つはオフサイト:
  └── AWS S3（Object Lock COMPLIANCE）
```

### 3.2 バックアップスケジュール

| 種別 | 頻度 | 時刻 | 保存期間 | 対象 |
|-----|------|-----|---------|------|
| 日次バックアップ | 毎日 | AM 3:00 | 7日 | DB, Mail, Config |
| 週次バックアップ | 毎週日曜 | AM 2:00 | 4週間 | フルバックアップ |
| S3同期 | 毎日 | AM 4:00 | 30日 | 日次バックアップ |

### 3.3 バックアップ内容

```
/mnt/backup-hdd/
├── mailserver/
│   ├── daily/
│   │   └── YYYY-MM-DD/
│   │       ├── mysql-dump.sql.gz      # DBダンプ
│   │       ├── mail-data.tar.gz       # メールデータ
│   │       ├── config.tar.gz          # 設定ファイル
│   │       └── manifest.json          # メタデータ
│   └── weekly/
│       └── YYYY-MM-DD/
│           └── full-backup.tar.gz     # フルバックアップ
└── blog/
    ├── daily/
    └── weekly/
```

### 3.4 S3 Object Lock（ランサムウェア対策）

```hcl
# Terraform設定
resource "aws_s3_bucket_object_lock_configuration" "backup" {
  bucket = aws_s3_bucket.backup.id

  rule {
    default_retention {
      mode = "COMPLIANCE"  # 削除不可（管理者でも）
      days = 30
    }
  }
}
```

**設計意図**:
- ランサムウェアがバックアップを暗号化・削除することを防止
- COMPLIANCE モードは AWS root ユーザーでも削除不可
- 30日間の保持期間で復旧猶予を確保

### 3.5 リストア手順

```bash
# 1. バックアップ選択
ls /mnt/backup-hdd/mailserver/daily/

# 2. Dry-run で確認
./scripts/restore-mailserver.sh \
  --from /mnt/backup-hdd/mailserver/daily/YYYY-MM-DD \
  --dry-run

# 3. リストア実行
./scripts/restore-mailserver.sh \
  --from /mnt/backup-hdd/mailserver/daily/YYYY-MM-DD \
  --component all

# 4. 検証
docker compose ps
docker compose logs --tail=100
```

---

## 4. セキュリティ運用

### 4.1 定期スキャン

| スキャン | 頻度 | ツール | 対象 |
|---------|------|-------|------|
| ウイルススキャン | 毎日 AM 5:00 | ClamAV | メール添付、アップロード |
| ルートキット検出 | 毎日 AM 5:30 | rkhunter | ホストOS |
| 脆弱性スキャン | 月次 | Trivy | Dockerイメージ |

### 4.2 パッチ管理

```bash
# ホストOS更新（月次）
sudo dnf update --security

# Dockerイメージ更新（月次）
docker compose pull
docker compose up -d

# 緊急パッチ（CVE発行時）
# 即日対応
```

### 4.3 アクセス管理

| アクセス種別 | 認証方式 | 多要素認証 | ログ |
|------------|---------|-----------|------|
| SSH | 公開鍵 | - | /var/log/secure |
| Webメール | パスワード | - | Roundcubeログ |
| 管理API | APIキー | - | アプリログ |

### 4.4 インシデント対応

```
┌─────────────────────────────────────────────────────────────┐
│                    インシデント対応フロー                    │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐
│  1. 検知      │  監視アラート / ユーザー報告 / ログ異常
└───────┬───────┘
        ▼
┌───────────────┐
│  2. 初期対応  │  影響範囲特定、必要に応じサービス隔離
└───────┬───────┘
        ▼
┌───────────────┐
│  3. 調査      │  ログ分析、原因特定
└───────┬───────┘
        ▼
┌───────────────┐
│  4. 復旧      │  修正適用、サービス再開
└───────┬───────┘
        ▼
┌───────────────┐
│  5. 事後対応  │  報告書作成、再発防止策
└───────────────┘
```

---

## 5. 障害対応

### 5.1 障害レベル定義

| レベル | 定義 | 対応時間 | 例 |
|-------|------|---------|-----|
| P1（重大） | 全サービス停止 | 1時間以内 | ホスト障害、全コンテナ停止 |
| P2（高） | 主要機能停止 | 4時間以内 | メール送受信不可 |
| P3（中） | 一部機能低下 | 24時間以内 | パフォーマンス低下 |
| P4（低） | 軽微な問題 | 1週間以内 | UI不具合 |

### 5.2 トラブルシューティング

```bash
# 1. サービス状態確認
docker compose ps
docker compose logs --tail=100 <service>

# 2. リソース確認
docker stats --no-stream
df -h
free -h

# 3. ネットワーク確認
docker network ls
docker network inspect <network>

# 4. 設定検証
docker compose config
```

### 5.3 よくある問題と対処

| 問題 | 原因 | 対処 |
|-----|------|------|
| コンテナ起動失敗 | ポート競合 | `netstat -tlnp` で確認、競合解消 |
| DB接続エラー | 認証情報不一致 | .env 確認、コンテナ再作成 |
| ディスク容量不足 | ログ肥大化 | `docker system prune`、ログローテーション |
| メール送信失敗 | SendGrid制限 | SendGridダッシュボード確認 |

---

## 6. 定期メンテナンス

### 6.1 日次タスク（自動化）

| 時刻 | タスク | 実行方法 |
|-----|-------|---------|
| AM 3:00 | バックアップ | cron + スクリプト |
| AM 4:00 | S3同期 | cron + aws cli |
| AM 5:00 | ウイルススキャン | cron + ClamAV |
| AM 5:30 | ルートキット検出 | cron + rkhunter |

### 6.2 週次タスク

| タスク | 内容 |
|-------|------|
| バックアップ検証 | リストアテスト（ステージング） |
| ログレビュー | 異常パターン確認 |
| リソーストレンド | 使用量推移確認 |

### 6.3 月次タスク

| タスク | 内容 |
|-------|------|
| セキュリティパッチ | OS、Docker更新 |
| 容量計画 | ストレージ使用量予測 |
| 設定レビュー | ベストプラクティス確認 |
| 障害訓練 | リストア手順確認 |

---

## 7. 外部サービス運用

### 7.1 Cloudflare 運用

| 機能 | 運用タスク | 頻度 |
|------|-----------|------|
| **Tunnel** | 接続状態確認、再接続対応 | 障害時 |
| **Email Routing** | ルーティングルール確認 | 変更時 |
| **DNS** | レコード管理、プロキシ設定 | 変更時 |
| **WAF** | ブロックログ確認、ルール調整 | 週次 |
| **SSL/TLS** | 証明書状態確認（自動更新） | 月次 |

**トラブルシューティング**:
- Tunnel切断時: `docker compose restart cloudflared`
- Email Worker エラー: Cloudflare Workers Dashboard でログ確認

### 7.2 SendGrid 運用

| 指標 | 正常値 | アラート閾値 |
|-----|-------|------------|
| 配信成功率 | 99%以上 | 95%未満 |
| バウンス率 | 2%未満 | 5%以上 |
| スパム報告率 | 0.1%未満 | 0.5%以上 |

**対応アクション**:
- バウンス増加時: 無効アドレスリストの確認・削除
- ブロック時: SendGrid サポートへ連絡
- レピュテーション低下時: 送信パターンの見直し

### 7.3 Tailscale 運用

| タスク | 内容 | 頻度 |
|-------|------|------|
| デバイス管理 | 新規デバイス承認、不要デバイス削除 | 随時 |
| キー有効期限 | デバイスキーの期限確認・更新 | 月次 |
| ACL設定 | アクセス制御ポリシーの確認 | 変更時 |

### 7.4 WordPress サイト運用

| タスク | 対象 | 頻度 |
|-------|------|------|
| WordPress コア更新 | 全サイト | 月次 |
| プラグイン更新 | 全サイト | 週次 |
| テーマ更新 | 全サイト | 月次 |
| パーミッション修正 | 全サイト | 更新後 |

**一括操作コマンド**:
```bash
# 全サイトのプラグイン更新確認
./scripts/check-wp-updates.sh

# パーミッション一括修正
./scripts/fix-permissions.sh
```

---

## 8. コスト管理

### 8.1 月次コスト内訳

| 項目 | 費用 | 備考 |
|-----|------|------|
| AWS S3 | ~$1-3 | バックアップストレージ |
| Cloudflare | $0 | 無料プラン |
| SendGrid | $0 | 無料枠（100通/日） |
| ドメイン | ~$15/年 | 複数ドメイン |
| **合計** | **~$3-5/月** | |

### 8.2 コストアラート

```hcl
# CloudWatch Billing Alarm
resource "aws_cloudwatch_metric_alarm" "billing" {
  alarm_name          = "billing-alarm"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "EstimatedCharges"
  namespace           = "AWS/Billing"
  period              = 86400
  statistic           = "Maximum"
  threshold           = 10  # $10超過でアラート
  alarm_actions       = [aws_sns_topic.alerts.arn]
}
```

---

## 9. ドキュメント管理

### 9.1 ドキュメント体系

```
docs/
├── infra/              # 公開可能なインフラドキュメント
│   ├── README.md       # インデックス
│   ├── requirements.md # 要件定義
│   ├── architecture.md # システム設計
│   ├── deployment.md   # デプロイ戦略
│   └── operations.md   # 運用設計（本文書）
└── private/            # 内部運用ドキュメント
    └── infra/          # 詳細手順、機密情報含む
```

### 9.2 更新ルール

- **変更時更新**: インフラ変更時は関連ドキュメントも更新
- **レビュー**: 月次でドキュメント鮮度確認
- **バージョン管理**: Git でドキュメントもバージョン管理
