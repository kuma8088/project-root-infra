# メールユーザ管理システム - ユーザーガイド

**バージョン**: v1.0.0 (Extended)
**最終更新**: 2025-11-05
**対象**: メールサーバー管理者

---

## 📋 目次

1. [はじめに](#はじめに)
2. [アクセス方法](#アクセス方法)
3. [基本操作](#基本操作)
   - [ログイン](#ログイン)
   - [ダッシュボード](#ダッシュボード)
4. [ユーザー管理](#ユーザー管理)
   - [新規ユーザー作成](#新規ユーザー作成)
   - [ユーザー情報編集](#ユーザー情報編集)
   - [パスワード変更](#パスワード変更)
   - [ユーザー削除](#ユーザー削除)
   - [ユーザー有効化/無効化](#ユーザー有効化無効化)
5. [よくある質問 (FAQ)](#よくある質問-faq)
6. [トラブルシューティング](#トラブルシューティング)
7. [セキュリティに関する注意事項](#セキュリティに関する注意事項)

---

## はじめに

### このシステムについて

メールユーザ管理システムは、メールサーバー (Dovecot + Postfix) のユーザーアカウントを Web ブラウザから簡単に管理できるツールです。

### 主な機能

- ✉️ メールユーザーの作成・編集・削除
- 🔐 パスワードの設定・変更 (Dovecot 互換 SHA512-CRYPT ハッシュ)
- 💾 メールボックス容量 (Quota) の設定
- 📊 ユーザー一覧とステータス確認
- 📝 全操作の監査ログ記録
- 🔒 Tailscale VPN によるアクセス制限

### 動作要件

- **ネットワーク**: Tailscale VPN 接続必須 (100.64.0.0/10 ネットワーク)
- **ブラウザ**:
  - Chrome/Edge 最新版 (推奨)
  - Firefox 最新版
  - Safari 最新版
  - モバイルブラウザ (iOS Safari, Android Chrome)
- **権限**: メールサーバー管理者アカウント

---

## アクセス方法

### 1. Tailscale VPN 接続の確認

管理画面にアクセスする前に、Tailscale VPN に接続していることを確認してください。

**確認方法**:
- デスクトップ: Tailscale アイコンが「接続済み」を表示
- モバイル: Tailscale アプリで VPN が有効化されている
- コマンドライン: `tailscale status` で接続状態を確認

### 2. 管理画面へのアクセス

**推奨アクセス URL (管理専用サブドメイン)**:
```
https://admin.kuma8088.com/auth/login
```

**代替アクセス URL (メインドメイン経由)**:
```
https://mail.kuma8088.com/admin/auth/login
```

**内部 IP 直接アクセス (開発/テスト用のみ)**:
```
http://172.20.0.90:5000/auth/login
```

**⚠️ 重要**:
- Tailscale VPN に接続していない場合、404 エラーが表示されます
- 本番環境では必ず HTTPS (443) を使用してください

### 3. サポートされているデバイス

- 💻 **デスクトップ** (Windows, macOS, Linux)
- 📱 **スマートフォン** (iOS, Android)
- 🖥️ **タブレット** (iPad, Android タブレット)

---

## 基本操作

### ログイン

1. ブラウザで管理画面 URL にアクセス
2. ログインフォームが表示されます
3. 管理者の認証情報を入力:
   - **ユーザー名**: 管理者アカウント名
   - **パスワード**: 管理者パスワード
4. **[ログイン]** ボタンをクリック

**ログイン成功後**: ダッシュボードにリダイレクトされます

**ログイン失敗時**:
- 「ユーザー名またはパスワードが正しくありません」エラーが表示されます
- 認証情報を再確認してください
- 複数回失敗する場合は、管理者にお問い合わせください

### ダッシュボード

ログイン後に表示されるメイン画面です。

**表示内容**:
- 📊 登録ユーザー総数
- 📋 ユーザー一覧テーブル
- 🔍 検索・フィルタ機能
- ➕ 新規ユーザー作成ボタン

**ユーザー一覧テーブル**:
| 列 | 説明 |
|-----|------|
| **メールアドレス** | ユーザーのメールアドレス |
| **ドメイン** | メールドメイン (例: kuma8088.com) |
| **容量** | 割り当てメールボックス容量 (MB) |
| **状態** | 有効/無効 |
| **作成日** | アカウント作成日時 |
| **操作** | 編集/パスワード変更/削除ボタン |

---

## ユーザー管理

### 新規ユーザー作成

**手順**:

1. ダッシュボードで **[+ 新規ユーザー作成]** ボタンをクリック
2. 作成フォームで以下の情報を入力:
   - **メールアドレス**: 作成するユーザーのメールアドレス (例: user@kuma8088.com)
   - **パスワード**: 初期パスワード (8文字以上推奨)
   - **ドメイン**: ドロップダウンからドメインを選択
   - **メールボックス容量**: MB 単位で指定 (デフォルト: 1024 MB = 1 GB)
   - **状態**: 有効/無効を選択 (通常は「有効」)
3. **[作成]** ボタンをクリック

**バリデーション**:
- メールアドレス形式のチェック
- 重複メールアドレスのチェック
- パスワード強度のチェック

**作成成功時**:
- 緑色の成功メッセージが表示されます
- ユーザー一覧にリダイレクトされ、新規ユーザーが表示されます
- **ユーザーは即座に IMAP ログイン可能になります**

**作成失敗時**:
- 赤色のエラーメッセージが表示されます
- 入力内容を確認し、再度お試しください

### ユーザー情報編集

**手順**:

1. ダッシュボードのユーザー一覧から、編集したいユーザーの **[編集]** ボタンをクリック
2. 編集フォームで以下の情報を変更可能:
   - **メールボックス容量**: MB 単位で変更
   - **状態**: 有効/無効を切り替え
3. **[更新]** ボタンをクリック

**⚠️ 注意**:
- **メールアドレスは変更できません** (変更する場合は削除→再作成が必要)
- パスワード変更は専用の「パスワード変更」機能を使用してください

**更新成功時**:
- 緑色の成功メッセージが表示されます
- 変更内容が即座に反映されます

### パスワード変更

**手順**:

1. ダッシュボードのユーザー一覧から、対象ユーザーの **[パスワード変更]** ボタンをクリック
2. パスワード変更フォームで以下を入力:
   - **新しいパスワード**: 新規パスワード (8文字以上推奨)
   - **パスワード確認**: 同じパスワードを再入力
3. **[変更]** ボタンをクリック

**パスワード要件**:
- 最低8文字以上推奨
- 英数字と記号の組み合わせ推奨
- 推測されやすいパスワードは避けてください

**変更成功時**:
- 緑色の成功メッセージが表示されます
- **ユーザーは新しいパスワードで即座にログイン可能になります**
- **旧パスワードは無効化されます**

**変更失敗時**:
- 「パスワードが一致しません」エラー → 再入力をお試しください
- その他のエラー → エラーメッセージを確認してください

### ユーザー削除

**⚠️ 重要**: ユーザー削除は**取り消せません**。削除前に必ず確認してください。

**手順**:

1. ダッシュボードのユーザー一覧から、削除したいユーザーの **[削除]** ボタンをクリック
2. 確認ダイアログが表示されます:
   ```
   本当にユーザー user@kuma8088.com を削除しますか？
   この操作は取り消せません。
   ```
3. **[削除]** ボタンをクリックして確定

**削除される内容**:
- ユーザーアカウント情報 (データベースから完全削除)
- **メールボックスデータは保持されます** (手動削除が必要)

**削除後の影響**:
- ユーザーは IMAP/POP3 ログインができなくなります
- メール送受信ができなくなります
- 削除操作は監査ログに記録されます

**削除成功時**:
- 緑色の成功メッセージが表示されます
- ユーザー一覧から削除されたユーザーが消えます

### ユーザー有効化/無効化

**用途**:
- 一時的にユーザーのメールアクセスを停止したい場合
- アカウントを削除せずに無効化したい場合

**手順 (編集画面から)**:

1. ユーザーの **[編集]** ボタンをクリック
2. 「状態」ドロップダウンで「無効」を選択
3. **[更新]** ボタンをクリック

**手順 (トグルボタン - Quick Action)**:

1. ユーザー一覧の **[有効化/無効化]** トグルボタンをクリック
2. 即座に状態が切り替わります

**無効化の影響**:
- ユーザーは IMAP/POP3 ログインができなくなります
- メール送受信ができなくなります
- アカウント情報は保持されます (再有効化可能)

**再有効化**:
- 「状態」を「有効」に戻すことで、即座に再度ログイン可能になります

---

## よくある質問 (FAQ)

### Q1. 作成したユーザーがすぐにログインできません

**A**: 以下を確認してください:
- ユーザー作成が成功していますか？ (ダッシュボードの一覧に表示されるか確認)
- ユーザーの状態が「有効」になっていますか？
- 正しいメールアドレスとパスワードを使用していますか？
- IMAP サーバー設定が正しいですか？ (サーバーアドレス、ポート 993、SSL/TLS 有効)

### Q2. パスワードを変更したのに古いパスワードでもログインできます

**A**: これは正常ではありません。以下を確認してください:
- ブラウザのキャッシュをクリアしてください
- パスワード変更後に「成功」メッセージが表示されましたか？
- 監査ログでパスワード変更が記録されているか確認してください
- それでも問題が続く場合は、システム管理者にお問い合わせください

### Q3. 削除したユーザーのメールデータはどうなりますか？

**A**:
- **ユーザーアカウント**: データベースから完全削除されます
- **メールボックスデータ**: `/var/mail/vmail/domain/username/` ディレクトリは保持されます
- メールデータも削除したい場合は、サーバー管理者に手動削除を依頼してください

### Q4. ユーザーのメールボックス容量を変更するとどうなりますか？

**A**:
- 容量変更は即座に反映されます
- 既存のメールデータには影響しません
- 新しい容量制限が適用され、超過した場合は新規メール受信が拒否されます
- 容量を増やす場合は問題ありませんが、減らす場合は既存データ量を確認してください

### Q5. Tailscale VPN なしでアクセスできますか？

**A**: いいえ、できません。
- セキュリティ上の理由から、管理画面は Tailscale VPN (100.64.0.0/10) からのアクセスのみ許可しています
- VPN 接続なしでアクセスすると、HTTP 404 エラーが表示されます
- 必ず Tailscale VPN に接続してからアクセスしてください

### Q6. モバイルデバイスから管理できますか？

**A**: はい、できます。
- iPhone/iPad: Tailscale アプリをインストールし、VPN 接続後、Safari でアクセス
- Android: Tailscale アプリをインストールし、VPN 接続後、Chrome でアクセス
- レスポンシブデザイン対応のため、モバイル画面でも快適に操作可能です

### Q7. 同時に複数の管理者がアクセスできますか？

**A**: はい、できます。
- 複数の管理者が同時にログインして操作可能です
- 各操作は監査ログに記録されるため、誰が何をしたか追跡可能です
- ただし、同じユーザーを同時編集すると競合する可能性があるため、注意してください

---

## トラブルシューティング

### ログインできない

**症状**: ログイン画面でエラーが表示される

**原因と対処法**:

| エラー | 原因 | 対処法 |
|--------|------|--------|
| "ユーザー名またはパスワードが正しくありません" | 認証情報が間違っている | 入力内容を確認し、大文字小文字を正確に入力 |
| "404 Not Found" | Tailscale VPN に接続していない | Tailscale VPN 接続を確認 |
| "Connection refused" | アプリケーションが起動していない | システム管理者に連絡 |
| ページが読み込まれない | ネットワーク問題 | インターネット接続とVPN接続を確認 |

### ユーザー作成できない

**症状**: 新規ユーザー作成時にエラーが表示される

**原因と対処法**:

| エラー | 原因 | 対処法 |
|--------|------|--------|
| "メールアドレスは必須です" | 入力が空 | メールアドレスを入力 |
| "このメールアドレスは既に登録されています" | 重複 | 別のメールアドレスを使用 |
| "無効なメールアドレス形式です" | 形式エラー | 正しい形式で入力 (例: user@domain.com) |
| "パスワードは必須です" | パスワード未入力 | パスワードを入力 |
| "ドメインを選択してください" | ドメイン未選択 | ドロップダウンからドメインを選択 |

### ページが表示されない・遅い

**症状**: 管理画面が表示されない、または動作が遅い

**対処法**:

1. **ブラウザキャッシュをクリア**:
   - Chrome: Ctrl+Shift+Delete (Windows) / Cmd+Shift+Delete (Mac)
   - Firefox: Ctrl+Shift+Delete (Windows) / Cmd+Shift+Delete (Mac)
   - Safari: Cmd+Option+E (Mac)

2. **VPN 接続を確認**:
   ```bash
   tailscale status
   ```

3. **別のブラウザで試す**:
   - Chrome, Firefox, Safari など他のブラウザでアクセス

4. **ネットワーク接続を確認**:
   - インターネット接続が安定しているか確認
   - Wi-Fi の場合は有線接続を試す

5. **システム管理者に連絡**:
   - 上記で解決しない場合は、システム管理者にお問い合わせください

### 画面が崩れている

**症状**: レイアウトが正しく表示されない

**対処法**:

1. ブラウザのキャッシュをクリア
2. ページをハードリロード: Ctrl+F5 (Windows) / Cmd+Shift+R (Mac)
3. ブラウザのズームレベルを確認 (100% 推奨)
4. JavaScript が有効になっているか確認

---

## セキュリティに関する注意事項

### アクセス制御

- ✅ **Tailscale VPN 必須**: 管理画面は VPN 経由でのみアクセス可能
- ✅ **IP 制限**: Nginx が 100.64.0.0/10 ネットワークのみ許可
- ✅ **セッション管理**: Flask-Login による安全なセッション管理
- ✅ **CSRF 保護**: 全フォームに CSRF トークンが適用

### パスワード管理

- 🔐 **強力なパスワード推奨**: 最低8文字、英数字と記号の組み合わせ
- 🔐 **SHA512-CRYPT ハッシュ**: Dovecot 互換の安全なハッシュ方式
- 🔐 **定期的なパスワード変更**: 3～6ヶ月ごとの変更を推奨
- 🔐 **パスワード共有禁止**: 管理者パスワードは個人で管理

### 監査ログ

全ての操作は監査ログに記録されます:
- ユーザー作成 (create)
- ユーザー更新 (update)
- パスワード変更 (password_change)
- ユーザー削除 (delete)
- 有効化/無効化 (toggle_status)

**ログに記録される情報**:
- 操作日時
- 操作内容
- 対象ユーザー
- 管理者 IP アドレス

### ベストプラクティス

1. **定期的な監査ログ確認**: 不正アクセスや異常な操作がないか定期的に確認
2. **最小権限の原則**: 必要最小限のユーザーにのみ管理者権限を付与
3. **セッションタイムアウト**: 長時間操作しない場合は自動的にログアウトされます
4. **バックアップの確認**: 定期的にデータベースバックアップが取得されているか確認
5. **セキュリティアップデート**: システム管理者がセキュリティパッチを適用していることを確認

### セキュリティインシデント対応

**不正アクセスの疑いがある場合**:
1. 直ちにシステム管理者に連絡
2. 影響を受けた可能性のあるユーザーのパスワードを変更
3. 監査ログを確認し、不正な操作がないか調査
4. 必要に応じてユーザーアカウントを一時的に無効化

**緊急連絡先**: システム管理者 (system-admin)

---

## サポート

### ドキュメント

- **開発者向けドキュメント**: [README.md](README.md)
- **開発進捗**: [DEVELOPMENT.md](DEVELOPMENT.md)
- **API 仕様**: [API.md](API.md)
- **ロールバック手順**: [ROLLBACK.md](ROLLBACK.md)
- **変更履歴**: [CHANGELOG.md](CHANGELOG.md)

### お問い合わせ

技術的な問題やご不明な点がございましたら、システム管理者までお問い合わせください。

---

**最終更新**: 2025-11-05
**バージョン**: v1.0.0 (Extended)
**システム**: メールサーバーユーザー管理システム
