# Phase 11: Extendedæ©Ÿèƒ½è¿½åŠ è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025-11-05
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆä¸­
**å¯¾è±¡**: Extendedè¿½åŠ æ©Ÿèƒ½ï¼ˆPhase 11ï¼‰

---

## ğŸ“‹ æ¦‚è¦

Phase 10ï¼ˆæœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ï¼‰å®Œäº†å¾Œã®æ‹¡å¼µæ©Ÿèƒ½ã¨ã—ã¦ã€ä»¥ä¸‹ã®2ã¤ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã™ï¼š

1. **ç®¡ç†è€…ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™åˆ†é›¢æ©Ÿèƒ½** (Phase 11-A)
2. **ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½** (Phase 11-B)

---

## ğŸ¯ Phase 11-A: ç®¡ç†è€…ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™åˆ†é›¢æ©Ÿèƒ½

### è¦ä»¶

**ç¾çŠ¶ã®èª²é¡Œ**:
- å…¨ã¦ã® `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
- æ¨©é™ã®åŒºåˆ¥ãŒãªãã€èª°ã§ã‚‚å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç®¡ç†ã§ãã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼šãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

**ç›®æ¨™**:
- **ç®¡ç†è€… (admin)**: 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€å…¨æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½
- **é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ (user)**: è¤‡æ•°å­˜åœ¨ã€ç®¡ç†è€…ãŒè‡ªç”±ã«æ“ä½œå¯èƒ½
- **æ¨©é™è­˜åˆ¥**: `is_admin` ãƒ•ãƒ©ã‚°ã§ç®¡ç†è€…ã‚’è­˜åˆ¥
- **æ©Ÿèƒ½åˆ†é›¢**: ç®¡ç†è€…ã®ã¿ãŒç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### æ¨©é™ãƒ¢ãƒ‡ãƒ«

| æ©Ÿèƒ½ | ç®¡ç†è€… (admin) | é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ (user) |
|------|----------------|---------------------|
| ç®¡ç†ç”»é¢ãƒ­ã‚°ã‚¤ãƒ³ | âœ… | âŒ |
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰é–²è¦§ | âœ… | âŒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ | âœ… | âŒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ | âœ… | âŒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›† | âœ… | âŒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ | âœ… | âŒ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ | âœ… | âŒ |
| ç›£æŸ»ãƒ­ã‚°é–²è¦§ | âœ… | âŒ |
| ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç† | âœ… | âŒ |
| IMAP/SMTP ãƒ¡ãƒ¼ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ | âœ… | âœ… |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

#### 1. `users` ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´

**æ–°è¦ã‚«ãƒ©ãƒ è¿½åŠ **:
```sql
ALTER TABLE users ADD COLUMN is_admin BOOLEAN DEFAULT FALSE NOT NULL;
```

**åˆ¶ç´„è¿½åŠ ï¼ˆç®¡ç†è€…ã¯1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ï¼‰**:
```sql
-- MySQL 8.0.13+ ã®å ´åˆ
CREATE UNIQUE INDEX idx_users_single_admin ON users (is_admin) WHERE is_admin = TRUE;

-- MySQL 8.0.12 ä»¥å‰ã®å ´åˆã¯ãƒˆãƒªã‚¬ãƒ¼ã§åˆ¶å¾¡
DELIMITER $$
CREATE TRIGGER trg_single_admin_check
BEFORE UPDATE ON users
FOR EACH ROW
BEGIN
    IF NEW.is_admin = TRUE AND OLD.is_admin = FALSE THEN
        IF (SELECT COUNT(*) FROM users WHERE is_admin = TRUE) > 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'ç®¡ç†è€…ã¯1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¨­å®šå¯èƒ½ã§ã™';
        END IF;
    END IF;
END$$
DELIMITER ;
```

**åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š**:
```sql
UPDATE users SET is_admin = TRUE WHERE email = 'admin@kuma8088.com';
```

#### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

```
users
â”œâ”€â”€ id (INT, PRIMARY KEY, AUTO_INCREMENT)
â”œâ”€â”€ email (VARCHAR(255), UNIQUE, NOT NULL)
â”œâ”€â”€ password_hash (VARCHAR(255), NOT NULL)
â”œâ”€â”€ domain_id (INT, FOREIGN KEY -> domains.id)
â”œâ”€â”€ maildir (VARCHAR(255), NOT NULL)
â”œâ”€â”€ quota (INT, DEFAULT 1024)
â”œâ”€â”€ uid (INT, DEFAULT 5000)
â”œâ”€â”€ gid (INT, DEFAULT 5000)
â”œâ”€â”€ enabled (BOOLEAN, DEFAULT TRUE)
â”œâ”€â”€ is_admin (BOOLEAN, DEFAULT FALSE, NOT NULL)  â† æ–°è¦
â”œâ”€â”€ created_at (TIMESTAMP)
â””â”€â”€ updated_at (TIMESTAMP)

INDEX: idx_users_single_admin (ç®¡ç†è€…ã¯1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿)
```

### å®Ÿè£…è¨­è¨ˆ

#### 1. ãƒ¢ãƒ‡ãƒ«å¤‰æ›´

**`app/models/user.py`**:
```python
class User(UserMixin, db.Model):
    __tablename__ = 'users'

    # ... existing columns ...

    is_admin = db.Column(db.Boolean, default=False, nullable=False)  # æ–°è¦

    # ... existing methods ...
```

#### 2. èªå¯ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼

**`app/decorators.py` (æ–°è¦)**:
```python
from functools import wraps
from flask import abort, redirect, url_for, flash
from flask_login import current_user

def admin_required(f):
    """ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªãƒ«ãƒ¼ãƒˆã‚’ä¿è­·"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if not current_user.is_authenticated:
            return redirect(url_for('auth.login'))
        if not current_user.is_admin:
            flash('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚', 'error')
            abort(403)
        return f(*args, **kwargs)
    return decorated_function
```

#### 3. ãƒ«ãƒ¼ãƒˆä¿è­·

**ã™ã¹ã¦ã®ç®¡ç†æ©Ÿèƒ½ã« `@admin_required` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é©ç”¨**:
```python
from app.decorators import admin_required

@bp.route('/users')
@login_required
@admin_required  # ç®¡ç†è€…ã®ã¿
def list_users():
    pass

@bp.route('/users/create', methods=['GET', 'POST'])
@login_required
@admin_required  # ç®¡ç†è€…ã®ã¿
def create_user():
    pass

# ... ä»–ã®ãƒ«ãƒ¼ãƒˆã‚‚åŒæ§˜
```

#### 4. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**`app/routes/auth.py`**:
```python
@auth_bp.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        # ... èªè¨¼å‡¦ç† ...

        login_user(user, remember=True)

        # ç®¡ç†è€…ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³è¨±å¯
        if user.is_admin:
            return redirect(url_for('dashboard'))
        else:
            flash('ç®¡ç†è€…ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ã§ã™ã€‚', 'error')
            logout_user()
            return redirect(url_for('auth.login'))

    return render_template('login.html')
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

#### Phase 11-A-1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (0.5æ™‚é–“)

1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLä½œæˆ
2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
4. æ¤œè¨¼

#### Phase 11-A-2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£… (1æ™‚é–“)

1. ãƒ¢ãƒ‡ãƒ«æ›´æ–°
2. ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼å®Ÿè£…
3. ãƒ«ãƒ¼ãƒˆä¿è­·
4. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å¤‰æ›´

#### Phase 11-A-3: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ (0.5æ™‚é–“)

1. ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
2. é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦ãƒ†ã‚¹ãƒˆ
3. æ¨©é™ä¿è­·ãƒ†ã‚¹ãƒˆ

**åˆè¨ˆè¦‹ç©ã‚‚ã‚Š**: 2æ™‚é–“

---

## ğŸŒ Phase 11-B: ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½

### è¦ä»¶

**ç¾çŠ¶ã®èª²é¡Œ**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½ãŒå­˜åœ¨ã—ãªã„
- åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ `kuma8088.com` ã®ã¿å­˜åœ¨
- æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã«ã¯SQLã§ç›´æ¥æ“ä½œãŒå¿…è¦

**ç›®æ¨™**:
- **ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§è¡¨ç¤º**: ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä¸€è¦§ã‚’è¡¨ç¤º
- **ãƒ‰ãƒ¡ã‚¤ãƒ³è¿½åŠ **: æ–°ã—ã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ 
- **ãƒ‰ãƒ¡ã‚¤ãƒ³ç·¨é›†**: æ—¢å­˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®èª¬æ˜ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡ã‚’ç·¨é›†
- **ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤**: ä¸è¦ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã„å ´åˆã®ã¿ï¼‰
- **ãƒ‰ãƒ¡ã‚¤ãƒ³æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–**: ãƒ‰ãƒ¡ã‚¤ãƒ³ã®åˆ©ç”¨å¯å¦ã‚’åˆ‡ã‚Šæ›¿ãˆ

### æ©Ÿèƒ½è©³ç´°

#### 1. ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§è¡¨ç¤º

**è¡¨ç¤ºå†…å®¹**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³å
- èª¬æ˜
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
- æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹
- ä½œæˆæ—¥
- æ“ä½œãƒœã‚¿ãƒ³ï¼ˆç·¨é›†ãƒ»å‰Šé™¤ãƒ»æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ï¼‰

**UIä¾‹**:
```
ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§

+-------------+------------------+----------+----------+------+------------+----------+
| ãƒ‰ãƒ¡ã‚¤ãƒ³å   | èª¬æ˜              | å®¹é‡     | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | çŠ¶æ…‹  | ä½œæˆæ—¥      | æ“ä½œ     |
+-------------+------------------+----------+----------+------+------------+----------+
| kuma8088.com| ãƒ¡ã‚¤ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³    | 1024 MB  | 5        | æœ‰åŠ¹  | 2025-11-01 | ç·¨é›† å‰Šé™¤|
| example.com | ãƒ†ã‚¹ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³    | 512 MB   | 0        | ç„¡åŠ¹  | 2025-11-05 | ç·¨é›† å‰Šé™¤|
+-------------+------------------+----------+----------+------+------------+----------+

[+ æ–°è¦ãƒ‰ãƒ¡ã‚¤ãƒ³è¿½åŠ ]
```

#### 2. ãƒ‰ãƒ¡ã‚¤ãƒ³è¿½åŠ 

**å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆå¿…é ˆã€ä¸€æ„åˆ¶ç´„ï¼‰
- èª¬æ˜ï¼ˆä»»æ„ï¼‰
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡ï¼ˆMBã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1024ï¼‰
- æœ‰åŠ¹/ç„¡åŠ¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æœ‰åŠ¹ï¼‰

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³åå½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: `example.com`ï¼‰
- é‡è¤‡ãƒã‚§ãƒƒã‚¯
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ1ï½10240MBï¼‰

#### 3. ãƒ‰ãƒ¡ã‚¤ãƒ³ç·¨é›†

**ç·¨é›†å¯èƒ½é …ç›®**:
- èª¬æ˜
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡
- æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹

**ç·¨é›†ä¸å¯é …ç›®**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆä½œæˆå¾Œå¤‰æ›´ä¸å¯ï¼‰

#### 4. ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤

**å‰Šé™¤æ¡ä»¶**:
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç´ã¥ã„ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ0ã®å ´åˆã®ã¿å‰Šé™¤å¯èƒ½

**å‰Šé™¤æ™‚ã®ç¢ºèª**:
```
æœ¬å½“ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ "example.com" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ
ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚

[ã‚­ãƒ£ãƒ³ã‚»ãƒ«] [å‰Šé™¤]
```

#### 5. ãƒ‰ãƒ¡ã‚¤ãƒ³æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–

**ç„¡åŠ¹åŒ–ã®å½±éŸ¿**:
- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ™‚ã«ãƒ‰ãƒ¡ã‚¤ãƒ³é¸æŠãƒªã‚¹ãƒˆã«è¡¨ç¤ºã•ã‚Œãªã„
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å½±éŸ¿ãªã—
- ç®¡ç†è€…ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§ã§ç¢ºèªå¯èƒ½

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

#### 1. `domains` ãƒ†ãƒ¼ãƒ–ãƒ«å¤‰æ›´

**æ–°è¦ã‚«ãƒ©ãƒ è¿½åŠ **:
```sql
ALTER TABLE domains ADD COLUMN enabled BOOLEAN DEFAULT TRUE NOT NULL;
CREATE INDEX idx_domains_enabled ON domains (enabled);
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **:
```
domains
â”œâ”€â”€ id (INT, PRIMARY KEY, AUTO_INCREMENT)
â”œâ”€â”€ name (VARCHAR(255), UNIQUE, NOT NULL, INDEX)
â”œâ”€â”€ description (VARCHAR(500), NULLABLE)
â”œâ”€â”€ default_quota (INT, DEFAULT 1024, NOT NULL)
â”œâ”€â”€ enabled (BOOLEAN, DEFAULT TRUE, NOT NULL)  â† æ–°è¦
â”œâ”€â”€ created_at (TIMESTAMP)
â””â”€â”€ updated_at (TIMESTAMP)

INDEX: idx_domains_enabled (æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ã‚£ãƒ«ã‚¿ç”¨)
```

#### 2. åˆ¶ç´„

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯ï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ï¼‰
ALTER TABLE users ADD CONSTRAINT fk_users_domain
    FOREIGN KEY (domain_id) REFERENCES domains(id)
    ON DELETE RESTRICT;
```

### å®Ÿè£…è¨­è¨ˆ

#### 1. ãƒ¢ãƒ‡ãƒ«å¤‰æ›´

**`app/models/domain.py`**:
```python
class Domain(db.Model):
    __tablename__ = 'domains'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255), unique=True, nullable=False, index=True)
    description = db.Column(db.String(500), nullable=True)
    default_quota = db.Column(db.Integer, default=1024, nullable=False)
    enabled = db.Column(db.Boolean, default=True, nullable=False)  # æ–°è¦
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    users = db.relationship('User', backref='domain', lazy='dynamic')

    def user_count(self):
        """ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’è¿”ã™"""
        return self.users.count()

    def __repr__(self):
        return f'<Domain {self.name}>'
```

#### 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹

**`app/services/domain_service.py` (æ–°è¦)**:
```python
"""
Domain Service - Business logic for domain management operations
"""
import json
from app.database import db
from app.models import Domain, AuditLog
from sqlalchemy.exc import IntegrityError
from typing import List, Optional

class DomainService:
    """ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""

    @staticmethod
    def list_domains(enabled_only: bool = False) -> List[Domain]:
        """
        ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§å–å¾—

        Args:
            enabled_only: æœ‰åŠ¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã¿å–å¾—

        Returns:
            Domainã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆ
        """
        query = Domain.query
        if enabled_only:
            query = query.filter_by(enabled=True)
        return query.order_by(Domain.name).all()

    @staticmethod
    def create_domain(
        name: str,
        description: str = '',
        default_quota: int = 1024,
        enabled: bool = True,
        admin_ip: str = 'system'
    ) -> Domain:
        """
        ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ

        Args:
            name: ãƒ‰ãƒ¡ã‚¤ãƒ³å
            description: èª¬æ˜
            default_quota: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®¹é‡ï¼ˆMBï¼‰
            enabled: æœ‰åŠ¹/ç„¡åŠ¹
            admin_ip: ç®¡ç†è€…IPï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ï¼‰

        Returns:
            ä½œæˆã•ã‚ŒãŸDomainã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

        Raises:
            ValueError: ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆ
        """
        # é‡è¤‡ãƒã‚§ãƒƒã‚¯
        existing = Domain.query.filter_by(name=name).first()
        if existing:
            raise ValueError("ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™")

        domain = Domain(
            name=name,
            description=description,
            default_quota=default_quota,
            enabled=enabled
        )

        try:
            db.session.add(domain)
            db.session.commit()

            # ç›£æŸ»ãƒ­ã‚°
            DomainService.log_audit(
                action='create',
                domain_name=name,
                admin_ip=admin_ip,
                details=json.dumps({
                    "message": "Domain created",
                    "default_quota_mb": default_quota,
                    "enabled": enabled
                })
            )

            return domain

        except IntegrityError as e:
            db.session.rollback()
            raise ValueError(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: {str(e)}")

    @staticmethod
    def update_domain(
        domain_id: int,
        admin_ip: str = 'system',
        **kwargs
    ) -> Domain:
        """
        ãƒ‰ãƒ¡ã‚¤ãƒ³æ›´æ–°

        Args:
            domain_id: ãƒ‰ãƒ¡ã‚¤ãƒ³ID
            admin_ip: ç®¡ç†è€…IPï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ï¼‰
            **kwargs: æ›´æ–°ã™ã‚‹å±æ€§

        Returns:
            æ›´æ–°ã•ã‚ŒãŸDomainã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

        Raises:
            ValueError: ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ãƒ‰ãƒ¡ã‚¤ãƒ³åå¤‰æ›´ã‚’è©¦ã¿ãŸå ´åˆ
        """
        # ãƒ‰ãƒ¡ã‚¤ãƒ³åå¤‰æ›´ã¯ç¦æ­¢
        if 'name' in kwargs:
            raise ValueError("ãƒ‰ãƒ¡ã‚¤ãƒ³åã¯å¤‰æ›´ã§ãã¾ã›ã‚“")

        domain = Domain.query.get(domain_id)
        if not domain:
            raise ValueError("ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

        # å¤‰æ›´è¿½è·¡
        changes = []
        allowed_attrs = ['description', 'default_quota', 'enabled']

        for attr, value in kwargs.items():
            if attr in allowed_attrs and hasattr(domain, attr):
                old_value = getattr(domain, attr)
                if old_value != value:
                    setattr(domain, attr, value)
                    changes.append(f"{attr}: {old_value} â†’ {value}")

        if changes:
            try:
                db.session.commit()

                # ç›£æŸ»ãƒ­ã‚°
                DomainService.log_audit(
                    action='update',
                    domain_name=domain.name,
                    admin_ip=admin_ip,
                    details=json.dumps({
                        "message": "Domain updated",
                        "changes": changes
                    })
                )

            except IntegrityError as e:
                db.session.rollback()
                raise ValueError(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: {str(e)}")

        return domain

    @staticmethod
    def delete_domain(domain_id: int, admin_ip: str = 'system') -> None:
        """
        ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤

        Args:
            domain_id: ãƒ‰ãƒ¡ã‚¤ãƒ³ID
            admin_ip: ç®¡ç†è€…IPï¼ˆç›£æŸ»ãƒ­ã‚°ç”¨ï¼‰

        Raises:
            ValueError: ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        """
        domain = Domain.query.get(domain_id)
        if not domain:
            raise ValueError("ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤ä¸å¯
        if domain.user_count() > 0:
            raise ValueError(
                f"ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¯ {domain.user_count()} äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã™ã€‚"
                "å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
            )

        domain_name = domain.name

        try:
            db.session.delete(domain)
            db.session.commit()

            # ç›£æŸ»ãƒ­ã‚°
            DomainService.log_audit(
                action='delete',
                domain_name=domain_name,
                admin_ip=admin_ip,
                details=json.dumps({"message": "Domain deleted"})
            )

        except IntegrityError as e:
            db.session.rollback()
            raise ValueError(f"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: {str(e)}")

    @staticmethod
    def log_audit(
        action: str,
        domain_name: str,
        admin_ip: str,
        details: str = ''
    ) -> AuditLog:
        """
        ç›£æŸ»ãƒ­ã‚°ä½œæˆ

        Args:
            action: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (create, update, delete)
            domain_name: ãƒ‰ãƒ¡ã‚¤ãƒ³å
            admin_ip: ç®¡ç†è€…IP
            details: è©³ç´°ï¼ˆJSONå½¢å¼ï¼‰

        Returns:
            ä½œæˆã•ã‚ŒãŸAuditLogã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        """
        audit_log = AuditLog(
            action=action,
            user_email=f'domain:{domain_name}',  # ãƒ‰ãƒ¡ã‚¤ãƒ³æ“ä½œã‚’è­˜åˆ¥
            admin_ip=admin_ip,
            details=details
        )

        db.session.add(audit_log)
        db.session.commit()

        return audit_log
```

#### 3. ãƒ«ãƒ¼ãƒˆå®Ÿè£…

**`app/routes/domains.py` (æ–°è¦)**:
```python
"""
Domain management routes
"""
from flask import Blueprint, render_template, request, redirect, url_for, flash
from flask_login import login_required
from app.decorators import admin_required
from app.services.domain_service import DomainService

bp = Blueprint('domains', __name__, url_prefix='/domains')

@bp.route('/')
@login_required
@admin_required
def list():
    """ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§"""
    domains = DomainService.list_domains()
    return render_template('domains/list.html', domains=domains)

@bp.route('/new', methods=['GET', 'POST'])
@login_required
@admin_required
def create():
    """ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ"""
    if request.method == 'GET':
        return render_template('domains/create.html')

    try:
        name = request.form.get('name', '').strip()
        description = request.form.get('description', '').strip()
        default_quota = request.form.get('default_quota', 1024, type=int)
        enabled = request.form.get('enabled', 'true') == 'true'

        domain = DomainService.create_domain(
            name=name,
            description=description,
            default_quota=default_quota,
            enabled=enabled,
            admin_ip=request.remote_addr
        )

        flash(f'ãƒ‰ãƒ¡ã‚¤ãƒ³ {domain.name} ã‚’ä½œæˆã—ã¾ã—ãŸã€‚', 'success')
        return redirect(url_for('domains.list'))

    except ValueError as e:
        flash(f'ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}', 'danger')
        return redirect(url_for('domains.create'))

@bp.route('/<int:domain_id>/edit', methods=['GET', 'POST'])
@login_required
@admin_required
def edit(domain_id):
    """ãƒ‰ãƒ¡ã‚¤ãƒ³ç·¨é›†"""
    domain = DomainService.list_domains()
    domain = next((d for d in domain if d.id == domain_id), None)

    if not domain:
        flash('ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'danger')
        return redirect(url_for('domains.list'))

    if request.method == 'GET':
        return render_template('domains/edit.html', domain=domain)

    try:
        description = request.form.get('description', '').strip()
        default_quota = request.form.get('default_quota', type=int)
        enabled = request.form.get('enabled', 'true') == 'true'

        DomainService.update_domain(
            domain_id=domain_id,
            description=description,
            default_quota=default_quota,
            enabled=enabled,
            admin_ip=request.remote_addr
        )

        flash(f'ãƒ‰ãƒ¡ã‚¤ãƒ³ {domain.name} ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'success')
        return redirect(url_for('domains.list'))

    except ValueError as e:
        flash(f'ãƒ‰ãƒ¡ã‚¤ãƒ³æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}', 'danger')
        return redirect(url_for('domains.edit', domain_id=domain_id))

@bp.route('/<int:domain_id>/delete', methods=['POST'])
@login_required
@admin_required
def delete(domain_id):
    """ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤"""
    try:
        DomainService.delete_domain(
            domain_id=domain_id,
            admin_ip=request.remote_addr
        )
        flash('ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success')
    except ValueError as e:
        flash(f'ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}', 'danger')

    return redirect(url_for('domains.list'))
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †

#### Phase 11-B-1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (0.5æ™‚é–“)

1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLä½œæˆ
2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
4. æ¤œè¨¼

#### Phase 11-B-2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£… (1.5æ™‚é–“)

1. ãƒ¢ãƒ‡ãƒ«æ›´æ–°
2. DomainServiceå®Ÿè£…
3. ãƒ«ãƒ¼ãƒˆå®Ÿè£…

#### Phase 11-B-3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£… (1æ™‚é–“)

1. ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§ç”»é¢
2. ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆç”»é¢
3. ãƒ‰ãƒ¡ã‚¤ãƒ³ç·¨é›†ç”»é¢
4. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 

#### Phase 11-B-4: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ (0.5æ™‚é–“)

1. ãƒ‰ãƒ¡ã‚¤ãƒ³CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
2. å‰Šé™¤åˆ¶ç´„ãƒ†ã‚¹ãƒˆ
3. ç›£æŸ»ãƒ­ã‚°ç¢ºèª

**åˆè¨ˆè¦‹ç©ã‚‚ã‚Š**: 3.5æ™‚é–“

---

## ğŸ“Š Phase 11 å…¨ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| ãƒ•ã‚§ãƒ¼ã‚º | æ©Ÿèƒ½ | è¦‹ç©ã‚‚ã‚Š | ä¾å­˜é–¢ä¿‚ |
|---------|------|---------|---------|
| Phase 11-A | ç®¡ç†è€…ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™åˆ†é›¢ | 2æ™‚é–“ | ãªã— |
| Phase 11-B | ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½ | 3.5æ™‚é–“ | Phase 11-A å®Œäº†å¾Œ |
| **åˆè¨ˆ** | | **5.5æ™‚é–“** | |

---

## ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆè¨ˆç”»

### Phase 11-A ãƒ†ã‚¹ãƒˆ

**ç®¡ç†è€…æ©Ÿèƒ½**:
- âœ… ç®¡ç†è€…ã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
- âœ… å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

**é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½**:
- âŒ é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ â†’ æ‹’å¦
- âœ… IMAPãƒ­ã‚°ã‚¤ãƒ³ã¯æˆåŠŸ

**åˆ¶ç´„ãƒ†ã‚¹ãƒˆ**:
- âŒ 2äººç›®ã®ç®¡ç†è€…ä½œæˆè©¦è¡Œ â†’ ã‚¨ãƒ©ãƒ¼
- âœ… ç®¡ç†è€…ãƒ•ãƒ©ã‚°ã®åˆ‡ã‚Šæ›¿ãˆ

### Phase 11-B ãƒ†ã‚¹ãƒˆ

**ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆ**:
- âœ… æ–°è¦ãƒ‰ãƒ¡ã‚¤ãƒ³ä½œæˆæˆåŠŸ
- âŒ é‡è¤‡ãƒ‰ãƒ¡ã‚¤ãƒ³å â†’ ã‚¨ãƒ©ãƒ¼
- âœ… ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

**ãƒ‰ãƒ¡ã‚¤ãƒ³ç·¨é›†**:
- âœ… èª¬æ˜ãƒ»å®¹é‡ãƒ»çŠ¶æ…‹å¤‰æ›´æˆåŠŸ
- âŒ ãƒ‰ãƒ¡ã‚¤ãƒ³åå¤‰æ›´è©¦è¡Œ â†’ ã‚¨ãƒ©ãƒ¼

**ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤**:
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼0ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤æˆåŠŸ
- âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤è©¦è¡Œ â†’ ã‚¨ãƒ©ãƒ¼

---

## ğŸ“ å®Ÿè£…å„ªå…ˆé †ä½

### æ¨å¥¨å®Ÿè£…é †åº

1. **Phase 11-A: ç®¡ç†è€…ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™åˆ†é›¢** (å…ˆè¡Œå®Ÿè£…)
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãŒæœ€å„ªå…ˆ
   - ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½ã®å‰ææ¡ä»¶

2. **Phase 11-B: ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†æ©Ÿèƒ½** (Phase 11-A å®Œäº†å¾Œ)
   - ç®¡ç†è€…æ¨©é™ãŒå¿…è¦
   - Phase 11-A ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼æ´»ç”¨

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

Phase 11 å®Ÿè£…ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

### Phase 11-A ç¢ºèªäº‹é …

1. âœ… é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯ã§ã‚ˆã„ã‹ï¼Ÿ
2. âœ… ç®¡ç†è€…å¤‰æ›´ã¯å¿…è¦ã‹ï¼Ÿï¼ˆç®¡ç†ç”»é¢ã§å¤‰æ›´ vs SQLæ‰‹å‹•å¤‰æ›´ï¼‰
3. âœ… ç›£æŸ»ãƒ­ã‚°ã«æ¨©é™å¤‰æ›´ã‚’è¨˜éŒ²ã™ã‚‹ã‹ï¼Ÿ

### Phase 11-B ç¢ºèªäº‹é …

1. âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³å‰Šé™¤æ¡ä»¶ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼0ã®å ´åˆã®ã¿ã€ã§ã‚ˆã„ã‹ï¼Ÿ
2. âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ç„¡åŠ¹åŒ–æ™‚ã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ã¯ã€Œãªã—ã€ã§ã‚ˆã„ã‹ï¼Ÿ
3. âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³åã¯ä½œæˆå¾Œå¤‰æ›´ä¸å¯ã§ã‚ˆã„ã‹ï¼Ÿ

---

**æº–å‚™å®Œäº†å¾Œã€Phase 11-A ã‹ã‚‰å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã€‚**
