# ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (Mail User Management)

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.5.0-dev (MVPé–‹ç™ºä¸­)
**æ›´æ–°æ—¥**: 2025-11-05
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš§ é–‹ç™ºä¸­ - Phase 1 å®Œäº† (MVPæº–å‚™å®Œäº†)

---

## ğŸ“‹ æ¦‚è¦

ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ Web ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰ç®¡ç†ã™ã‚‹ãŸã‚ã® Flask ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†ç”»é¢ã§ã™ã€‚

### é–‹ç™ºæ–¹é‡ï¼šMVP â†’ Extended

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯**æ®µéšçš„ãƒªãƒªãƒ¼ã‚¹**æˆ¦ç•¥ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ï¼š

#### ğŸ¯ MVPï¼ˆæœ€å°å®Ÿç”¨è£½å“ï¼‰v0.5.0 - ç¾åœ¨é–‹ç™ºä¸­
- **ç›®æ¨™**: åŸºæœ¬çš„ãªWeb UIçµŒç”±ã§ã®ãƒ¦ãƒ¼ã‚¶ç®¡ç†æ©Ÿèƒ½
- **ã‚¹ã‚³ãƒ¼ãƒ—**: MariaDB + Flask + Bootstrap 5ã«ã‚ˆã‚‹ç®¡ç†ç”»é¢
- **ä¸»è¦æ©Ÿèƒ½**:
  - âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ãƒ¦ãƒ¼ã‚¶ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ (CRUDæ“ä½œ)
  - ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒ»å¤‰æ›´ (Dovecotäº’æ›SHA512-CRYPT)
  - ğŸ’¾ ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹å®¹é‡(quota)è¨­å®š
  - ğŸ“Š ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ä¸€è¦§ï¼‰
  - ğŸ”’ Flask-Login ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼
  - ğŸ“ åŸºæœ¬çš„ãªç›£æŸ»ãƒ­ã‚°ï¼ˆä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

#### ğŸš€ Extendedï¼ˆæ‹¡å¼µæ§‹æˆï¼‰v1.0.0+ - MVPå®Œäº†å¾Œ
- **è¿½åŠ æ©Ÿèƒ½**:
  - ğŸ¢ ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ç®¡ç†ãƒ»ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°è¡¨ç¤º
  - ğŸ”„ Dovecot SQLèªè¨¼çµ±åˆï¼ˆMariaDBã‹ã‚‰ç›´æ¥IMAPèªè¨¼ï¼‰
  - ğŸŒ Nginx `/admin` ãƒ‘ã‚¹çµ±åˆ
  - ğŸ”’ Tailscale VPN ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆgeo ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
  - âœ… åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
  - ğŸ—ï¸ docker-compose.yml çµ±åˆ
  - ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è‡ªå‹•åŒ–

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**:
- **Backend**: Flask 3.0, SQLAlchemy 2.0, Python 3.11+
- **Database**: MariaDB 10.11 (æ—¢å­˜ã® `mailserver-mariadb` ã‚³ãƒ³ãƒ†ãƒŠåˆ©ç”¨)
- **Frontend**: Bootstrap 5.3, Jinja2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **Security**: Flask-Login, Flask-WTF (CSRFä¿è­·)
- **Deployment**: Docker + Gunicorn

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### MVP ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆv0.5.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ / Tailscale VPN            â”‚
â”‚                                                          â”‚
â”‚  ç®¡ç†è€…ãƒ‡ãƒã‚¤ã‚¹ (PC/Mac/iPhone/Android)                  â”‚
â”‚         â”‚ HTTP (é–‹ç™ºä¸­) / HTTPS (Extended)                â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  usermgmt       â”‚ Flask + Gunicorn                    â”‚
â”‚  â”‚  172.20.0.90    â”‚ Port 5000                           â”‚
â”‚  â”‚                 â”‚ (ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ - MVP)                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  MariaDB        â”‚ mailserver_usermgmt ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹    â”‚
â”‚  â”‚  172.20.0.60    â”‚ users, audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Extended ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆv1.0.0+ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Tailscale VPN ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ (100.x.x.x/10)      â”‚
â”‚                                                          â”‚
â”‚  ç®¡ç†è€…ãƒ‡ãƒã‚¤ã‚¹ (PC/Mac/iPhone/Android)                  â”‚
â”‚         â”‚ HTTPS (443)                                    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  Nginx Reverse  â”‚ /admin ãƒ‘ã‚¹ (Extended)              â”‚
â”‚  â”‚  Proxy          â”‚ â†’ usermgmt ã‚³ãƒ³ãƒ†ãƒŠã¸ãƒ—ãƒ­ã‚­ã‚·        â”‚
â”‚  â”‚  + Tailscale    â”‚   Tailscale IP ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚  usermgmt       â”‚ Flask + Gunicorn                    â”‚
â”‚  â”‚  172.20.0.90    â”‚ Port 5000                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  MariaDB        â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Dovecot     â”‚         â”‚
â”‚  â”‚  172.20.0.60    â”‚  SQLèªè¨¼  â”‚  (Extended)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆExtendedï¼‰**:
1. Dovecot Fileèªè¨¼ (`/etc/dovecot/users`) - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ã¨ã®äº’æ›æ€§ç¶­æŒ
2. Dovecot SQLèªè¨¼ (MariaDB) - æ–°è¦ãƒ¦ãƒ¼ã‚¶ç®¡ç†æ–¹å¼
3. ä¸¡æ–¹ã®èªè¨¼æ–¹å¼ãŒä¸¦è¡Œç¨¼åƒï¼ˆæ®µéšçš„ç§»è¡Œï¼‰

---

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆMVPï¼‰

### å‰ææ¡ä»¶

- âœ… Docker ãŠã‚ˆã³ Docker Compose ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- âœ… MariaDB ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒä¸­ (`mailserver-mariadb`)
- âœ… DBåˆ‡ã‚Šæ›¿ãˆå®Œäº†ï¼ˆãƒ¡ãƒ¼ãƒ«é€å—ä¿¡ç¢ºèªæ¸ˆã¿ï¼‰
- â³ Python 3.11+ (ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®å ´åˆ)

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ï¼ˆMVPé–‹ç™ºç‰ˆï¼‰

#### 1. ç’°å¢ƒå¤‰æ•°è¨­å®š

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ :

```bash
# User Management Application (MVP)
DB_HOST=172.20.0.60
DB_PORT=3306
DB_NAME=mailserver_usermgmt
DB_USER=usermgmt
DB_PASSWORD=<secure-password>
SECRET_KEY=<random-secret-key>

# Admin credentials (MVP - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”¨)
ADMIN_EMAIL=admin@kuma8088.com
ADMIN_PASSWORD=<admin-password>
```

**SECRET_KEYç”Ÿæˆ**:
```bash
openssl rand -hex 32
```

#### 2. MariaDB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–

```bash
# MariaDB ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶š
docker exec -it mailserver-mariadb mysql -u root -p

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ¦ãƒ¼ã‚¶ä½œæˆ
CREATE DATABASE IF NOT EXISTS mailserver_usermgmt CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'usermgmt'@'%' IDENTIFIED BY '<DB_PASSWORD>';
GRANT ALL PRIVILEGES ON mailserver_usermgmt.* TO 'usermgmt'@'%';
FLUSH PRIVILEGES;
```

#### 3. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆMVPé–‹ç™ºä¸­ï¼‰

```bash
cd /opt/onprem-infra-system/project-root-infra/services/mailserver/usermgmt

# Python ä»®æƒ³ç’°å¢ƒä½œæˆ
python3 -m venv venv
source venv/bin/activate

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
export FLASK_ENV=development
export FLASK_APP=app.py
python app.py
```

#### 4. ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆMVPé–‹ç™ºç‰ˆï¼‰

ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹:

```
http://172.20.0.90:5000/
http://localhost:5000/  # ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®å ´åˆ
```

**æ³¨**: MVP ã§ã¯ Nginx çµ±åˆå‰ã®ãŸã‚ã€ç›´æ¥ Flask ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚Extended ãƒ•ã‚§ãƒ¼ã‚ºã§ Nginx `/admin` ãƒ‘ã‚¹çµ±åˆã‚’å®Ÿæ–½äºˆå®šã€‚

---

## ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

### MVP ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆPhase 0-5ï¼‰ã§å®Ÿè£…ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

```
services/mailserver/usermgmt/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py          # Flask ã‚¢ãƒ—ãƒªåˆæœŸåŒ– (Phase 2)
â”‚   â”œâ”€â”€ models/              # SQLAlchemy ãƒ¢ãƒ‡ãƒ« (Phase 2)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # User ãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â””â”€â”€ audit_log.py     # AuditLog ãƒ¢ãƒ‡ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰
â”‚   â”œâ”€â”€ routes/              # Flask ãƒ«ãƒ¼ãƒˆ (Phase 3-4)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py          # èªè¨¼ãƒ«ãƒ¼ãƒˆ (login/logout)
â”‚   â”‚   â””â”€â”€ users.py         # ãƒ¦ãƒ¼ã‚¶ç®¡ç†ãƒ«ãƒ¼ãƒˆ
â”‚   â””â”€â”€ services/            # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ (Phase 2-4)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ database.py      # DBæ¥ç¶šç®¡ç†
â”‚       â”œâ”€â”€ user_service.py  # ãƒ¦ãƒ¼ã‚¶æ“ä½œã‚µãƒ¼ãƒ“ã‚¹
â”‚       â””â”€â”€ password.py      # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
â”œâ”€â”€ templates/               # Jinja2 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (Phase 5)
â”‚   â”œâ”€â”€ base.html            # ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ login.html           # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”‚   â”œâ”€â”€ dashboard.html       # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â””â”€â”€ users/
â”‚       â”œâ”€â”€ list.html        # ãƒ¦ãƒ¼ã‚¶ä¸€è¦§
â”‚       â”œâ”€â”€ create.html      # ãƒ¦ãƒ¼ã‚¶ä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
â”‚       â””â”€â”€ edit.html        # ãƒ¦ãƒ¼ã‚¶ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
â”œâ”€â”€ static/                  # CSS/JS (Phase 5)
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ custom.css       # ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœ€å°é™ï¼‰
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ validation.js    # ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ scripts/                 # é‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (Phase 2)
â”‚   â””â”€â”€ init_db.py           # DBåˆæœŸåŒ–
â”œâ”€â”€ app.py                   # âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ (Phase 0)
â”œâ”€â”€ requirements.txt         # âœ… Python ä¾å­˜é–¢ä¿‚ (Phase 0)
â”œâ”€â”€ Dockerfile               # âœ… Docker ã‚¤ãƒ¡ãƒ¼ã‚¸å®šç¾© (Phase 0)
â””â”€â”€ .env.example             # ç’°å¢ƒå¤‰æ•°ã‚µãƒ³ãƒ—ãƒ« (Phase 2)
```

### Extended ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆPhase 6-10ï¼‰ã§è¿½åŠ ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

```
services/mailserver/usermgmt/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ domain.py        # Domain ãƒ¢ãƒ‡ãƒ« (Phase 6)
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ domains.py       # ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ãƒ«ãƒ¼ãƒˆ (Phase 6)
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ domains/
â”‚       â””â”€â”€ list.html        # ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§ (Phase 6)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ migrate_users.py     # æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ç§»è¡Œ (Phase 6)
â”œâ”€â”€ tests/                   # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ (Phase 8)
â”‚   â”œâ”€â”€ test_models.py
â”‚   â”œâ”€â”€ test_routes.py
â”‚   â””â”€â”€ test_services.py
â””â”€â”€ config/
    â””â”€â”€ nginx_integration.conf  # Nginx è¨­å®š (Phase 7)
```

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆPhase 1 å®Œäº†ï¼‰

```
docs/application/mailserver/usermgmt/
â”œâ”€â”€ README.md                # âœ… æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ DEVELOPMENT.md           # âœ… é–‹ç™ºé€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚° (MVP/Extendedåˆ†é›¢)
â”œâ”€â”€ API.md                   # âœ… API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜
â””â”€â”€ CHANGELOG.md             # âœ… å¤‰æ›´å±¥æ­´
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### MVP ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆv0.5.0ï¼‰

- **èªè¨¼**: Flask-Login ã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **CSRF ä¿è­·**: Flask-WTF ã«ã‚ˆã‚‹ CSRF ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥**: SHA512-CRYPT (Dovecot äº’æ›)
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookie**: HttpOnly, Secureï¼ˆHTTPSæ™‚ï¼‰
- **ç›£æŸ»ãƒ­ã‚°**: åŸºæœ¬çš„ãªä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²

### Extended ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆv1.0.0+ï¼‰

ä¸Šè¨˜ã«åŠ ãˆã¦ï¼š
- **Tailscale VPN å¿…é ˆ**: `100.0.0.0/10` ç¯„å›²ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ï¼ˆNginx geoï¼‰
- **HTTPS å¼·åˆ¶**: HTTP ã‚¢ã‚¯ã‚»ã‚¹ã¯è‡ªå‹•çš„ã« HTTPS ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **Nginx ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·**: `/admin` ãƒ‘ã‚¹çµŒç”±ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- **åŒ…æ‹¬çš„ãªç›£æŸ»ãƒ­ã‚°**: IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€User-Agentã€æ“ä½œè©³ç´°ã‚’è¨˜éŒ²

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆå…±é€šï¼‰

- **ãƒãƒƒã‚·ãƒ¥æ–¹å¼**: SHA512-CRYPT (Dovecot äº’æ›)
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼** (MVP ã§ã¯æ¨å¥¨ã€Extended ã§å¼·åˆ¶):
  - æœ€å°é•·: 8æ–‡å­—
  - è¤‡é›‘æ€§: è‹±å¤§æ–‡å­—ã€è‹±å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã®ã†ã¡3ç¨®é¡ä»¥ä¸Š
- **å¹³æ–‡ä¿å­˜ç¦æ­¢**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯å¿…ãšãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿ä¿å­˜

---

## ğŸ› ï¸ é–‹ç™º

### é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
cd /opt/onprem-infra-system/project-root-infra/services/mailserver/usermgmt

# Python ä»®æƒ³ç’°å¢ƒä½œæˆ
python3 -m venv venv
source venv/bin/activate

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
export FLASK_ENV=development
export FLASK_APP=app.py
python app.py
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆExtended ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

```bash
# ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
pytest tests/

# ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
pytest --cov=app tests/

# çµ±åˆãƒ†ã‚¹ãƒˆ
pytest tests/integration/
```

### é–‹ç™ºé€²æ—ã®ç¢ºèª

é–‹ç™ºã®é€²æ—çŠ¶æ³ã¯ `DEVELOPMENT.md` ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

**ç¾åœ¨ã®é€²æ—**:
- âœ… Phase 0: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–å®Œäº†
- âœ… Phase 1: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™å®Œäº†ï¼ˆMVP/Extendedåˆ†é›¢ï¼‰
- â³ Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç›¤æ§‹ç¯‰ï¼ˆæœªç€æ‰‹ï¼‰
- â³ Phase 3-5: MVPå®Ÿè£…ï¼ˆæœªç€æ‰‹ï¼‰
- â³ Phase 6-10: Extendedæ‹¡å¼µï¼ˆMVPå®Œäº†å¾Œï¼‰

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **è¨­è¨ˆæ›¸**: `../05_user_management_design.md`
- **APIä»•æ§˜**: `API.md`
- **é–‹ç™ºé€²æ—**: `DEVELOPMENT.md` â† **MVP/Extended ãƒ•ã‚§ãƒ¼ã‚ºåˆ†é›¢æ¸ˆã¿**
- **å¤‰æ›´å±¥æ­´**: `CHANGELOG.md`
- **Mailserver å…¨ä½“è¨­è¨ˆ**: `../README.md`

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ãªã„ï¼ˆExtended ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

```bash
# ãƒ­ã‚°ç¢ºèª
docker logs mailserver-usermgmt

# MariaDB æ¥ç¶šãƒ†ã‚¹ãƒˆ
docker exec mailserver-usermgmt python3 -c "
from app.services.database import db_engine
print('DB connection OK' if db_engine else 'DB connection failed')
"
```

### ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„

- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã® `ADMIN_EMAIL` ã¨ `ADMIN_PASSWORD` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã¯ `{SHA512-CRYPT}` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…è¦ï¼ˆExtended ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

### MariaDB æ¥ç¶šã‚¨ãƒ©ãƒ¼

```bash
# MariaDB ã‚³ãƒ³ãƒ†ãƒŠç¨¼åƒç¢ºèª
docker ps | grep mailserver-mariadb

# DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
docker exec -it mailserver-mariadb mysql -u usermgmt -p -h 172.20.0.60 -e "SELECT 1"
```

### Tailscale VPN çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ï¼ˆExtended ãƒ•ã‚§ãƒ¼ã‚ºï¼‰

- Nginx ã® geo ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ `100.0.0.0/10` ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Tailscale æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª: `tailscale status`

---

## ğŸ¯ MVP å®Œäº†æ¡ä»¶

ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã—ãŸæ™‚ç‚¹ã§ MVP v0.5.0 ã‚’ãƒªãƒªãƒ¼ã‚¹:

- âœ… Webãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- âœ… ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ã®æ–°è¦ä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒå¯èƒ½
- âœ… MariaDBã«å¤‰æ›´ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹
- âœ… åŸºæœ¬çš„ãªUIï¼ˆBootstrap 5ï¼‰ãŒå‹•ä½œã—ã¦ã„ã‚‹ï¼ˆPC/ã‚¹ãƒãƒ›å¯¾å¿œï¼‰
- âœ… ç°¡æ˜“ãªç›£æŸ»ãƒ­ã‚°ï¼ˆä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

---

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å†…éƒ¨åˆ©ç”¨å°‚ç”¨ã§ã™ã€‚

---

## ğŸ‘¥ ãƒ¡ãƒ³ãƒ†ãƒŠ

- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… (system-admin)

---

## ğŸ”— ãƒªãƒ³ã‚¯

- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ**: `/opt/onprem-infra-system/project-root-infra`
- **Mailserver ã‚µãƒ¼ãƒ“ã‚¹**: `services/mailserver/`
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `docs/application/mailserver/`
- **é–‹ç™ºé€²æ—**: `DEVELOPMENT.md` â† **MVP/Extended ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†**
