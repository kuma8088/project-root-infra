# Database Port Configuration Strategy

**ä½œæˆæ—¥**: 2025-11-11
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
**å„ªå…ˆåº¦**: LOW
**ã‚«ãƒ†ã‚´ãƒª**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»è¨­è¨ˆ

---

## ğŸ“‹ ç¾åœ¨ã®æ§‹æˆ

### MariaDB ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦

| ã‚µãƒ¼ãƒ“ã‚¹ | å†…éƒ¨ãƒãƒ¼ãƒˆ | å¤–éƒ¨ãƒãƒ¼ãƒˆ | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | å…¬é–‹ |
|---------|-----------|-----------|-------------|------|
| **Mailserver MariaDB** | 3306 | - | 172.20.0.0/24 (`mailserver_mailserver_network`) | âŒ éå…¬é–‹ |
| **Blog MariaDB** | 3306 | 3307 | 172.22.0.0/24 (`blog_network`) | âš ï¸ ãƒ›ã‚¹ãƒˆã®ã¿ |

### Docker Composeè¨­å®š

**Mailserver** (`services/mailserver/docker-compose.yml`):
```yaml
services:
  mariadb:
    image: mariadb:10.11.7
    container_name: mailserver-mariadb
    networks:
      mailserver_network:
        ipv4_address: 172.20.0.60
    ports:
      # ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ãªã— - å®Œå…¨å†…éƒ¨
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
```

**Blog** (`services/blog/docker-compose.yml`):
```yaml
services:
  mariadb:
    image: mariadb:10.11.7
    container_name: blog-mariadb
    networks:
      blog_network:
        ipv4_address: 172.22.0.50
    ports:
      - "3307:3306"  # ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆç®¡ç†ç”¨ï¼‰
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      # ...
```

---

## âœ… ãªãœå‹•ä½œã™ã‚‹ã®ã‹

### 1. **Docker Network Isolationï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ï¼‰**

- **Mailserver**: `172.20.0.0/24` ã‚µãƒ–ãƒãƒƒãƒˆ
- **Blog**: `172.22.0.0/24` ã‚µãƒ–ãƒãƒƒãƒˆ
- **åˆ†é›¢ãƒ¬ãƒ™ãƒ«**: å®Œå…¨ã«ç‹¬ç«‹ã—ãŸDockerãƒ–ãƒªãƒƒã‚¸ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

### 2. **ãƒãƒ¼ãƒˆç«¶åˆãŒç™ºç”Ÿã—ãªã„ç†ç”±**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dell WorkStation (Rocky Linux 9.6)                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Mailserver Network  â”‚   â”‚ Blog Network        â”‚       â”‚
â”‚  â”‚ 172.20.0.0/24       â”‚   â”‚ 172.22.0.0/24       â”‚       â”‚
â”‚  â”‚                     â”‚   â”‚                     â”‚       â”‚
â”‚  â”‚ MariaDB             â”‚   â”‚ MariaDB             â”‚       â”‚
â”‚  â”‚ 172.20.0.60:3306 â—„â”€â”€â”¼â”€â”€â”€â”¼â”€â–º 172.22.0.50:3306  â”‚       â”‚
â”‚  â”‚                     â”‚   â”‚                     â”‚       â”‚
â”‚  â”‚ (ãƒãƒ¼ãƒˆå…¬é–‹ãªã—)      â”‚   â”‚ (3307â†’3306ãƒãƒƒãƒ”ãƒ³ã‚°)â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚            â–²                           â–²                   â”‚
â”‚            â”‚                           â”‚                   â”‚
â”‚            â”‚                           â””â”€â”€â”€ Host:3307      â”‚
â”‚            â””â”€â”€â”€ å†…éƒ¨ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³**

| ã‚¢ã‚¯ã‚»ã‚¹å…ƒ | Mailserver MariaDB | Blog MariaDB | èª¬æ˜ |
|-----------|-------------------|--------------|------|
| **Mailserver ã‚³ãƒ³ãƒ†ãƒŠ** | âœ… `mariadb:3306` | âŒ ä¸å¯ | åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†… |
| **Blog ã‚³ãƒ³ãƒ†ãƒŠ** | âŒ ä¸å¯ | âœ… `mariadb:3306` | åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†… |
| **ãƒ›ã‚¹ãƒˆ (Rocky Linux)** | âŒ ä¸å¯ | âœ… `localhost:3307` | ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°çµŒç”± |
| **å¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | âŒ ä¸å¯ | âŒ ä¸å¯ | ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§é®æ–­ |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. **Mailserver MariaDB - å®Œå…¨å†…éƒ¨åŒ–**

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆæ”»æ’ƒé¢æœ€å°åŒ–ï¼‰
- âœ… ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼ˆã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆï¼‰
- âœ… ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ã®ã¿

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ ç·Šæ€¥æ™‚ã®DBç›´æ¥æ“ä½œãŒå›°é›£
- âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãŒ `docker exec` çµŒç”±ã®ã¿

**ç·Šæ€¥æ™‚ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•**:
```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã‹ã‚‰ mysql ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè¡Œ
docker compose exec mariadb mysql -u root -p

# ã¾ãŸã¯ä¸€æ™‚çš„ã« phpmyadmin ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker run --rm --network mailserver_mailserver_network \
  -e PMA_HOST=172.20.0.60 \
  -p 8081:80 \
  phpmyadmin/phpmyadmin
```

### 2. **Blog MariaDB - ãƒ›ã‚¹ãƒˆã‚¢ã‚¯ã‚»ã‚¹è¨±å¯**

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ç®¡ç†ä½œæ¥­ãŒå®¹æ˜“ï¼ˆwp-cliã‚„mysqlã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥ï¼‰
- âœ… é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°ãŒåŠ¹ç‡çš„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âš ï¸ ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®æ”»æ’ƒé¢ãŒå­˜åœ¨
- âš ï¸ ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šãƒŸã‚¹ã§å¤–éƒ¨å…¬é–‹ã®ãƒªã‚¹ã‚¯

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–**:
```bash
# ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç¢ºèªï¼ˆ3307ãŒå¤–éƒ¨å…¬é–‹ã•ã‚Œã¦ã„ãªã„ã“ã¨ï¼‰
sudo firewall-cmd --list-all

# Expected: 3307ãŒãƒªã‚¹ãƒˆã«å«ã¾ã‚Œãªã„
```

---

## ğŸ“Š å°†æ¥ã®æ‹¡å¼µã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª 1: ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆï¼ˆ1ã¤ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«çµ±åˆï¼‰

ã‚‚ã—å°†æ¥çš„ã«Mailserverã¨Blogã‚’åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«çµ±åˆã™ã‚‹å ´åˆï¼š

**æ–¹æ³• A: å†…éƒ¨ãƒãƒ¼ãƒˆå¤‰æ›´**
```yaml
# Mailserver
mariadb:
  ports:
    - "3306:3306"  # ã¾ãŸã¯æŒ‡å®šãªã—

# Blog
mariadb:
  ports:
    - "3307:3307"  # å†…éƒ¨ãƒãƒ¼ãƒˆã‚‚3307ã«å¤‰æ›´
  command: --port=3307
```

**æ–¹æ³• B: ã‚³ãƒ³ãƒ†ãƒŠåã§è­˜åˆ¥**
```yaml
# ä¸¡æ–¹ã¨ã‚‚å†…éƒ¨3306ã®ã¾ã¾ã€ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã§åˆ†é›¢
mailserver-mariadb:
  ports:
    - "3306:3306"

blog-mariadb:
  ports:
    - "3307:3306"
```

### ã‚·ãƒŠãƒªã‚ª 2: Multi-AZ / AWSç§»è¡Œæ™‚

**RDSä½¿ç”¨æ™‚**:
- Mailserver RDS: `mailserver-prod.xxxxx.ap-northeast-1.rds.amazonaws.com:3306`
- Blog RDS: `blog-prod.xxxxx.ap-northeast-1.rds.amazonaws.com:3306`
- ãƒãƒ¼ãƒˆçµ±ä¸€ï¼ˆ3306ï¼‰ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è­˜åˆ¥

---

## ğŸ“ æ¨å¥¨äº‹é …

### 1. **ç¾çŠ¶ç¶­æŒï¼ˆæ¨å¥¨ï¼‰**

ç¾åœ¨ã®æ§‹æˆã¯é©åˆ‡ï¼š
- âœ… ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ã«ã‚ˆã‚Šå®‰å…¨
- âœ… ãƒãƒ¼ãƒˆç«¶åˆãªã—
- âœ… å°†æ¥ã®æ‹¡å¼µæ€§ã‚ã‚Š

### 2. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã®å¾¹åº•**

ä»¥ä¸‹ã‚’æ˜ç¢ºã«è¨˜è¼‰ï¼š
- `docs/infra/network-design.md`: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ
- `services/*/README.md`: å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦
- `.env.example`: ãƒãƒ¼ãƒˆè¨­å®šã®ã‚µãƒ³ãƒ—ãƒ«

### 3. **ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ**

```bash
# ãƒãƒ¼ãƒˆä½¿ç”¨çŠ¶æ³ç¢ºèª
sudo ss -tulpn | grep :3306
sudo ss -tulpn | grep :3307

# Dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
docker network ls
docker network inspect mailserver_mailserver_network
docker network inspect blog_network
```

---

## ğŸš¨ æ³¨æ„äº‹é …

### 1. **ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°å¤‰æ›´æ™‚ã®ãƒªã‚¹ã‚¯**

- **ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯**: ãªã—ï¼ˆå†…éƒ¨ãƒãƒ¼ãƒˆã¯å¤‰æ›´ã—ãªã„ï¼‰
- **æ¥ç¶šæ–­çµ¶**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•ãŒå¿…è¦
- **æ¤œè¨¼å¿…é ˆ**: ãƒ†ã‚¹ãƒˆç’°å¢ƒã§äº‹å‰ç¢ºèª

### 2. **æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ æ™‚ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**

æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹: Monitoring, Loggingï¼‰ã‚’è¿½åŠ ã™ã‚‹éš›ï¼š

```yaml
# ä¾‹: Prometheus + Grafana
services:
  prometheus:
    ports:
      - "9090:9090"  # å›ºæœ‰ã®ãƒãƒ¼ãƒˆ

  grafana:
    ports:
      - "3000:3000"  # å›ºæœ‰ã®ãƒãƒ¼ãƒˆ

  # MariaDBã¯ç‹¬è‡ªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§3306ã‚’ä½¿ç”¨å¯èƒ½
  monitoring-mariadb:
    networks:
      monitoring_network:
        ipv4_address: 172.23.0.50
    # ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ãªã— or 3308:3306
```

**ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦æˆ¦ç•¥**:
- 3306: MariaDBå†…éƒ¨ãƒãƒ¼ãƒˆï¼ˆå…¨ã‚µãƒ¼ãƒ“ã‚¹å…±é€šï¼‰
- 330X: ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆX=ã‚µãƒ¼ãƒ“ã‚¹ç•ªå·ï¼‰
  - 3307: Blog
  - 3308: Monitoring (äºˆç´„)
  - 3309: Logging (äºˆç´„)

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Docker Compose Networking](https://docs.docker.com/compose/networking/)
- [Docker Network Drivers](https://docs.docker.com/network/)
- [Mailserver docker-compose.yml](../../services/mailserver/docker-compose.yml)
- [Blog docker-compose.yml](../../services/blog/docker-compose.yml)

---

**Last Updated**: 2025-11-11
**Author**: Claude
**Status**: âœ… Documented - ç¾åœ¨ã®æ§‹æˆã¯é©åˆ‡
